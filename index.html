<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fiyat Takipçisi (AI Analizli)</title>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-functions-compat.js"></script>

    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

    <style>
        :root {
            --bg-primary: #131722; --bg-secondary: #1e222d; --bg-tertiary: #2a2e39;
            --border-color: #424651; --text-primary: #d1d4dc; --text-secondary: #8c92a2;
            --accent-blue: #2962ff; --accent-green: #26a69a; --accent-red: #ef5350; --accent-yellow: #f59e0b;
            --strong-buy: #00bfa5; --buy: #26a69a; --hold: #8c92a2; --sell: #ef5350; --strong-sell: #d50000;
            --value-positive: #26de81; --value-negative: #ff4757;
        }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
        }
        body.modal-open { overflow: hidden; }
        .page { min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 10px; box-sizing: border-box; }
        .login-container { background: var(--bg-secondary); padding: 40px; border-radius: 12px; border: 1px solid var(--border-color); width: 100%; max-width: 400px; text-align: center; margin-top: 10vh; }
        .login-container h1 { color: var(--text-primary); font-size: 2rem; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .login-container h1 .fas { color: var(--accent-yellow); }
        .login-container p { margin-bottom: 30px; color: var(--text-secondary); }
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 0.9rem; color: var(--text-secondary); }
        .login-container input { width: 100%; padding: 12px 15px; border: 1px solid var(--border-color); background-color: var(--bg-tertiary); color: var(--text-primary); border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        .button-group { display: flex; gap: 10px; margin-top: 25px; }
        .login-container button { flex-grow: 1; background-color: var(--accent-blue); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; }
        #error-message { color: var(--accent-red); margin-top: 15px; font-weight: 500; min-height: 20px; }
        .tracker-container { width: 100%; max-width: 1200px; margin: 0 auto; background-color: var(--bg-secondary); border-radius: 12px; padding: 20px; border: 1px solid var(--border-color); }
        .app-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .app-header .header-left h1 { color: var(--text-primary); font-size: 1.8rem; margin: 0; display: flex; align-items: center; gap: 12px; }
        .app-header .header-left h1 .fas { color: var(--accent-yellow); }
        .app-header .header-right { display: flex; align-items: center; gap: 10px; }
        .app-header .main-actions button { background-color: var(--bg-tertiary); color: var(--text-secondary); padding: 8px 16px; font-size: 0.9rem; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; }
        .user-menu { position: relative; }
        #userMenuBtn { background-color: var(--bg-tertiary); color: var(--text-primary); padding: 8px 12px; display: flex; align-items: center; gap: 8px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; }
        .dropdown-content { display: none; position: absolute; right: 0; background-color: var(--bg-secondary); min-width: 200px; box-shadow: 0 8px 16px rgba(0,0,0,0.4); z-index: 100; border-radius: 8px; border: 1px solid var(--border-color); overflow: hidden; }
        .dropdown-content a { color: var(--text-primary); padding: 12px 16px; text-decoration: none; display: flex; align-items: center; gap: 10px; font-size: 0.95rem; }
        .dropdown-content a:hover { background-color: var(--bg-tertiary); }
        .user-menu:hover .dropdown-content { display: block; }
        .add-asset-bar { display: flex; gap: 10px; margin-bottom: 25px; }
        .add-asset-bar input { flex-grow: 1; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; background-color: var(--bg-tertiary); color: var(--text-primary); }
        .add-asset-bar button { padding: 12px 20px; background-color: var(--accent-blue); border-radius: 8px; border: none; color: white; cursor: pointer; }
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        th, td { padding: 14px 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { color: var(--text-secondary); font-weight: 500; position: sticky; top: 0; background-color: var(--bg-secondary); z-index: 1; }
        th.sortable { cursor: pointer; }
        th .sort-indicator { margin-left: 8px; opacity: 0.5; transition: opacity 0.2s; }
        th.asc .sort-indicator, th.desc .sort-indicator { opacity: 1; }
        td { color: var(--text-primary); }
        .asset-cell { font-weight: 600; color: #64b5f6; cursor: pointer; }
        .asset-cell:hover { text-decoration: underline; }
        .asset-cell .symbol { font-size: 0.8em; color: var(--text-secondary); margin-left: 4px; }
        tr:hover td { background-color: var(--bg-tertiary); }
        .positive { color: var(--accent-green); }
        .positive-high { font-weight: 600; }
        .positive-low { font-weight: 600; }
        .negative { color: var(--accent-red); font-weight: 600; }
        .clickable-pct { cursor: pointer; text-decoration: underline; text-decoration-style: dotted; text-decoration-color: var(--text-secondary); }
        .update-time { text-align: center; margin: 20px 0 10px 0; color: var(--text-secondary); font-size: 0.85rem; }
        .drag-handle { cursor: grab; padding: 0 10px; color: #9ca3af; }
        .action-btn { background-color: transparent; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1rem; }
        .action-btn:hover { color: var(--accent-red); }
        .loading { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease; }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .panel { position: fixed; top: 50%; left: 50%; background-color: var(--bg-secondary); padding: 0; border-radius: 12px; border: 1px solid var(--border-color); z-index: 1001; width: clamp(300px, 90vw, 650px); max-height: 90vh; overflow: hidden; opacity: 0; visibility: hidden; transform: translate(-50%, -50%) scale(0.95); transition: opacity 0.3s ease, transform 0.3s ease; display: flex; flex-direction: column; }
        .panel.show { opacity: 1; visibility: visible; transform: translate(-50%, -50%) scale(1); }
        .panel-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .panel-header h3 { margin: 0; color: var(--text-primary); font-size: 1.6rem; }
        .panel-controls { display: flex; gap: 10px; }
        .panel-btn { background: none; color: var(--text-secondary); cursor: pointer; border: none; font-size: 1.2rem; padding: 5px; }
        .panel-content { padding: 20px 30px; overflow-y: auto; flex-grow: 1; }
        .collapsible { margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; }
        .collapsible-header { padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; background-color: var(--bg-tertiary); }
        .collapsible-header .fas { transition: transform 0.3s ease; }
        .collapsible-header.open .fas { transform: rotate(180deg); }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out, padding 0.4s ease; padding: 0 15px; background-color: var(--bg-secondary); }
        .collapsible-content.open { max-height: 4000px; padding: 15px; border-top: 1px solid var(--border-color); }
        .notification { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); background-color: var(--bg-tertiary); color: var(--text-primary); padding: 14px 25px; border-radius: 8px; z-index: 1003; border: 1px solid var(--border-color); opacity: 0; visibility: hidden; transition: all 0.4s ease; }
        .notification.show { opacity: 1; transform: translateX(-50%) translateY(-20px); visibility: visible; }
        .tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 25px; overflow-x: auto; }
        .tab-link { padding: 10px 15px; cursor: pointer; color: var(--text-secondary); border-bottom: 2px solid transparent; white-space: nowrap; font-size: 0.9rem; }
        .tab-link.active {
            color: var(--text-primary);
            font-weight: 600;
            background-color: var(--bg-tertiary);
            border-color: var(--accent-blue);
            border-top-left-radius: 6px;
            border-top-right-radius: 6px;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        #chartPanel { width: 90vw; max-width: 1200px; height: 80vh; padding: 0; }
        #chartContainer { width: 100%; flex-grow: 1; }
        #analysisContent .analysis-section { background-color: var(--bg-tertiary); padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--border-color); }
        #analysisContent h4 { color: #64b5f6; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-top: 0; }
        #analysisContent .recommendation-al, #analysisContent .recommendation-guclu-al { font-weight: bold; color: var(--strong-buy); }
        #analysisContent .recommendation-sat, #analysisContent .recommendation-guclu-sat { font-weight: bold; color: var(--strong-sell); }
        #analysisContent .recommendation-tut { font-weight: bold; color: var(--accent-yellow); }
        .filters-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .filter-item { display: flex; align-items: center; background-color: var(--bg-tertiary); padding: 10px; border-radius: 6px; }
        .filter-item input { margin-right: 10px; accent-color: var(--accent-blue); }
        .analysis-actions { display: flex; justify-content: flex-start; align-items: center; margin-top: 20px; flex-wrap: wrap; gap: 15px; }
        .analysis-actions button { background-color: var(--accent-blue); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1rem; display: flex; align-items: center; gap: 8px;}
        .global-analysis-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 15px;}
        .global-analysis-header h3 { margin: 0; color: var(--text-primary); font-size: 1.5rem; font-weight: 600; flex-basis: 100%; text-align: center; margin-bottom: 15px; }
        .global-analysis-controls { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .interval-filters { display: flex; gap: 10px; justify-content: center; flex-grow: 1; }
        .interval-filters button { background-color: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 20px; cursor: pointer; }
        .interval-filters button.active { background-color: var(--accent-blue); color: white; border-color: var(--accent-blue); }
        .analyze-all-btn { background: linear-gradient(45deg, #4285F4, #9B72CB); color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 8px;}
        .analyze-all-btn svg { width: 28px; height: 28px; }
        .indicator-cards-container { display: grid; grid-template-columns: 1fr; gap: 20px; margin-top: 20px; }
        .indicator-card { background: linear-gradient(145deg, var(--bg-tertiary), var(--bg-secondary)); border-radius: 12px; border: 1px solid var(--border-color); padding: 20px; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .indicator-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .indicator-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .indicator-card-header h4 { margin: 0; font-size: 1.5rem; color: #64b5f6; }
        .recommendation-badge { padding: 5px 12px; border-radius: 15px; font-weight: bold; color: white; font-size: 0.9rem; }
        .indicator-details-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .indicator-item { display: flex; justify-content: space-between; align-items: center; background-color: rgba(255,255,255,0.03); padding: 8px 12px; border-radius: 6px; }
        .indicator-item .label { font-size: 0.9rem; color: var(--text-secondary); }
        .indicator-item .value { font-size: 1rem; font-weight: 600; }
        .indicator-item .value.value-positive { color: var(--value-positive); }
        .indicator-item .value.value-negative { color: var(--value-negative); }
        .card-footer { margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .card-footer .summary { flex-grow: 1; }
        .card-footer .summary p { margin: 0; font-size: 0.9rem; line-height: 1.5; color: var(--text-primary); }
        .gemini-btn-wrapper { flex-shrink: 0; margin-left: 15px; }
        .gemini-single-btn { background: none; border: none; cursor: pointer; padding: 8px; border-radius: 50%; display: inline-flex; justify-content: center; align-items: center; transition: background-color 0.2s; }
        .gemini-single-btn:hover { background-color: rgba(155, 114, 203, 0.2); }
        .gemini-single-btn svg { width: 28px; height: 28px; }
        .dictionary-item { margin-bottom: 20px; }
        .dictionary-item h5 { color: #64b5f6; margin: 0 0 8px 0; font-size: 1.1rem; }
        .dictionary-item p { margin: 0 0 10px 0; line-height: 1.6; color: var(--text-secondary); }
        .dictionary-item .example { background-color: var(--bg-tertiary); padding: 10px; border-radius: 6px; font-style: italic; color: var(--text-primary); }
        .settings-section { margin-bottom: 25px; }
        .settings-section h4 { margin: 0 0 15px 0; color: var(--text-primary); font-size: 1.1rem; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .setting-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .setting-item label { font-weight: 500; color: var(--text-secondary); }
        .setting-item input, .setting-item select { background-color: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 8px; padding: 8px 12px; }
        .color-input-wrapper { display: flex; align-items: center; gap: 10px; }
        .color-preview { width: 24px; height: 24px; border-radius: 4px; border: 1px solid var(--border-color); }
        #saveSettingsBtn { width: 100%; padding: 14px; font-size: 1.1rem; background-color: var(--accent-blue); border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; }
        .pivot-filters { display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap; }
        .pivot-filters button { background-color: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 20px; cursor: pointer; }
        .pivot-filters button.active { background-color: var(--accent-blue); color: white; border-color: var(--accent-blue); }
        .pivot-container { display: flex; flex-direction: column; gap: 30px; }
        .pivot-bar-card { background-color: var(--bg-tertiary); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); }
        .pivot-bar-header { margin: 0 0 20px 0; color: #64b5f6; font-size: 1.2rem; font-weight: 600; }
        .pivot-bar-container { position: relative; height: 50px; display: flex; align-items: center; }
        .pivot-bar { height: 10px; width: 100%; border-radius: 5px; background: linear-gradient(to right, var(--accent-red), var(--accent-yellow), var(--accent-green)); position: relative; }
        .pivot-marker { position: absolute; top: -5px; height: 20px; width: 2px; background-color: rgba(255, 255, 255, 0.6); transform: translateX(-50%); }
        .pivot-marker::after { content: attr(data-label); position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); font-size: 0.75rem; color: var(--text-secondary); white-space: nowrap; }
        .pivot-marker.pivot-p::after { color: var(--accent-yellow); font-weight: bold; }
        .current-price-indicator { position: absolute; top: 50%; transform: translate(-50%, -50%); width: 16px; height: 16px; background-color: var(--accent-blue); border: 2px solid white; border-radius: 50%; z-index: 3; transition: left 0.5s ease-out; }
        .current-price-indicator::before { content: attr(data-price); position: absolute; top: -25px; left: 50%; transform: translateX(-50%); background-color: var(--bg-primary); color: white; padding: 2px 6px; border-radius: 5px; font-size: 0.8rem; font-weight: bold; z-index: 2; white-space: nowrap; border: 1px solid var(--border-color); }
    </style>
</head>
<body>

    <div id="login-page" class="page">
        <div class="login-container">
            <h1><i class="fas fa-chart-line"></i> Fiyat Takipçisi</h1>
            <p data-lang="login_prompt">Devam etmek için giriş yapın veya yeni hesap oluşturun.</p>
            <div class="input-group"><label for="email" data-lang="email">E-posta</label><input type="email" id="email"></div>
            <div class="input-group"><label for="password" data-lang="password">Şifre</label><input type="password" id="password"></div>
            <div id="error-message"></div>
            <div class="button-group">
                <button id="loginBtn" data-lang="login">Giriş Yap</button>
                <button id="signupBtn" data-lang="signup" style="background-color: #373c4a;">Kayıt Ol</button>
            </div>
        </div>
    </div>

    <div id="tracker-page" class="page" style="display: none;">
        <div class="tracker-container">
            <header class="app-header">
                 <div class="header-left"><h1><i class="fas fa-chart-line"></i> <span data-lang="app_title">Fiyat Takipçisi</span></h1></div>
                <div class="header-right">
                    <div class="main-actions">
                        <button id="refreshBtn" title="Yenile"><i class="fas fa-sync-alt"></i></button>
                        <button id="settingsBtn" title="Ayarlar"><i class="fas fa-cog"></i></button>
                    </div>
                    <div class="user-menu">
                        <button id="userMenuBtn"><i class="fas fa-user-circle"></i> <span id="userEmail"></span></button>
                        <div class="dropdown-content">
                            <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> <span data-lang="logout">Çıkış Yap</span></a>
                        </div>
                    </div>
                </div>
            </header>
            
            <div class="tabs">
                <div class="tab-link active" data-tab="crypto">Kripto</div>
                <div class="tab-link" data-tab="crypto-ai">Kripto AI</div>
                <div class="tab-link" data-tab="crypto-pivot">AI Pivot</div>
            </div>

            <div id="crypto-content" class="tab-content active">
                 <div class="add-asset-bar">
                    <input type="text" id="newCoinInput" placeholder="BTC, ETH, SOL...">
                    <button id="addCoinBtn"><i class="fas fa-plus"></i> <span data-lang="add">Ekle</span></button>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th><i class="fas fa-grip-lines"></i></th>
                                <th class="sortable" data-sort-key="pair"><span data-lang="coin">Coin</span><span class="sort-indicator"></span></th>
                                <th class="sortable" data-sort-key="latestPrice"><span data-lang="price">Fiyat</span><span class="sort-indicator"></span></th>
                                <th id="col1_header_crypto" class="sortable" data-sort-key="col1"></th>
                                <th id="col2_header_crypto" class="sortable" data-sort-key="col2"></th>
                                <th id="col3_header_crypto" class="sortable" data-sort-key="col3"></th>
                                <th data-lang="delete">Sil</th>
                            </tr>
                        </thead>
                        <tbody id="cryptoPriceTable"></tbody>
                    </table>
                </div>
            </div>
            
            <div id="crypto-ai-content" class="tab-content">
                <div class="collapsible">
                    <div class="collapsible-header"><span>Analiz Filtreleri</span><i class="fas fa-chevron-down"></i></div>
                    <div class="collapsible-content">
                        <div id="crypto-indicator-filters-grid" class="filters-grid"></div>
                        <div class="analysis-actions"><button id="updateCryptoAnalysisBtn"><i class="fas fa-check"></i> Analizi Güncelle</button></div>
                    </div>
                </div>
                <div class="global-analysis-header">
                    <h3>Otomatik Analiz Sonuçları</h3>
                    <div class="global-analysis-controls">
                         <div class="interval-filters" id="cryptoIntervalFilters">
                             <button class="interval-btn" data-interval="1h">1 Saat</button>
                             <button class="interval-btn active" data-interval="4h">4 Saat</button>
                             <button class="interval-btn" data-interval="1d">1 Gün</button>
                        </div>
                        <button id="analyzeAllCryptoBtn" class="analyze-all-btn" title="Tüm listeyi Gemini ile yorumla"></button>
                    </div>
                </div>
                <div id="crypto-indicator-cards-container" class="indicator-cards-container"></div>
                 <div class="collapsible" style="margin-top: 30px;">
                    <div class="collapsible-header">
                        <span>İndikatör Sözlüğü</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="collapsible-content" id="dictionaryContent"></div>
                </div>
            </div>

            <div id="crypto-pivot-content" class="tab-content">
                <div class="pivot-filters" id="cryptoPivotFilters">
                    <button class="active" data-filter="all">Tümü</button>
                    <button data-filter="above">Pivot Üstü</button>
                    <button data-filter="below">Pivot Altı</button>
                </div>
                <div id="crypto-pivot-container" class="pivot-container"></div>
            </div>

            <div class="update-time"><i class="far fa-clock"></i>&nbsp;<span data-lang="last_update">Son güncelleme</span>: <span id="updateTime"></span></div>
        </div>
    </div>

    <div id="settingsPanel" class="panel">
        <div class="panel-header">
            <h3 data-lang="settings">Ayarlar</h3>
            <div class="panel-controls"><button class="panel-btn close-btn"><i class="fas fa-times"></i></button></div>
        </div>
        <div class="panel-content">
            <div class="settings-section">
                <h4 data-lang="general_settings">Genel Ayarlar</h4>
                <div class="setting-item"><label data-lang="language">Dil</label><select id="langSelect"><option value="tr">Türkçe</option><option value="en">English</option></select></div>
                <div class="setting-item"><label data-lang="auto_refresh">Otomatik Yenileme</label><input type="checkbox" id="autoRefreshToggle"></div>
                <div class="setting-item"><label data-lang="refresh_interval">Yenileme Aralığı (sn)</label><input type="number" id="refreshInterval" min="10" step="10"></div>
            </div>
            <div class="settings-section">
                <h4 data-lang="column_settings">Kolon Ayarları</h4>
                <div class="setting-item"><label>Kolon 1 Adı</label><input type="text" id="col1_name_input"></div>
                <div class="setting-item"><label>Gün Sayısı</label><input type="number" id="col1_days_input" min="1"></div>
                <div class="setting-item"><label>Pozitif Eşik (%)</label><input type="number" id="col1_threshold_input" min="0"></div><hr>
                <div class="setting-item"><label>Kolon 2 Adı</label><input type="text" id="col2_name_input"></div>
                <div class="setting-item"><label>Gün Sayısı</label><input type="number" id="col2_days_input" min="1"></div>
                <div class="setting-item"><label>Pozitif Eşik (%)</label><input type="number" id="col2_threshold_input" min="0"></div><hr>
                <div class="setting-item"><label>Kolon 3 Adı</label><input type="text" id="col3_name_input"></div>
                <div class="setting-item"><label>Gün Sayısı</label><input type="number" id="col3_days_input" min="1"></div>
                <div class="setting-item"><label>Pozitif Eşik (%)</label><input type="number" id="col3_threshold_input" min="0"></div>
            </div>
            <div class="settings-section">
                <h4 data-lang="color_settings">Renk Ayarları</h4>
                <div class="setting-item"><label data-lang="high_positive_color">Yüksek Pozitif Renk</label><div class="color-input-wrapper"><input type="color" id="high_color_input"><span class="color-preview" id="high_color_preview"></span></div></div>
                <div class="setting-item"><label data-lang="low_positive_color">Düşük Pozitif Renk</label><div class="color-input-wrapper"><input type="color" id="low_color_input"><span class="color-preview" id="low_color_preview"></span></div></div>
            </div>
            <button id="saveSettingsBtn" data-lang="save_settings">Ayarları Kaydet</button>
        </div>
    </div>
    
    <div id="lowestPricePanel" class="panel">
         <div class="panel-header">
            <h3 id="lowestPriceTitle"></h3>
             <div class="panel-controls"><button class="panel-btn close-btn"><i class="fas fa-times"></i></button></div>
        </div>
        <div class="panel-content"><p id="lowestPriceDetails"></p></div>
    </div>

    <div id="chartPanel" class="panel">
        <div class="panel-header">
            <h3 id="chartPanelTitle"></h3>
            <div class="panel-controls"><button class="panel-btn close-btn" title="Kapat"><i class="fas fa-times"></i></button></div>
        </div>
        <div id="chartContainer"></div>
    </div>

    <div id="analysisPanel" class="panel">
        <div class="panel-header">
            <h3>AI Analizi</h3>
            <div class="panel-controls"><button class="panel-btn close-btn" title="Kapat"><i class="fas fa-times"></i></button></div>
        </div>
        <div id="analysisContent" class="panel-content"></div>
    </div>
    <div id="modalOverlay" class="modal-overlay"></div>
    <div class="notification" id="notification"></div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyA3flTu3Jz9E1D1U_DympYE7B4I4FDxj88",
        authDomain: "fiyattakipv3.firebaseapp.com",
        projectId: "fiyattakipv3",
        storageBucket: "fiyattakipv3.appspot.com",
        messagingSenderId: "440839843277",
        appId: "1:440839843277:web:2c9c15e4a103e8b2f2e884"
    };

    // Firebase'i Başlatma
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const functions = firebase.functions();

    // --- GLOBAL STATE & DOM ELEMENTS ---
    let currentUserRole = null, coinLimit = 10, settings = {}, autoRefreshTimer = null, pageInitialized = false;
    let allCryptoData = [];
    let cryptoPairs = [];
    let userDocRef = null;
    const loginPage = document.getElementById('login-page');
    const trackerPage = document.getElementById('tracker-page');
    const notification = document.getElementById("notification");
    const modalOverlay = document.getElementById('modalOverlay');

    const AVAILABLE_INDICATORS = {
        ema: "EMA", sma: "SMA", rsi: "RSI", macd: "MACD"
    };

    const geminiIconSVG = `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="geminiGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#4285F4;stop-opacity:1" /><stop offset="100%" style="stop-color:#9B72CB;stop-opacity:1" /></linearGradient></defs><path d="M12 2.25C6.07 2.25 2.25 6.07 2.25 12C2.25 17.93 6.07 21.75 12 21.75C17.93 21.75 21.75 17.93 21.75 12C21.75 6.07 17.93 2.25 12 2.25Z" stroke="url(#geminiGradient)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M15.38 12.38L12 10.5L8.62 12.38L9.75 8.62L6.75 6.38L10.62 6.38L12 2.62L13.38 6.38L17.25 6.38L14.25 8.62L15.38 12.38Z" stroke="url(#geminiGradient)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`;

    const translations = {
        tr: {
            login_prompt: "Devam etmek için giriş yapın veya yeni hesap oluşturun.", email: "E-posta", password: "Şifre", login: "Giriş Yap", signup: "Kayıt Ol",
            logout: "Çıkış Yap", app_title: "Fiyat Takipçisi", add: "Ekle", refresh: "Yenile", settings: "Ayarlar", coin: "Coin", price: "Fiyat",
            delete: "Sil", last_update: "Son güncelleme", general_settings: "Genel Ayarlar", language: "Dil",
            auto_refresh: "Otomatik Yenileme", refresh_interval: "Yenileme Aralığı (sn)", column_settings: "Kolon Ayarları",
            color_settings: "Renk Ayarları", high_positive_color: "Yüksek Pozitif Renk",
            low_positive_color: "Düşük Pozitif Renk", save_settings: "Ayarları Kaydet", saved: "Kaydedildi!", limit_exceeded: "Limit aşıldı!",
            role_info: (role, limit) => `Rolünüz (${role}) en fazla ${limit} coin eklemeye izin veriyor.`,
            invalid_asset: (asset) => `Geçersiz varlık: ${asset}`, already_in_list: (asset) => `${asset} zaten listede.`,
            lowest_price_title: (asset, period) => `${asset} - ${period} En Düşük Fiyat`,
            lowest_price_detail: (price, date) => `Bu dönemdeki en düşük fiyat <strong>${price}</strong>, ${date} tarihinde görüldü.`,
        },
        en: { /* English translations */ }
    };

    function getDefaultSettings() {
        return {
            lang: 'tr', autoRefresh: false, refreshInterval: 300,
            columns: { 1: { name: '1G', days: 1, threshold: 2 }, 2: { name: '7G', days: 7, threshold: 5 }, 3: { name: '365G', days: 365, threshold: 10 } },
            colors: { high: '#26a69a', low: '#f59e0b' },
            cryptoPivotFilter: 'all',
            cryptoAnalysisInterval: '4h',
            cryptoAnalysisIndicators: { ema: true, sma: true, rsi: true, macd: true }
        };
    }

    // --- HELPER FUNCTIONS ---
    function translatePage(lang) { document.querySelectorAll('[data-lang]').forEach(el => { const key = el.getAttribute('data-lang'); if (translations[lang]?.[key] && typeof translations[lang][key] === 'string') el.textContent = translations[lang][key]; }); }
    function showPage(pageId) { loginPage.style.display = (pageId === 'login-page') ? 'flex' : 'none'; trackerPage.style.display = (pageId === 'tracker-page') ? 'flex' : 'none'; }
    function showPanel(panelId) { document.getElementById(panelId).classList.add('show'); modalOverlay.classList.add('show'); document.body.classList.add('modal-open'); }
    function closeAllPanels() { document.querySelectorAll('.panel.show').forEach(p => p.classList.remove('show')); modalOverlay.classList.remove('show'); document.body.classList.remove('modal-open'); }
    function showNotification(message, isSuccess = true) { notification.textContent = message; notification.style.backgroundColor = isSuccess ? 'var(--accent-green)' : 'var(--accent-red)'; notification.classList.add('show'); setTimeout(() => notification.classList.remove('show'), 3000); }

    // --- AUTHENTICATION ---
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            userDocRef = db.collection('users').doc(user.uid);
            try {
                const doc = await userDocRef.get();
                let userData = doc.data();
                if (!doc.exists) {
                    userData = {
                        email: user.email, role: 'new_user',
                        coins: ["BTCUSDT", "ETHUSDT", "SOLUSDT"],
                        settings: getDefaultSettings()
                    };
                    await userDocRef.set(userData);
                }
                setRoleAndLimits(userData.role);
                if (!pageInitialized) {
                    await initializeTrackerPage(userData);
                }
                showPage('tracker-page');
            } catch (err) {
                console.error("Auth/Firestore hatası:", err);
                showPage('login-page');
            }
        } else {
            showPage('login-page');
            pageInitialized = false; userDocRef = null;
            if(autoRefreshTimer) clearInterval(autoRefreshTimer);
        }
    });

    function setRoleAndLimits(role) {
        currentUserRole = role;
        const limits = { admin: Infinity, qualified: 20, new_user: 10 };
        coinLimit = limits[currentUserRole] ?? 10;
        document.getElementById('userEmail').textContent = auth.currentUser.email;
    }

    // --- MAIN INITIALIZATION ---
    async function initializeTrackerPage(userData) {
        pageInitialized = true;
        cryptoPairs = userData.coins || ["BTCUSDT", "ETHUSDT", "SOLUSDT"];

        // --- DATA HELPERS ---
        const formatPrice = (price) => {
            const num = parseFloat(price);
            if (isNaN(num)) return 'N/A';
            if (num < 1) return num.toFixed(6);
            if (num < 10) return num.toFixed(4);
            return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };
        const saveCryptoPairsToFirestore = () => { if (userDocRef) userDocRef.update({ coins: cryptoPairs }).catch(err => console.error(err)); };

        // --- SETTINGS MANAGEMENT ---
        function loadSettings(userData) {
            const defaultSettings = getDefaultSettings();
            settings = { ...defaultSettings, ...userData.settings };
            settings.columns = { ...defaultSettings.columns, ...(userData.settings?.columns || {}) };
            settings.colors = { ...defaultSettings.colors, ...(userData.settings?.colors || {}) };
            settings.cryptoAnalysisIndicators = { ...defaultSettings.cryptoAnalysisIndicators, ...(userData.settings?.cryptoAnalysisIndicators || {}) };
            applySettings();
        }

        function saveSettings() {
            let interval = parseInt(document.getElementById('refreshInterval').value);
            const minInterval = { admin: 10, qualified: 120, new_user: 300 }[currentUserRole] || 300;
            if (interval < minInterval) interval = minInterval;
            
            settings.lang = document.getElementById('langSelect').value;
            settings.autoRefresh = document.getElementById('autoRefreshToggle').checked;
            settings.refreshInterval = interval;
            settings.columns = { 
                1: { name: document.getElementById('col1_name_input').value, days: parseInt(document.getElementById('col1_days_input').value), threshold: parseFloat(document.getElementById('col1_threshold_input').value) }, 
                2: { name: document.getElementById('col2_name_input').value, days: parseInt(document.getElementById('col2_days_input').value), threshold: parseFloat(document.getElementById('col2_threshold_input').value) }, 
                3: { name: document.getElementById('col3_name_input').value, days: parseInt(document.getElementById('col3_days_input').value), threshold: parseFloat(document.getElementById('col3_threshold_input').value) } 
            };
            settings.colors = { high: document.getElementById('high_color_input').value, low: document.getElementById('low_color_input').value };

            if (userDocRef) {
                userDocRef.update({ settings: settings }).then(() => {
                    applySettings(); closeAllPanels();
                    showNotification(translations[settings.lang].saved, true);
                    fetchAllDataAndRender();
                }).catch(err => console.error(err));
            }
        }

        function applySettings() {
            document.getElementById('langSelect').value = settings.lang;
            document.getElementById('autoRefreshToggle').checked = settings.autoRefresh;
            document.getElementById('refreshInterval').value = settings.refreshInterval;
            document.getElementById('refreshInterval').min = { admin: 10, qualified: 120, new_user: 300 }[currentUserRole] || 300;
            
            for (let i = 1; i <= 3; i++) {
                document.getElementById(`col${i}_name_input`).value = settings.columns[i].name;
                document.getElementById(`col${i}_days_input`).value = settings.columns[i].days;
                document.getElementById(`col${i}_threshold_input`).value = settings.columns[i].threshold;
                document.getElementById(`col${i}_header_crypto`).innerHTML = `${settings.columns[i].name}<span class="sort-indicator"></span>`;
            }

            document.getElementById('high_color_input').value = settings.colors.high;
            document.getElementById('low_color_input').value = settings.colors.low;
            document.getElementById('high_color_preview').style.backgroundColor = settings.colors.high;
            document.getElementById('low_color_preview').style.backgroundColor = settings.colors.low;

            document.querySelectorAll('#cryptoPivotFilters .active, #cryptoIntervalFilters .active').forEach(b => b.classList.remove('active'));
            document.querySelector(`#cryptoPivotFilters button[data-filter="${settings.cryptoPivotFilter}"]`)?.classList.add('active');
            document.querySelector(`#cryptoIntervalFilters button[data-interval="${settings.cryptoAnalysisInterval}"]`)?.classList.add('active');

            Object.keys(AVAILABLE_INDICATORS).forEach(key => {
                const checkbox = document.querySelector(`#crypto-indicator-filters-grid input[data-indicator="${key}"]`);
                if (checkbox) checkbox.checked = !!settings.cryptoAnalysisIndicators[key];
            });

            document.querySelectorAll('.analyze-all-btn').forEach(btn => btn.innerHTML = geminiIconSVG);
            translatePage(settings.lang);
            toggleAutoRefresh();
        }

        function toggleAutoRefresh() { if(autoRefreshTimer) clearInterval(autoRefreshTimer); if(settings.autoRefresh) autoRefreshTimer = setInterval(fetchAllDataAndRender, settings.refreshInterval * 1000); }

        // --- DATA FETCHING & CALCULATIONS ---
        const calculateSMA = (data, period) => { if (data.length < period) return null; return data.slice(-period).reduce((s, v) => s + v, 0) / period; };
        const calculateEMA = (data, period) => { if (data.length < period) return null; const k = 2 / (period + 1); let ema = calculateSMA(data.slice(0, period), period); for (let i = period; i < data.length; i++) { ema = (data[i] * k) + (ema * (1 - k)); } return ema; };
        const calculateRSI = (data, period = 14) => { if (data.length <= period) return null; let gains = 0, losses = 0; let avgGain, avgLoss; for (let i = 1; i <= period; i++) { const diff = data[i] - data[i - 1]; if (diff > 0) gains += diff; else losses -= diff; } avgGain = gains / period; avgLoss = losses / period; for (let i = period + 1; i < data.length; i++) { const diff = data[i] - data[i - 1]; let currentGain = diff > 0 ? diff : 0; let currentLoss = diff < 0 ? -diff : 0; avgGain = (avgGain * (period - 1) + currentGain) / period; avgLoss = (avgLoss * (period - 1) + currentLoss) / period; } if (avgLoss === 0) return 100; const rs = avgGain / avgLoss; return 100 - (100 / (1 + rs)); };
        const calculateMACD = (data, fast = 12, slow = 26, signal = 9) => { if (data.length < slow + signal) return null; const emaFast = calculateEMA(data, fast); const emaSlow = calculateEMA(data, slow); const macdLine = emaFast - emaSlow; const macdLineData = []; for(let i=slow; i<data.length; i++) { macdLineData.push(calculateEMA(data.slice(0, i+1), fast) - calculateEMA(data.slice(0, i+1), slow)); } const signalLine = calculateEMA(macdLineData, signal); return { macd: macdLine, signal: signalLine, histogram: macdLine - signalLine }; };

        async function fetchCryptoData(pair) {
            try {
                const [klinesResponse, tickerResponse] = await Promise.all([
                    axios.get(`https://api.binance.com/api/v3/klines?symbol=${pair}&interval=1d&limit=400`),
                    axios.get(`https://api.binance.com/api/v3/ticker/24hr?symbol=${pair}`)
                ]);
                const dailyKlines = klinesResponse.data;
                const tickerData = tickerResponse.data;
                const latestPrice = parseFloat(tickerData.lastPrice);
                const closePrices = dailyKlines.map(d => parseFloat(d[4]));
                
                const calculatePct = (col) => {
                    const days = settings.columns[col].days;
                    if (dailyKlines.length <= days) return { pct: 'N/A' };
                    const periodData = dailyKlines.slice(-(days + 1), -1);
                    const lowestPrice = Math.min(...periodData.map(d => parseFloat(d[3])));
                    const lowestKline = periodData.find(d => parseFloat(d[3]) === lowestPrice);
                    return {
                        pct: ((latestPrice - lowestPrice) / lowestPrice * 100).toFixed(2),
                        lowestPrice,
                        lowestDate: lowestKline ? new Date(lowestKline[0]).toLocaleDateString(settings.lang) : 'N/A'
                    };
                };
                
                const yesterday = dailyKlines[dailyKlines.length - 2];
                if (!yesterday) throw new Error("Yetersiz geçmiş veri.");
                const high = parseFloat(yesterday[2]), low = parseFloat(yesterday[3]), close = parseFloat(yesterday[4]);
                const pivot = (high + low + close) / 3;

                return {
                    pair, latestPrice, error: false,
                    col1: calculatePct(1), col2: calculatePct(2), col3: calculatePct(3),
                    sr: { r2: pivot + (high - low), r1: (2 * pivot) - low, pivot: pivot, s1: (2 * pivot) - high, s2: pivot - (high - low) },
                    indicators: {
                        sma: calculateSMA(closePrices, 50), ema: calculateEMA(closePrices, 20),
                        rsi: calculateRSI(closePrices), macd: calculateMACD(closePrices)
                    }
                };
            } catch (error) {
                console.error(`${pair} verisi çekilirken hata oluştu:`, error);
                return { pair, error: true };
            }
        }
        
        // --- RENDER FUNCTIONS ---
        async function fetchAllDataAndRender() {
            document.getElementById('refreshBtn').innerHTML = '<div class="loading"></div>';
            allCryptoData = await Promise.all(cryptoPairs.map(fetchCryptoData));
            renderTable(allCryptoData);
            renderIndicatorCards(allCryptoData);
            renderSupportResistance(allCryptoData);
            document.getElementById('refreshBtn').innerHTML = `<i class="fas fa-sync-alt"></i>`;
            document.getElementById('updateTime').textContent = new Date().toLocaleString(settings.lang);
        }

        function renderTable(data) {
            const tableBody = document.getElementById('cryptoPriceTable');
            tableBody.innerHTML = '';
            data.forEach(result => {
                const row = document.createElement("tr");
                row.dataset.pair = result.pair;
                const getCellStyle = (colData, threshold) => {
                    const pct = parseFloat(colData.pct);
                    if (isNaN(pct)) return '';
                    if (pct < 0) return 'class="negative"';
                    if (pct >= threshold) return `class="positive-high" style="color: ${settings.colors.high};"`;
                    return `class="positive-low" style="color: ${settings.colors.low};"`;
                };
                let rowHTML;
                if (result.error) {
                    rowHTML = `<td><i class="fas fa-grip-lines drag-handle"></i></td><td class="asset-cell">${result.pair.replace("USDT", "")}</td><td colspan="5" style="text-align:center; color: var(--accent-red);">Veri alınamadı</td>`;
                } else {
                    rowHTML = `
                        <td><i class="fas fa-grip-lines drag-handle"></i></td>
                        <td class="asset-cell" data-pair="${result.pair}">${result.pair.replace("USDT", "")}<span class="symbol">/USDT</span></td>
                        <td>${formatPrice(result.latestPrice)}</td>
                        <td ${getCellStyle(result.col1, settings.columns[1].threshold)} class="clickable-pct" data-col="1" data-pair="${result.pair}">${result.col1.pct}%</td>
                        <td ${getCellStyle(result.col2, settings.columns[2].threshold)} class="clickable-pct" data-col="2" data-pair="${result.pair}">${result.col2.pct}%</td>
                        <td ${getCellStyle(result.col3, settings.columns[3].threshold)} class="clickable-pct" data-col="3" data-pair="${result.pair}">${result.col3.pct}%</td>
                    `;
                }
                rowHTML += `<td><button class="action-btn remove-btn" data-pair="${result.pair}"><i class="fas fa-times"></i></button></td>`;
                row.innerHTML = rowHTML;
                tableBody.appendChild(row);
            });
        }
        
        function getRecommendation(asset) {
            const { indicators, latestPrice } = asset;
            const activeIndicators = settings.cryptoAnalysisIndicators;
            let score = 0;
            let summaryPoints = { buy: [], sell: [], neutral: [] };
            if (!indicators) return { recommendation: "Veri Yok", color: "var(--hold)", summary: "Analiz için veri yetersiz."};

            if (activeIndicators.ema && activeIndicators.sma && indicators.ema && indicators.sma) { 
                if (indicators.ema > indicators.sma) { score++; summaryPoints.buy.push("EMA, SMA'nın üzerinde (yükseliş)."); } 
                else { score--; summaryPoints.sell.push("EMA, SMA'nın altında (düşüş)."); } 
            }
            if (activeIndicators.rsi && indicators.rsi) { 
                if (indicators.rsi < 35) { score++; summaryPoints.buy.push("RSI aşırı satım bölgesinde."); } 
                if (indicators.rsi > 65) { score--; summaryPoints.sell.push("RSI aşırı alım bölgesinde."); } 
            }
            if (activeIndicators.macd && indicators.macd) { 
                if (indicators.macd.histogram > 0) { score++; summaryPoints.buy.push("MACD histogramı pozitif."); } 
                else { score--; summaryPoints.sell.push("MACD histogramı negatif."); } 
            }
            
            let recommendation, color;
            if (score >= 2) { recommendation = "Güçlü Al"; color = "var(--strong-buy)"; }
            else if (score === 1) { recommendation = "Al"; color = "var(--buy)"; }
            else if (score <= -2) { recommendation = "Güçlü Sat"; color = "var(--strong-sell)"; }
            else if (score === -1) { recommendation = "Sat"; color = "var(--sell)"; }
            else { recommendation = "Tut"; color = "var(--hold)"; summaryPoints.neutral.push("Mevcut göstergeler net bir yön belirtmiyor."); }
            
            let summary = [...summaryPoints.buy, ...summaryPoints.sell, ...summaryPoints.neutral].join(' ');
            return { recommendation, color, summary: summary || "Nötr sinyaller." };
        }

        function renderIndicatorCards(data) {
            const container = document.getElementById('crypto-indicator-cards-container');
            container.innerHTML = '';
            data.forEach(asset => {
                const card = document.createElement('div');
                card.className = 'indicator-card';
                if (asset.error) {
                    card.innerHTML = `<h4>${asset.pair.replace("USDT", "")}</h4><p style="color:var(--accent-red)">Veri yüklenemedi.</p>`;
                } else {
                    const { recommendation, color, summary } = getRecommendation(asset);
                    card.innerHTML = `
                        <div class="indicator-card-header">
                            <h4>${asset.pair.replace("USDT", "")}</h4>
                            <span class="recommendation-badge" style="background-color:${color};">${recommendation}</span>
                        </div>
                        <div class="card-footer">
                            <div class="summary"><p><strong>Özet:</strong> ${summary}</p></div>
                            <div class="gemini-btn-wrapper">
                               <button class="gemini-single-btn" data-pair="${asset.pair}" title="Bu varlığı Gemini ile yorumla">${geminiIconSVG}</button>
                            </div>
                        </div>`;
                }
                container.appendChild(card);
            });
        }
        
        function renderSupportResistance(data) {
            const container = document.getElementById('crypto-pivot-container');
            container.innerHTML = '';
            const filter = settings.cryptoPivotFilter;
            data.forEach(asset => {
                if (asset.error || !asset.sr) return;
                if (filter === 'above' && asset.latestPrice < asset.sr.pivot) return;
                if (filter === 'below' && asset.latestPrice > asset.sr.pivot) return;
                const { s2, s1, pivot, r1, r2 } = asset.sr;
                const min = s2, max = r2;
                const range = max - min;
                if (range <= 0) return;
                const getPosition = (value) => ((value - min) / range) * 100;
                const pricePos = Math.max(0, Math.min(100, getPosition(asset.latestPrice)));
                const card = document.createElement('div');
                card.className = 'pivot-bar-card';
                card.innerHTML = `
                    <h4 class="pivot-bar-header">${asset.pair.replace("USDT", "")} - Günlük Pivot Seviyeleri</h4>
                    <div class="pivot-bar-container">
                        <div class="pivot-bar">
                            <div class="pivot-marker" style="left: ${getPosition(s2)}%;" data-label="S2"></div>
                            <div class="pivot-marker" style="left: ${getPosition(s1)}%;" data-label="S1"></div>
                            <div class="pivot-marker pivot-p" style="left: ${getPosition(pivot)}%;" data-label="PIVOT"></div>
                            <div class="pivot-marker" style="left: ${getPosition(r1)}%;" data-label="R1"></div>
                            <div class="pivot-marker" style="left: ${getPosition(r2)}%;" data-label="R2"></div>
                        </div>
                        <div class="current-price-indicator" style="left: ${pricePos}%;" data-price="${formatPrice(asset.latestPrice)}"></div>
                    </div>`;
                container.appendChild(card);
            });
        }
        
        function updateAnalysisSettings() {
            settings.cryptoAnalysisIndicators = {};
            document.querySelectorAll('#crypto-indicator-filters-grid input[type="checkbox"]').forEach(checkbox => {
                settings.cryptoAnalysisIndicators[checkbox.dataset.indicator] = checkbox.checked;
            });
            if (userDocRef) {
                userDocRef.update({ settings: settings }).then(() => {
                    renderIndicatorCards(allCryptoData);
                    showNotification("Analiz güncellendi!", true);
                }).catch(err => console.error(err));
            }
        }

        async function getGeminiAnalysis(pair) {
            const button = document.querySelector(`.gemini-single-btn[data-pair="${pair}"]`);
            if (!button) return;
            button.disabled = true; button.innerHTML = `<div class="loading"></div>`;
            const asset = allCryptoData.find(c => c.pair === pair);
            if (!asset || asset.error) {
                document.getElementById('analysisContent').innerHTML = `<p style="color:var(--accent-red)">Analiz için veri bulunamadı.</p>`;
                showPanel('analysisPanel');
                button.disabled = false; button.innerHTML = geminiIconSVG; return;
            }
            const dataSummary = `Varlık: ${asset.pair.replace('USDT', '')}, Fiyat: ${asset.latestPrice.toFixed(2)} USD. İndikatörler: ${JSON.stringify(asset.indicators)}`;
            const fullPrompt = `Sen bir uzman finansal analistsin. Şu verileri analiz et: ${dataSummary}. Kısa bir özet ve net bir 'Al', 'Sat' veya 'Tut' tavsiyesi ver. Cevabını HTML formatında, '.analysis-section' div'i içinde ver.`;
            try {
                const geminiProxy = functions.httpsCallable('geminiProxy');
                const result = await geminiProxy({ prompt: fullPrompt });
                if (result.data && result.data.analysis) {
                    document.getElementById('analysisContent').innerHTML = result.data.analysis;
                } else { throw new Error("Yapay zekadan geçerli bir yanıt alınamadı."); }
            } catch (error) {
                console.error("Cloud Function Çağrı Hatası:", error);
                document.getElementById('analysisContent').innerHTML = `<p style="color:var(--accent-red)">Yorumlama sırasında bir hata oluştu: ${error.message}</p>`;
            } finally {
                showPanel('analysisPanel');
                button.disabled = false; button.innerHTML = geminiIconSVG;
            }
        }

        const addNewAsset = async () => {
            const input = document.getElementById('newCoinInput');
            const newAssetSymbols = input.value.split(',').map(s => s.trim().toUpperCase()).filter(Boolean);
            if (newAssetSymbols.length === 0) return;
            const added = [], alreadyExist = [], invalid = [];
            for (const symbol of newAssetSymbols) {
                if (cryptoPairs.length >= coinLimit) { showNotification(translations[settings.lang].limit_exceeded, false); break; }
                const newPair = symbol.endsWith('USDT') ? symbol : `${symbol}USDT`;
                if (cryptoPairs.includes(newPair)) { alreadyExist.push(symbol); continue; }
                cryptoPairs.push(newPair);
                added.push(symbol);
            }
            if (added.length > 0) {
                saveCryptoPairsToFirestore();
                await fetchAllDataAndRender();
                showNotification(`${added.join(', ')} eklendi!`, true);
            }
            if (alreadyExist.length > 0) showNotification(`${alreadyExist.join(', ')} zaten listede.`, false);
            input.value = '';
        };

        function showChart(pair) {
            document.getElementById('chartPanelTitle').textContent = pair;
            document.getElementById('chartContainer').innerHTML = '';
            new TradingView.widget({ "autosize": true, "symbol": `BINANCE:${pair}`, "interval": "D", "theme": "dark", "style": "1", "locale": "tr", "container_id": "chartContainer" });
            showPanel('chartPanel');
        }

        // --- GLOBAL EVENT LISTENERS ---
        document.getElementById('loginBtn').addEventListener('click', () => auth.signInWithEmailAndPassword(document.getElementById("email").value, document.getElementById("password").value).catch(err => document.getElementById("error-message").textContent = err.message));
        document.getElementById('signupBtn').addEventListener('click', () => auth.createUserWithEmailAndPassword(document.getElementById("email").value, document.getElementById("password").value).catch(err => document.getElementById("error-message").textContent = err.message));
        document.getElementById('logoutBtn').addEventListener('click', (e) => { e.preventDefault(); auth.signOut(); });
        document.getElementById('refreshBtn').addEventListener('click', fetchAllDataAndRender);
        document.getElementById('addCoinBtn').addEventListener('click', addNewAsset);
        document.getElementById('newCoinInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') addNewAsset(); });
        document.getElementById('settingsBtn').addEventListener('click', () => showPanel('settingsPanel'));
        document.querySelectorAll('.close-btn, #modalOverlay').forEach(el => el.addEventListener('click', closeAllPanels));
        document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
        document.getElementById('updateCryptoAnalysisBtn').addEventListener('click', updateAnalysisSettings);

        trackerPage.addEventListener('click', (e) => {
            const target = e.target;
            const closest = (selector) => target.closest(selector);
            const collapsibleHeader = closest('.collapsible-header');
            if (collapsibleHeader) {
                collapsibleHeader.classList.toggle('open');
                const content = collapsibleHeader.nextElementSibling;
                if (content) content.classList.toggle('open');
                return;
            }
            const tabLink = closest('.tab-link');
            if (tabLink) {
                document.querySelector('.tab-link.active').classList.remove('active');
                document.querySelector('.tab-content.active').classList.remove('active');
                tabLink.classList.add('active');
                document.getElementById(`${tabLink.dataset.tab}-content`).classList.add('active');
                return;
            }
            const geminiBtn = closest('.gemini-single-btn');
            if(geminiBtn){
                getGeminiAnalysis(geminiBtn.dataset.pair);
                return;
            }
            const assetCell = closest('.asset-cell, .clickable-pct, .remove-btn');
            if (assetCell) {
                const { pair, col } = assetCell.dataset;
                if (assetCell.classList.contains('asset-cell')) {
                    showChart(pair);
                } else if (assetCell.classList.contains('clickable-pct')) {
                    const assetData = allCryptoData.find(c => c.pair === pair);
                    if (assetData && !assetData.error && col) {
                        const colData = assetData[`col${col}`];
                        if (colData && colData.lowestPrice) {
                            document.getElementById('lowestPriceTitle').textContent = translations[settings.lang].lowest_price_title(assetData.pair.replace('USDT',''), settings.columns[col].name);
                            document.getElementById('lowestPriceDetails').innerHTML = translations[settings.lang].lowest_price_detail(formatPrice(colData.lowestPrice), colData.lowestDate);
                            showPanel('lowestPricePanel');
                        }
                    }
                } else if (assetCell.classList.contains('remove-btn')) {
                    cryptoPairs = cryptoPairs.filter(p => p !== pair);
                    saveCryptoPairsToFirestore();
                    fetchAllDataAndRender();
                }
            }
        });

        new Sortable(document.getElementById('cryptoPriceTable'), {
            handle: '.drag-handle', animation: 150,
            onEnd: (evt) => {
                const [movedItem] = cryptoPairs.splice(evt.oldIndex, 1);
                cryptoPairs.splice(evt.newIndex, 0, movedItem);
                saveCryptoPairsToFirestore();
            }
        });
        
        function renderIndicatorFilters() {
            const grid = document.getElementById(`crypto-indicator-filters-grid`);
            if(grid) grid.innerHTML = Object.keys(AVAILABLE_INDICATORS).map(key => `<label class="filter-item"><input type="checkbox" data-indicator="${key}">${AVAILABLE_INDICATORS[key]}</label>`).join('');
        }

        function renderDictionary() {
            const content = document.getElementById('dictionaryContent');
            if(content) content.innerHTML = `
                <div class="dictionary-item"><h5>RSI (Göreceli Güç Endeksi)</h5><p>Fiyat hareketlerinin hızını ve değişimini ölçerek bir varlığın aşırı alım veya aşırı satım koşullarında olup olmadığını değerlendirir.</p></div>
                <div class="dictionary-item"><h5>MACD (Hareketli Ortalama Yakınsama/Iraksama)</h5><p>İki farklı üssel hareketli ortalama arasındaki ilişkiyi gösteren bir trend takip ve momentum göstergesidir.</p></div>
                <div class="dictionary-item"><h5>Hareketli Ortalamalar (EMA/SMA)</h5><p>Belirli bir periyottaki fiyatların ortalamasını alarak trend yönünü belirginleştirir.</p></div>`;
        }

        // --- INITIAL LOAD ---
        loadSettings(userData);
        await fetchAllDataAndRender();
        renderIndicatorFilters();
        renderDictionary();
    }
</script>

</body>
</html>
}
