<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fiyat Takip√ßisi (AI Analizli)</title>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-functions-compat.js"></script>

    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

    <style>
        :root {
            --bg-primary: #131722; --bg-secondary: #1e222d; --bg-tertiary: #2a2e39;
            --border-color: #424651; --text-primary: #d1d4dc; --text-secondary: #8c92a2;
            --accent-blue: #2962ff; --accent-green: #26a69a; --accent-red: #ef5350; --accent-yellow: #f59e0b;
            --strong-buy: #00bfa5; --buy: #26a69a; --hold: #8c92a2; --sell: #ef5350; --strong-sell: #d50000;
            --value-positive: #26de81; --value-negative: #ff4757;
        }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif; margin: 0; background-color: var(--bg-primary); color: var(--text-primary);
            overflow-x: hidden; -webkit-tap-highlight-color: transparent;
        }
        body.modal-open { overflow: hidden; }
        .page { min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 10px; box-sizing: border-box; }
        .login-container { background: var(--bg-secondary); padding: 40px; border-radius: 12px; border: 1px solid var(--border-color); width: 100%; max-width: 400px; text-align: center; margin-top: 10vh; }
        .login-container h1 { color: var(--text-primary); font-size: 2rem; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .login-container h1 .fas { color: var(--accent-yellow); }
        .login-container p { margin-bottom: 30px; color: var(--text-secondary); }
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 0.9rem; color: var(--text-secondary); }
        .login-container input { width: 100%; padding: 12px 15px; border: 1px solid var(--border-color); background-color: var(--bg-tertiary); color: var(--text-primary); border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        .button-group { display: flex; gap: 10px; margin-top: 25px; }
        .login-container button { flex-grow: 1; background-color: var(--accent-blue); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; }
        #error-message { color: var(--accent-red); margin-top: 15px; font-weight: 500; min-height: 20px; }
        .tracker-container { width: 100%; max-width: 1200px; margin: 0 auto; background-color: var(--bg-secondary); border-radius: 12px; padding: 20px; border: 1px solid var(--border-color); }
        .app-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .app-header .header-left h1 { color: var(--text-primary); font-size: 1.8rem; margin: 0; display: flex; align-items: center; gap: 12px; }
        .app-header .header-left h1 .fas { color: var(--accent-yellow); }
        .app-header .header-right { display: flex; align-items: center; gap: 10px; }
        .app-header .main-actions button { background-color: var(--bg-tertiary); color: var(--text-secondary); padding: 8px 16px; font-size: 0.9rem; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; }
        .user-menu { position: relative; }
        #userMenuBtn { background-color: var(--bg-tertiary); color: var(--text-primary); padding: 8px 12px; display: flex; align-items: center; gap: 8px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; }
        .dropdown-content { display: none; position: absolute; right: 0; background-color: var(--bg-secondary); min-width: 200px; box-shadow: 0 8px 16px rgba(0,0,0,0.4); z-index: 100; border-radius: 8px; border: 1px solid var(--border-color); overflow: hidden; }
        .dropdown-content a { color: var(--text-primary); padding: 12px 16px; text-decoration: none; display: flex; align-items: center; gap: 10px; font-size: 0.95rem; }
        .dropdown-content a:hover { background-color: var(--bg-tertiary); }
        .user-menu:hover .dropdown-content { display: block; }
        .add-asset-bar { display: flex; gap: 10px; margin-bottom: 25px; }
        .add-asset-bar input { flex-grow: 1; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; background-color: var(--bg-tertiary); color: var(--text-primary); }
        .add-asset-bar button { padding: 12px 20px; background-color: var(--accent-blue); border-radius: 8px; border: none; color: white; cursor: pointer; }
        .table-controls { display: flex; justify-content: flex-end; margin-bottom: 10px; }
        .table-controls button { background-color: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 8px; cursor: pointer; }
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        th, td { padding: 14px 10px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        th { color: var(--text-secondary); font-weight: 500; position: sticky; top: 0; background-color: var(--bg-secondary); z-index: 1; }
        th.sortable { cursor: pointer; }
        th.sortable:hover { color: var(--text-primary); }
        th .sort-indicator { margin-left: 8px; opacity: 0.5; transition: opacity 0.2s; display: inline-block; width: 1em; text-align: center;}
        th.asc .sort-indicator, th.desc .sort-indicator { opacity: 1; }
        th.asc .sort-indicator::before { content: '‚ñ≤'; }
        th.desc .sort-indicator::before { content: '‚ñº'; }
        td { color: var(--text-primary); }
        .asset-cell { font-weight: 600; color: #64b5f6; cursor: pointer; }
        .asset-cell:hover { text-decoration: underline; }
        .asset-cell .symbol { display:none; }
        .drag-handle-col { width: 20px; padding: 0 10px; }
        .drag-handle-col.hidden, #cryptoPriceTable .drag-handle-col.hidden { display: none; }
        .drag-handle { cursor: grab; padding: 0 10px; color: #9ca3af; }
        tr:hover td { background-color: var(--bg-tertiary); }
        .positive { color: var(--accent-green); }
        .positive-high { font-weight: 600; }
        .positive-low { font-weight: 600; }
        .negative { color: var(--accent-red); font-weight: 600; }
        .clickable-pct { cursor: pointer; text-decoration: underline; text-decoration-style: dotted; text-decoration-color: var(--text-secondary); }
        .update-time { text-align: center; margin: 20px 0 10px 0; color: var(--text-secondary); font-size: 0.85rem; }
        .action-btn { background-color: transparent; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.1rem; padding: 5px 8px; }
        .action-btn:hover { color: var(--accent-yellow); }
        .loading { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease; }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .panel { position: fixed; top: 50%; left: 50%; background-color: var(--bg-secondary); padding: 0; border-radius: 12px; border: 1px solid var(--border-color); z-index: 1001; width: clamp(300px, 90vw, 650px); max-height: 90vh; overflow: hidden; opacity: 0; visibility: hidden; transform: translate(-50%, -50%) scale(0.95); transition: opacity 0.3s ease, transform 0.3s ease; display: flex; flex-direction: column; }
        .panel.show { opacity: 1; visibility: visible; transform: translate(-50%, -50%) scale(1); }
        .panel-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .panel-header h3 { margin: 0; color: var(--text-primary); font-size: 1.6rem; }
        .panel-controls { display: flex; gap: 10px; }
        .panel-btn { background: none; color: var(--text-secondary); cursor: pointer; border: none; font-size: 1.2rem; padding: 5px; }
        .panel-content { padding: 20px 30px; overflow-y: auto; flex-grow: 1; }
        .notification { position: fixed; bottom: 25px; left: 25px; transform: translateX(-150%); background-color: var(--bg-tertiary); color: var(--text-primary); padding: 14px 25px; border-radius: 8px; z-index: 1003; border: 1px solid var(--border-color); opacity: 0; visibility: hidden; transition: all 0.4s ease; }
        .notification.show { opacity: 1; transform: translateX(0); visibility: visible; }
        .tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 25px; overflow-x: auto; }
        .tab-link { padding: 10px 15px; cursor: pointer; color: var(--text-secondary); border-bottom: 2px solid transparent; white-space: nowrap; font-size: 0.9rem; }
        .tab-link.active { color: var(--text-primary); font-weight: 600; background-color: var(--bg-tertiary); border-color: var(--accent-blue); border-top-left-radius: 6px; border-top-right-radius: 6px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        #chartPanel { width: 90vw; max-width: 1200px; height: 80vh; padding: 0; }
        #chartContainer { width: 100%; flex-grow: 1; }
        .analysis-section { background-color: var(--bg-tertiary); padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--border-color); }
        .analysis-section h4 { color: #64b5f6; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-top: 0; font-size: 1.5rem; }
        .analysis-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px 20px; margin-bottom: 15px; }
        .analysis-item { display: flex; justify-content: space-between; background-color: rgba(255,255,255,0.03); padding: 8px 12px; border-radius: 6px; }
        .analysis-item .label { color: var(--text-secondary); }
        .analysis-item .value { font-weight: 600; }
        .analysis-summary { line-height: 1.6; margin-bottom: 10px; }
        .analysis-recommendation { font-weight: bold; font-size: 1.1rem; }
        .recommendation-al, .recommendation-guclu-al { font-weight: bold; color: var(--strong-buy); }
        .recommendation-sat, .recommendation-guclu-sat { font-weight: bold; color: var(--strong-sell); }
        .recommendation-tut { font-weight: bold; color: var(--accent-yellow); }
        .filters-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .filter-item { display: flex; align-items: center; background-color: var(--bg-tertiary); padding: 10px; border-radius: 6px; }
        .filter-item input { margin-right: 10px; accent-color: var(--accent-blue); }
        .analysis-actions { display: flex; justify-content: flex-start; align-items: center; margin-top: 20px; flex-wrap: wrap; gap: 15px; }
        .analysis-actions button { background-color: var(--accent-blue); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1rem; display: flex; align-items: center; gap: 8px;}
        .global-analysis-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 15px;}
        .global-analysis-header h3 { margin: 0; color: var(--text-primary); font-size: 1.5rem; font-weight: 600; flex-basis: 100%; text-align: center; margin-bottom: 15px; }
        .global-analysis-controls { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .interval-filters { display: flex; gap: 10px; justify-content: center; flex-grow: 1; }
        .interval-filters button { background-color: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 20px; cursor: pointer; }
        .interval-filters button.active { background-color: var(--accent-blue); color: white; border-color: var(--accent-blue); }
        .ai-btn { background: linear-gradient(45deg, #4285F4, #9B72CB); color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 8px;}
        .indicator-cards-container { display: grid; grid-template-columns: 1fr; gap: 20px; margin-top: 20px; }
        .indicator-card { background: linear-gradient(145deg, var(--bg-tertiary), var(--bg-secondary)); border-radius: 12px; border: 1px solid var(--border-color); padding: 20px; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .indicator-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .indicator-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .indicator-card-header h4 { margin: 0; font-size: 1.5rem; color: #64b5f6; }
        .recommendation-badge { padding: 5px 12px; border-radius: 15px; font-weight: bold; color: white; font-size: 0.9rem; }
        .indicator-details-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .indicator-item { display: flex; justify-content: space-between; align-items: center; background-color: rgba(255,255,255,0.03); padding: 8px 12px; border-radius: 6px; }
        .indicator-item .label { font-size: 0.9rem; color: var(--text-secondary); }
        .indicator-item .value { font-size: 1rem; font-weight: 600; }
        .indicator-item .value.value-positive { color: var(--value-positive); }
        .indicator-item .value.value-negative { color: var(--value-negative); }
        .card-footer { margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .card-footer .summary { flex-grow: 1; font-size: 0.9rem; line-height: 1.5; color: var(--text-primary); }
        .dictionary-item { margin-bottom: 20px; }
        .dictionary-item h5 { color: #64b5f6; margin: 0 0 8px 0; font-size: 1.1rem; }
        .dictionary-item p { margin: 0 0 10px 0; line-height: 1.6; color: var(--text-secondary); }
        .dictionary-item .example { background-color: var(--bg-tertiary); padding: 10px; border-radius: 6px; font-style: italic; color: var(--text-primary); }
        .settings-section { margin-bottom: 25px; }
        .settings-section h4 { margin: 0 0 15px 0; color: var(--text-primary); font-size: 1.1rem; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .setting-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .setting-item label { font-weight: 500; color: var(--text-secondary); }
        .setting-item input, .setting-item select { background-color: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 8px; padding: 8px 12px; }
        .color-input-wrapper { display: flex; align-items: center; gap: 10px; }
        .color-preview { width: 24px; height: 24px; border-radius: 4px; border: 1px solid var(--border-color); }
        #saveSettingsBtn { width: 100%; padding: 14px; font-size: 1.1rem; background-color: var(--accent-blue); border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; }
        .pivot-filters { display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap; }
        .pivot-filters button { background-color: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 20px; cursor: pointer; }
        .pivot-filters button.active { background-color: var(--accent-blue); color: white; border-color: var(--accent-blue); }
        .pivot-container { display: flex; flex-direction: column; gap: 15px; }
        .pivot-bar-card { background-color: var(--bg-tertiary); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); }
        .pivot-bar-header { margin: 0 0 20px 0; color: #64b5f6; font-size: 1.2rem; font-weight: 600; }
        .pivot-bar-container { position: relative; height: 50px; display: flex; align-items: center; }
        .pivot-bar { height: 10px; width: 100%; border-radius: 5px; background: linear-gradient(to right, var(--accent-red), var(--accent-yellow), var(--accent-green)); position: relative; }
        .pivot-marker { position: absolute; top: -5px; height: 20px; width: 2px; background-color: rgba(255, 255, 255, 0.6); transform: translateX(-50%); }
        .pivot-values { display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.8rem; color: var(--text-secondary); flex-wrap: wrap; }
        .current-price-indicator { position: absolute; top: 50%; transform: translate(-50%, -50%); width: 16px; height: 16px; background-color: var(--accent-blue); border: 2px solid white; border-radius: 50%; z-index: 3; transition: left 0.5s ease-out; }
        .current-price-indicator::before { content: attr(data-price); position: absolute; top: -25px; left: 50%; transform: translateX(-50%); background-color: var(--bg-primary); color: white; padding: 2px 6px; border-radius: 5px; font-size: 0.8rem; font-weight: bold; z-index: 2; white-space: nowrap; border: 1px solid var(--border-color); }
        .pivot-dictionary { margin-top: 20px; background-color: var(--bg-tertiary); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 0.9rem;}
        .pivot-dictionary p { margin: 5px 0; }
        .pivot-dictionary span { font-weight: bold; color: var(--text-primary); }
        .telegram-info { background-color: var(--bg-tertiary); padding: 15px; border-radius: 8px; margin-top: 5px; font-size: 0.85rem; line-height: 1.5; color: var(--text-secondary); }
        .telegram-info a { color: #64b5f6; text-decoration: none; }
        .telegram-info a:hover { text-decoration: underline; }

        /* --- ALARM PAGE STYLES (YENƒ∞LENDƒ∞) --- */
        #alarmsListContainer { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        .alarm-card { background-color: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; display: flex; flex-direction: column; justify-content: space-between; gap: 15px; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .alarm-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
        .alarm-card-header { display: flex; justify-content: space-between; align-items: center; width: 100%;}
        .alarm-card-title { font-size: 1.2rem; font-weight: 600; color: var(--text-primary); }
        .alarm-card-details { width: 100%; padding-top: 15px; border-top: 1px solid var(--border-color); }
        .coin-selection-display { display: flex; flex-wrap: wrap; gap: 6px; }
        .coin-tag-sm { background-color: var(--bg-primary); color: var(--text-secondary); padding: 3px 8px; border-radius: 10px; font-size: 0.8rem; }
        .alarm-card-actions { display: flex; align-items: center; gap: 5px; }
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #424651; transition: .4s; border-radius: 26px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-blue); }
        input:checked + .slider:before { transform: translateX(24px); }
        
        /* ALARM D√úZENLEME PANELƒ∞ (YENƒ∞LENDƒ∞) */
        .alarm-rule-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px 25px; align-items: center;}
        .alarm-rule-grid .filter-item { grid-column: 1 / -1; } /* Checkbox tam geni≈ülik */
        .alarm-rule-grid label { justify-self: start; }
        .alarm-rule-grid input, .alarm-rule-grid select { justify-self: end; width: 100px; }
        #alarmCoinSelectionGrid { display: flex; flex-wrap: wrap; gap: 8px; padding: 10px; background-color: var(--bg-primary); border-radius: 8px; margin-bottom: 15px; max-height: 120px; overflow-y: auto; }
        .coin-tag { background-color: var(--accent-blue); color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; }
        .coin-tag .remove-coin-tag { cursor: pointer; font-size: 1.1rem; line-height: 1; }
        
        /* BACKTEST & DURUM PANELƒ∞ */
        .status-table { width: 100%; margin-top: 15px; border-collapse: collapse; font-size: 0.9rem; }
        .status-table td { padding: 10px; border: 1px solid var(--border-color); text-align: right; }
        .status-table td:first-child { text-align: left; font-weight: 500; color: var(--text-secondary); }
        .backtest-results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 20px; }
        .backtest-card { background-color: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; }
        .backtest-card h5 { margin: 0 0 10px 0; color: var(--accent-yellow); }
        .backtest-card p { margin: 5px 0; color: var(--text-secondary); }
        .backtest-card .value { font-weight: bold; color: var(--text-primary); }
        #backtest-results-container { display: flex; flex-direction: column; gap: 20px; }


    @media (max-width: 768px) {
            th, td { padding: 12px 6px; font-size: 0.85rem; }
            .app-header .header-left h1 { font-size: 1.4rem; }
            .add-asset-bar { flex-direction: column; }
            .add-asset-bar button { width: 100%; }
            .pivot-values { font-size: 0.7rem; }
            .analysis-grid { grid-template-columns: 1fr; }
            #alarmsListContainer { grid-template-columns: 1fr; }
            .alarm-rule-grid { grid-template-columns: 1fr; }
            .alarm-rule-grid input, .alarm-rule-grid select { justify-self: start; }
            
            /* --- YENƒ∞ EKLENEN MOBƒ∞L UYUMLULUK KODU --- */
            #backtestPanel .backtest-results-grid {
                grid-template-columns: 1fr; /* Kartlarƒ± alt alta dizer */
            }
             #backtestPanel .backtest-card .backtest-results-grid {
                grid-template-columns: 1fr; /* ƒ∞√ß i√ße ge√ßmi≈ü gridleri de d√ºzeltir */
            }
        }
    /* --- YENƒ∞ EKLENEN KAPSAMLI MOBƒ∞L UYUMLULUK KODU --- */
        @media (max-width: 768px) {
            /* Madde 4: Genel sayfa kaymasƒ±nƒ± engellemek ve filtreleri d√ºzenlemek */
            .tracker-container {
                padding: 10px; /* Kenar bo≈üluklarƒ±nƒ± azalt */
            }
            .filters-grid, .pivot-filters, .interval-filters {
                grid-template-columns: 1fr 1fr; /* Filtreleri iki s√ºtuna indirge */
                gap: 10px;
            }
            .pivot-filters, .interval-filters {
                display: grid; /* Butonlarƒ±n daha d√ºzenli durmasƒ±nƒ± saƒülar */
            }
            
            /* ---- T√úM POP-UP PENCERELER ƒ∞√áƒ∞N GENEL KURAL ---- */
    /* --- Nƒ∞HAƒ∞ VE G√ú√áL√ú MOBƒ∞L UYUMLULUK KODU --- */
        @media (max-width: 768px) {
            /* T√ºm pop-up pencereler i√ßin genel kural */
            .panel {
                width: 95vw !important;
                max-width: 95vw !important;
                padding: 0 !important;
            }
            .panel-header {
                padding: 12px 15px !important;
            }
            .panel-content {
                padding: 15px !important;
            }

            /* Madde 4: AI Yorumlama Pop-up'ƒ± (#analysisPanel) */
            #analysisPanel .analysis-grid {
                grid-template-columns: 1fr !important; /* Tek s√ºtuna indirge */
            }

            /* Madde 6: Backtest sonu√ßlarƒ± Pop-up'ƒ± (#backtestPanel) */
            #backtestPanel .backtest-results-grid {
                grid-template-columns: 1fr !important; /* Kartlarƒ± alt alta diz */
            }
            #backtestPanel .backtest-card .backtest-results-grid {
                grid-template-columns: 1fr !important;
            }
            #backtestPanel .backtest-card {
                padding: 10px;
            }

            /* Madde 10: Alarm durumu Pop-up'ƒ± (#alarmStatusPanel) */
            #alarmStatusPanel .status-table td {
                white-space: normal !important; /* Yazƒ±larƒ±n alt satƒ±ra kaymasƒ±nƒ± saƒüla */
                word-break: break-word !important; /* Uzun kelimeleri kƒ±r */
            }
        }
            /* --- AI Analiz Paneli Tasarƒ±m G√ºncellemesi --- */
        #analysisPanel .panel-content {
            max-height: 80vh; /* Panelin y√ºksekliƒüini ekranƒ±n %80'i ile sƒ±nƒ±rla */
            overflow-y: auto; /* Y√ºkseklik a≈üƒ±lƒ±rsa kaydƒ±rma √ßubuƒüu ekle */
        }
        
        /* Masa√ºst√º i√ßin √ßoklu s√ºtun g√∂r√ºn√ºm√º (ekran 768px'den b√ºy√ºkse) */
        @media (min-width: 769px) {
            #analysisPanel .panel-content {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); /* Esnek s√ºtunlar */
                gap: 20px;
            }
        }
     
       
    </style>
</head>
<body>
    
    <div id="app-loader" class="page" style="justify-content: center; align-items: center; display: flex;">
        <div class="loading" style="width: 40px; height: 40px; border-width: 4px;"></div>
    </div>

    <div id="login-page" class="page" style="display: none;">
        <div class="login-container">
            <h1><i class="fas fa-chart-line"></i> Fiyat Takip√ßisi</h1>
            <p data-lang="login_prompt">Devam etmek i√ßin giri≈ü yapƒ±n veya yeni hesap olu≈üturun.</p>
            <div class="input-group"><label for="email" data-lang="email">E-posta</label><input type="email" id="email" autocomplete="email"></div>
            <div class="input-group"><label for="password" data-lang="password">≈ûifre</label><input type="password" id="password" autocomplete="current-password"></div>
            <div id="error-message"></div>
            <div class="button-group">
                <button id="loginBtn" data-lang="login">Giri≈ü Yap</button>
                <button id="signupBtn" data-lang="signup" style="background-color: #373c4a;">Kayƒ±t Ol</button>
            </div>
        </div>
    </div>

    <div id="tracker-page" class="page" style="display: none;">
        <div class="tracker-container">
            <header class="app-header">
                 <div class="header-left"><h1><i class="fas fa-chart-line"></i> <span data-lang="app_title">Fiyat Takip√ßisi</span></h1></div>
                <div class="header-right">
                    <div class="main-actions">
                        <button id="refreshBtn" title="Yenile"><i class="fas fa-sync-alt"></i></button>
                        <button id="settingsBtn" title="Ayarlar"><i class="fas fa-cog"></i></button>
                    </div>
                    <div class="user-menu">
                        <button id="userMenuBtn"><i class="fas fa-user-circle"></i> <span id="userEmail"></span></button>
                        <div class="dropdown-content">
                            <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> <span data-lang="logout">√áƒ±kƒ±≈ü Yap</span></a>
                        </div>
                    </div>
                </div>
            </header>

            <div class="tabs">
                <div class="tab-link active" data-tab="crypto">Kripto</div>
                <div class="tab-link" data-tab="crypto-ai">Kripto AI</div>
                <div class="tab-link" data-tab="crypto-pivot">AI Pivot</div>
                <div class="tab-link" data-tab="alarms" id="alarms-tab" style="display: none;">Alarmlar</div>
            </div>

            <div id="crypto-content" class="tab-content active">
                 <div class="app-header" style="border-bottom: none; padding-bottom: 0; margin-bottom: 10px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label for="portfolioSelect" style="color: var(--text-secondary);">Aktif Liste:</label>
                        <select id="portfolioSelect" class="setting-item" style="margin-bottom: 0;"></select>
                    </div>
                    <div class="header-right">
                        <button id="renamePortfolioBtn" class="table-controls button" style="background-color: var(--bg-tertiary);"><i class="fas fa-edit"></i> Yeniden Adlandƒ±r</button>
                        <button id="newPortfolioBtn" class="table-controls button"><i class="fas fa-plus"></i> Yeni Liste</button>
                        <button id="deletePortfolioBtn" class="table-controls button" style="background-color: var(--accent-red);"><i class="fas fa-trash"></i> Listeyi Sil</button>
                    </div>
                </div>
                 <div class="add-asset-bar">
                    <input type="text" id="newCoinInput" placeholder="BTC, ETH, SOL...">
                    <button id="addCoinBtn"><i class="fas fa-plus"></i> <span data-lang="add">Ekle</span></button>
                </div>
                <div class="table-controls">
                    <button id="toggleSortBtn"><i class="fas fa-sort"></i> Sƒ±rala</button>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th class="drag-handle-col hidden"><i class="fas fa-grip-lines"></i></th>
                                <th class="sortable" data-sort-key="pair"><span data-lang="coin">Coin</span><span class="sort-indicator"></span></th>
                                <th class="sortable" data-sort-key="latestPrice"><span data-lang="price">Fiyat</span><span class="sort-indicator"></span></th>
                                <th id="col1_header_crypto" class="sortable" data-sort-key="col1"></th>
                                <th id="col2_header_crypto" class="sortable" data-sort-key="col2"></th>
                                <th id="col3_header_crypto" class="sortable" data-sort-key="col3"></th>
                                <th data-lang="delete">Sil</th>
                            </tr>
                        </thead>
                        <tbody id="cryptoPriceTable"></tbody>
                    </table>
                </div>
            </div>

            <div id="crypto-ai-content" class="tab-content">
                <div class="add-asset-bar">
                    <input type="text" id="newCoinInput-ai" placeholder="AI Analizi i√ßin coin ekleyin: BTC, ETH, SOL...">
                    <button id="addCoinBtn-ai"><i class="fas fa-plus"></i> <span data-lang="add">Ekle</span></button>
                </div>
                <div class="table-controls">
                    <button id="toggleSortBtn-ai"><i class="fas fa-sort"></i> Sƒ±rala</button>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th class="drag-handle-col hidden"><i class="fas fa-grip-lines"></i></th>
                                <th><span data-lang="coin">Coin</span></th>
                                <th>Fiyat</th>
                                <th>Tavsiye</th>
                                <th>√ñzet</th>
                                <th data-lang="delete">Sil</th>
                            </tr>
                        </thead>
                        <tbody id="cryptoAiPriceTable"></tbody> </table>
                </div>

                <hr style="border-color: var(--border-color); margin: 25px 0;">

                <div class="collapsible">
                    <div class="collapsible-header open"><span>Analiz Filtreleri</span><i class="fas fa-chevron-down"></i></div>
                    <div class="collapsible-content open">
                        <div class="settings-section">
                            <h4>1. Analiz Zaman Dilimi</h4>
                            <div class="interval-filters" id="cryptoIntervalFilters">
                                 <button class="interval-btn" data-interval="1h">1 Saat</button>
                                 <button class="interval-btn active" data-interval="4h">4 Saat</button>
                                 <button class="interval-btn" data-interval="1d">1 G√ºn</button>
                            </div>
                        </div>
                        <div class="settings-section">
                            <h4>2. Analiz Stratejisi Se√ßin</h4>
                             <div class="pivot-filters" id="strategyPresetFilters">
                                <button class="strategy-btn" data-preset="momentum" title="Kƒ±sa vadeli fiyat hareketlerinden faydalanƒ±r. (RSI, StochRSI, MACD)">‚ö° Momentum</button>
                                <button class="strategy-btn" data-preset="trend" title="Piyasanƒ±n genel y√∂n√ºn√º takip eder. (EMA, SMA, Ichimoku)">üåä Trend Takibi</button>
                                <button class="strategy-btn" data-preset="volatility" title="Fiyat sƒ±kƒ±≈ümalarƒ±nƒ± ve patlamalarƒ±nƒ± arar. (Bollinger, ATR)">üí• Volatilite</button>
                                <button class="strategy-btn active" data-preset="all" title="T√ºm temel indikat√∂rleri kullanƒ±r.">üåê Genel Bakƒ±≈ü</button>
                                <button class="strategy-btn" data-preset="custom" title="A≈üaƒüƒ±dan kendi indikat√∂rlerinizi se√ßin.">‚öôÔ∏è √ñzel</button>
                            </div>
                        </div>
                        <div class="settings-section" id="customIndicatorSection" style="display:none;">
                            <h4>3. √ñzel ƒ∞ndikat√∂r Se√ßimi</h4>
                            <div id="crypto-indicator-filters-grid" class="filters-grid"></div>
                        </div>
                         <div class="analysis-actions">
                            <button id="updateCryptoAnalysisBtn"><i class="fas fa-check"></i> Analizi G√ºncelle</button>
                        </div>
                    </div>
                </div>
                <div class="global-analysis-header">
                    <h3>Otomatik Analiz Sonu√ßlarƒ±</h3>
                    <div class="global-analysis-controls">
                         <div class="pivot-filters" id="cryptoRecommendationFilters">
                            <button class="active" data-filter="all">T√ºm√º</button>
                            <button data-filter="buy">Al</button>
                            <button data-filter="sell">Sat</button>
                            <button data-filter="hold">Tut</button>
                        </div>
                        <button id="analyzeAllCryptoBtn" class="ai-btn" title="T√ºm listeyi Gemini ile yorumla"><i class="fas fa-magic-sparkles"></i> Toplu Yorumla</button>
                    </div>
                </div>
                <div id="crypto-indicator-cards-container" class="indicator-cards-container"></div>
                 <div class="collapsible" style="margin-top: 30px;">
                    <div class="collapsible-header">
                        <span>ƒ∞ndikat√∂r S√∂zl√ºƒü√º</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="collapsible-content" id="dictionaryContent"></div>
                </div>
            </div>

            <div id="crypto-pivot-content" class="tab-content">
                <div class="pivot-filters" id="cryptoPivotFilters">
                    <button class="active" data-filter="all">T√ºm√º</button>
                    <button data-filter="above">Pivot √úst√º</button>
                    <button data-filter="below">Pivot Altƒ±</button>
                </div>
                <div id="crypto-pivot-container" class="pivot-container"></div>
                 <div id="pivot-dictionary-container"></div>
            </div>

            <div id="alarms-content" class="tab-content">
                <div class="collapsible" style="margin-bottom: 25px;">
                    <div class="collapsible-header">
                        <span>‚öôÔ∏è Strateji Ke≈üif Aracƒ± (Sinyal Analizi)</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="collapsible-content">
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0;">
                            Ge√ßmi≈ü verileri analiz ederek en k√¢rlƒ± alarm ko≈üullarƒ±nƒ± bulun. 
                            √ñrn: "BTC, son 1 ayda %5 arttƒ±ƒüƒ± anlarda hangi ko≈üullar ortaktƒ±?"
                        </p>
                        <div class="settings-section">
                            <div class="setting-item">
                                <label for="signalAnalysisCoins">Analiz Edilecek Coin(ler)</label>
                                <input type="text" id="signalAnalysisCoins" placeholder="BTC, ETH, SOL... (virg√ºlle ayƒ±rƒ±n)">
                            </div>
                            <div class="alarm-rule-grid">
                                <label for="signalAnalysisTimeframe">Zaman Dilimi</label>
                                <select id="signalAnalysisTimeframe">
                                    <option value="15m">15 Dakika</option>
                                    <option value="1h" selected>1 Saat</option>
                                    <option value="4h">4 Saat</option>
                                    <option value="1d">1 G√ºn</option>
                                </select>

                                <label for="signalAnalysisChange">Fiyat Deƒüi≈üimi E≈üiƒüi (%)</label>
                                <input type="number" id="signalAnalysisChange" value="5" step="1">
                                
                                <label for="signalAnalysisDirection">Deƒüi≈üim Y√∂n√º</label>
                                <select id="signalAnalysisDirection">
                                    <option value="up">Artƒ±≈ü (+%)</option>
                                    <option value="down">Azalƒ±≈ü (-%)</option>
                                </select>

                                <label for="signalAnalysisPeriod">Ge√ßmi≈ü Veri Periyodu</label>
                                 <select id="signalAnalysisPeriod">
                                    <option value="7">Son 1 Hafta</option>
                                    <option value="30" selected>Son 1 Ay</option>
                                    <option value="90">Son 3 Ay</option>
                                </select>
                            </div>
                        </div>
                        <div class="analysis-actions">
                            <button id="runSignalAnalysisBtn"><i class="fas fa-search-dollar"></i> Analizi Ba≈ülat</button>
                        </div>
                        <div id="signalAnalysisResultContainer" style="margin-top: 20px;">
                            </div>
                    </div>
                </div>

                <div class="add-asset-bar">
                    <button id="createNewAlarmBtn" style="width: 100%; justify-content: center;"><i class="fas fa-plus"></i> Yeni Alarm Olu≈ütur</button>
                </div>
                <div id="alarmsListContainer">
                </div>
            </div>

            <div class="update-time"><i class="far fa-clock"></i>&nbsp;<span data-lang="last_update">Son g√ºncelleme</span>: <span id="updateTime"></span></div>
        </div>
    </div>

    <div id="settingsPanel" class="panel">
        <div class="panel-header">
            <h3 data-lang="settings">Ayarlar</h3>
            <div class="panel-controls"><button class="panel-btn close-btn"><i class="fas fa-times"></i></button></div>
        </div>
        <div class="panel-content">
            <div class="settings-section">
                <h4 data-lang="general_settings">Genel Ayarlar</h4>
                <div class="setting-item"><label data-lang="language">Dil</label><select id="langSelect"><option value="tr">T√ºrk√ße</option><option value="en">English</option></select></div>
                <div class="setting-item"><label data-lang="auto_refresh">Otomatik Yenileme</label><input type="checkbox" id="autoRefreshToggle"></div>
                <div class="setting-item"><label data-lang="refresh_interval">Yenileme Aralƒ±ƒüƒ± (sn)</label><input type="number" id="refreshInterval" min="10" step="10"></div>
                <div class="setting-item"><label>Telegram Chat ID</label><input type="text" id="telegramPhoneInput" placeholder="123456789"></div>
                <div class="telegram-info">
                    Telegram bildirimlerini almak i√ßin:
                    <ol style="padding-left: 20px; margin-top: 5px; margin-bottom: 0;">
                        <li>Telegram'da <a href="https://t.me/fiyattakipv3_bot" target="_blank" rel="noopener noreferrer"><b>fiyattakipv3_bot</b></a>'u bulun.</li>
                        <li>Bota <code>/start</code> komutunu g√∂nderin.</li>
                        <li>Botun size verdiƒüi ID numarasƒ±nƒ± yukarƒ±daki kutucuƒüa yapƒ±≈ütƒ±rƒ±n.</li>
                    </ol>
                </div>
            </div>
            <div class="settings-section">
                <h4 data-lang="column_settings">Kolon Ayarlarƒ±</h4>
                <div class="setting-item"><label>Kolon 1 Adƒ±</label><input type="text" id="col1_name_input"></div>
                <div class="setting-item"><label>G√ºn Sayƒ±sƒ±</label><input type="number" id="col1_days_input" min="1"></div>
                <div class="setting-item"><label>Pozitif E≈üik (%)</label><input type="number" id="col1_threshold_input" min="0"></div><hr>
                <div class="setting-item"><label>Kolon 2 Adƒ±</label><input type="text" id="col2_name_input"></div>
                <div class="setting-item"><label>G√ºn Sayƒ±sƒ±</label><input type="number" id="col2_days_input" min="1"></div>
                <div class="setting-item"><label>Pozitif E≈üik (%)</label><input type="number" id="col2_threshold_input" min="0"></div><hr>
                <div class="setting-item"><label>Kolon 3 Adƒ±</label><input type="text" id="col3_name_input"></div>
                <div class="setting-item"><label>G√ºn Sayƒ±sƒ±</label><input type="number" id="col3_days_input" min="1"></div>
                <div class="setting-item"><label>Pozitif E≈üik (%)</label><input type="number" id="col3_threshold_input" min="0"></div>
            </div>
            <div class="settings-section">
                <h4 data-lang="color_settings">Renk Ayarlarƒ±</h4>
                <div class="setting-item"><label data-lang="high_positive_color">Y√ºksek Pozitif Renk</label><div class="color-input-wrapper"><input type="color" id="high_color_input"><span class="color-preview" id="high_color_preview"></span></div></div>
                <div class="setting-item"><label data-lang="low_positive_color">D√º≈ü√ºk Pozitif Renk</label><div class="color-input-wrapper"><input type="color" id="low_color_input"><span class="color-preview" id="low_color_preview"></span></div></div>
            </div>
            <button id="saveSettingsBtn" data-lang="save_settings">Ayarlarƒ± Kaydet</button>
        </div>
    </div>

    <div id="detailPanel" class="panel">
         <div class="panel-header">
            <h3 id="detailPanelTitle"></h3>
             <div class="panel-controls"><button class="panel-btn close-btn"><i class="fas fa-times"></i></button></div>
        </div>
        <div class="panel-content" id="detailPanelContent"></div>
    </div>

    <div id="chartPanel" class="panel">
        <div class="panel-header">
            <h3 id="chartPanelTitle"></h3>
            <div class="panel-controls"><button class="panel-btn close-btn" title="Kapat"><i class="fas fa-times"></i></button></div>
        </div>
        <div id="chartContainer"></div>
    </div>

    <div id="analysisPanel" class="panel">
        <div class="panel-header">
            <h3>AI Analizi</h3>
            <div class="panel-controls"><button class="panel-btn close-btn" title="Kapat"><i class="fas fa-times"></i></button></div>
        </div>
        <div id="analysisContent" class="panel-content"></div>
    </div>

<div id="alarmSettingsPanel" class="panel">
    <div class="panel-header">
        <h3 id="alarmPanelTitle">Alarm Kurallarƒ±</h3>
        <div class="panel-controls"><button class="panel-btn close-btn"><i class="fas fa-times"></i></button></div>
    </div>
    <div class="panel-content">
        <input type="hidden" id="alarmIdInput">
        
        <div class="collapsible">
            <div class="collapsible-header open"><span>1. Genel Ayarlar</span><i class="fas fa-chevron-down"></i></div>
            <div class="collapsible-content open">
                <div class="setting-item">
                    <label for="alarmNameInput">Alarm Adƒ±</label>
                    <input type="text" id="alarmNameInput" placeholder="√ñrn: Hacim Patlamasƒ± Alarmƒ±">
                </div>
                <div class="setting-item">
                    <label for="alarmTimeframe">Ana Zaman Dilimi</label>
                    <select id="alarmTimeframe">
                        <option value="15m" selected>15 Dakika</option>
                        <option value="1h">1 Saat</option>
                        <option value="4h">4 Saat</option>
                    </select>
                </div>
                <h5 style="margin-top: 20px; margin-bottom: 10px;">Uygulanacak Coinler</h5>
                <div id="alarmCoinSelectionGrid"></div>
                <div class="add-asset-bar" style="margin-top: 10px; margin-bottom: 0;">
                    <input type="text" id="addCoinToAlarmInput" placeholder="BTC, ETH, HOOK...">
                    <button id="addCoinToAlarmBtn" style="padding: 8px 16px;"><i class="fas fa-plus"></i></button>
                </div>
            </div>
        </div>

        <div class="collapsible">
            <div class="collapsible-header open"><span>2. Alarm Ko≈üullarƒ± (En az 1 tane se√ßin)</span><i class="fas fa-chevron-down"></i></div>
            <div class="collapsible-content open">
                <div class="settings-section" style="padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;">
                    <label class="filter-item">
                        <input type="checkbox" id="alarmVolumeCondition" checked>
                        <span>Hacim Artƒ±≈üƒ±</span>
                    </label>
                    <div class="alarm-rule-grid" style="margin-top: 10px;">
                        <label>Ort. Hacim Mumu Sayƒ±sƒ±</label>
                        <input type="number" id="alarmVolumePeriod" value="20" min="2" step="1">
                        <label>Son Mum Hacmi > Ortalama *</label>
                        <input type="number" id="alarmVolumeMultiplier" value="2" step="0.5">
                        <label title="Opsiyonel. Sadece hacim bu dolar tutarƒ±nƒ± ge√ßerse sinyal g√∂nder. √ñrn: 500000">Min. Hacim Tutarƒ± ($)</label>
                        <input type="number" id="alarmVolumeAmount" value="0" step="100000" min="0">
                    </div>
                </div>
                <div class="settings-section" style="margin-top: 15px; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;">
                    <label class="filter-item">
                        <input type="checkbox" id="alarmMacdCondition" checked>
                        <span>MACD Kesi≈üimi</span>
                    </label>
                    <div class="alarm-rule-grid" style="margin-top: 10px;">
                        <label>Sinyal Tipi</label>
                        <select id="alarmMacdSignalType">
                            <option value="buy">Al (Yukarƒ± Kesi≈üim)</option>
                            <option value="sell">Sat (A≈üaƒüƒ± Kesi≈üim)</option>
                        </select>
                    </div>
                </div>
                 <input type="checkbox" id="alarmPriceCondition" style="display: none;">
            </div>
        </div>
         <div>
            <h5 style="margin-top: 20px; margin-bottom: 15px; color: var(--text-secondary);">3. Geli≈ümi≈ü Filtreler (Opsiyonel)</h5>
            <div>
                <div style="padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 15px;">
                     <label class="filter-item" title="Sinyalin sadece piyasada belirli bir g√º√ßte trend varken √ßalƒ±≈ümasƒ±nƒ± saƒülar. Kararsƒ±z piyasalardaki hatalƒ± sinyalleri filtreler.">
                        <input type="checkbox" id="alarmTrendFilterEnabled">
                        <span>G√º√ßl√º Trend Filtresini Aktif Et</span>
                    </label>
                    <div class="alarm-rule-grid" style="margin-top: 10px;">
                       <label for="alarmADXThreshold" title="Trendin ne kadar g√º√ßl√º olduƒüunu belirtir. 25'in √ºzeri genellikle g√º√ßl√º bir trend olarak kabul edilir.">Trend G√ºc√º (ADX) E≈üiƒüi</label>
                       <input type="number" id="alarmADXThreshold" min="0" max="50" value="25">
                    </div>
                </div>
                <div style="padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;">
                    <label class="filter-item" title="Sinyalin sadece fiyat √∂nemli bir Fibonacci destek seviyesinin √ºzerindeyken √ßalƒ±≈ümasƒ±nƒ± saƒülar. Bu, genellikle bir d√º≈ü√º≈ü√ºn son bulduƒüuna ve y√ºkseli≈üin devam edebileceƒüine dair bir i≈üarettir.">
                        <input type="checkbox" id="alarmFibCondition">
                        <span>Fibonacci 0.618 Desteƒüini Onayla</span>
                    </label>
                </div>
            </div>
        </div>

        <div class="pivot-dictionary" style="font-size: 0.85rem; line-height: 1.6; margin-top: 20px;">
            <h5><i class="fas fa-info-circle"></i> Filtre A√ßƒ±klamalarƒ±</h5>
            <p><strong>Hacim Artƒ±≈üƒ±:</strong> Belirlenen periyottaki (√∂rn: son 20 mum) ortalama i≈ülem hacminin, belirlediƒüiniz kat kadar (√∂rn: 2 kat) √ºzerine √ßƒ±kan ani hacim patlamalarƒ±nƒ± yakalar. G√º√ßl√º bir hareketin ba≈ülangƒ±cƒ± olabilir.</p>
            <p><strong>MACD Kesi≈üimi:</strong> ƒ∞ki hareketli ortalama arasƒ±ndaki ili≈ükiyi √∂l√ßer. "Al" sinyali, momentumun pozitife d√∂nd√ºƒü√ºn√º; "Sat" sinyali ise negatife d√∂nd√ºƒü√ºn√º g√∂sterir. Trend d√∂n√º≈ülerini yakalamak i√ßin kullanƒ±lƒ±r.</p>
            <p><strong>G√º√ßl√º Trend Filtresi (ADX):</strong> Piyasanƒ±n y√∂nl√º bir trend i√ßinde olup olmadƒ±ƒüƒ±nƒ± (yatay ve kararsƒ±z olmadƒ±ƒüƒ±nƒ±) kontrol eder. ADX deƒüeri ne kadar y√ºksekse, trend o kadar g√º√ßl√ºd√ºr. Bu filtre, kararsƒ±z piyasadaki hatalƒ± sinyalleri engellemeye yardƒ±mcƒ± olur.</p>
            <p><strong>Fibonacci 0.618 Desteƒüini Onayla:</strong> Fibonacci analizinde 0.618 seviyesi, bir d√º≈ü√º≈ü√ºn son bulabileceƒüi ve y√ºkseli≈üin devam edebileceƒüi "altƒ±n oran" olarak kabul edilen √ßok g√º√ßl√º bir destek seviyesidir. Bu filtre, sinyalin bu kritik desteƒüin √ºzerinde gelmesini saƒülayarak d√º≈ü√º≈ü riskini azaltƒ±r.</p>
         </div>
         <div class="button-group" style="margin-top:20px;">
            <button id="testAlarmBtn" style="background-color: #373c4a;"><i class="fab fa-telegram-plane"></i> Test Et</button>
            <button id="saveAlarmBtn"><i class="fas fa-save"></i> Kaydet</button>
         </div>
    </div>
</div>

    <div id="alarmStatusPanel" class="panel" style="width: clamp(500px, 90vw, 800px);">
        <div class="panel-header">
            <h3 id="alarmStatusTitle">Alarm Durumu</h3>
            <div class="panel-controls"><button class="panel-btn close-btn"><i class="fas fa-times"></i></button></div>
        </div>
        <div class="panel-content" id="alarmStatusContent"></div>
    </div>

    <div id="backtestPanel" class="panel" style="width: clamp(500px, 90vw, 900px);">
        <div class="panel-header">
            <h3>Backtest Sonu√ßlarƒ±</h3>
            <div class="panel-controls"><button class="panel-btn close-btn"><i class="fas fa-times"></i></button></div>
        </div>
        <div class="panel-content">
            <h4 id="backtestAlarmName"></h4>
            <p>Bu panel, se√ßilen alarm stratejisinin ge√ßmi≈ü <strong>1000 mum (yakla≈üƒ±k 10 g√ºn)</strong> √ºzerindeki performansƒ±nƒ± her bir coin i√ßin ayrƒ± ayrƒ± g√∂sterir. Sonu√ßlar, sinyal geldikten <strong>15 dakika ve 1 saat sonraki</strong> fiyat deƒüi≈üimlerine dayanmaktadƒ±r.</p>
            <div id="backtest-results-container">
                <div style="text-align: center; padding: 20px;"><div class="loading"></div></div>
            </div>
        </div>
    </div>


    <div id="modalOverlay" class="modal-overlay"></div>
    <div class="notification" id="notification"></div>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyA3flTu3Jz9E1D1U_DympYE7B4I4FDxj88",
        authDomain: "fiyattakipv3.firebaseapp.com",
        projectId: "fiyattakipv3",
        storageBucket: "fiyattakipv3.firebasestorage.app",
        messagingSenderId: "440839843277",
        appId: "1:440839843277:web:2c9c15e4a103e8b2f2e884"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const functions = firebase.app().functions('europe-west1');

    // --- GLOBAL STATE ---
    const STRATEGY_PRESETS = {
        momentum: { rsi: true, stochRsi: true, macd: true, volume: true },
        trend: { ema: true, sma: true, ichimoku: true, macd: true },
        volatility: { bollinger: true, atr: true, volume: true },
        all: { rsi: true, macd: true, ema: true, bollinger: true, fibonacci: true },
        custom: {}
    };
    let currentUserRole = null, coinLimit = 10, settings = {}, autoRefreshTimer = null, pageInitialized = false;
    let allCryptoData = [], userAlarms = [];
    let currentSort = { key: null, order: 'default' };
    let userPortfolios = {}; 
    let activePortfolio = 'Varsayƒ±lan';
    let cryptoAiPairs = [];
    let userDocRef = null;
    let sortableInstance = null;
    let sortableInstanceAi = null;
    let currentRecommendationFilter = 'all';
    let tempAlarmCoins = [];
    const notification = document.getElementById("notification"), modalOverlay = document.getElementById('modalOverlay');
    const appLoader = document.getElementById('app-loader');
    const loginPage = document.getElementById('login-page');
    const trackerPage = document.getElementById('tracker-page');
    const AVAILABLE_INDICATORS = { ema: "EMA", sma: "SMA", rsi: "RSI", macd: "MACD", bollinger: "Bollinger Bands", stochRsi: "Stochastic RSI", volume: "Hacim (24s)", atr: "ATR", ichimoku: "Ichimoku Cloud", fibonacci: "Fibonacci" };
    
    const translations = { 
        tr: { 
            login_prompt: "Devam etmek i√ßin giri≈ü yapƒ±n veya yeni hesap olu≈üturun.", email: "E-posta", password: "≈ûifre", login: "Giri≈ü Yap", signup: "Kayƒ±t Ol", logout: "√áƒ±kƒ±≈ü Yap", app_title: "Fiyat Takip√ßisi", add: "Ekle", refresh: "Yenile", settings: "Ayarlar", coin: "Coin", price: "Fiyat", delete: "Sil", last_update: "Son g√ºncelleme", color_rules: "Renk Kurallarƒ±", general_settings: "Genel Ayarlar", language: "Dil", auto_refresh: "Otomatik Yenileme", refresh_interval: "Yenileme Aralƒ±ƒüƒ± (sn)", column_settings: "Kolon Ayarlarƒ±", positive_threshold: "Pozitif E≈üik (%)", color_settings: "Renk Ayarlarƒ±", high_positive_color: "Y√ºksek Pozitif Renk", low_positive_color: "D√º≈ü√ºk Pozitif Renk", save_settings: "Ayarlarƒ± Kaydet", saved: "Kaydedildi!", settings_saved: "Ayarlar ba≈üarƒ±yla kaydedildi.", analysis_updated: "Analiz ba≈üarƒ±yla g√ºncellendi.", limit_exceeded: "Limit a≈üƒ±ldƒ±!", 
            role_info: (role, limit, type) => `Rol√ºn√ºz (${role}) en fazla ${limit} ${type} eklemeye izin veriyor.`, 
            invalid_asset: (asset) => `Ge√ßersiz varlƒ±k: ${asset}`, 
            already_in_list: (asset) => `${asset} zaten listede.`, 
            lowest_price_detail: (period, lowestPrice, lowestDate, currentPrice, pctChange) => `
                <div style="line-height: 1.8; font-size: 0.95rem;">
                    <p style="border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 10px;"><strong>${period} periyodundaki analiz:</strong></p>
                    <p>Bu d√∂nemdeki en d√º≈ü√ºk fiyat: <strong style="color: var(--accent-yellow);">${lowestPrice}</strong><br><small>(Tarih: ${lowestDate})</small></p>
                    <p>Mevcut Fiyat: <strong style="color: var(--accent-blue);">${currentPrice}</strong></p>
                    <hr style="border-color: var(--border-color); margin: 15px 0;">
                    <p>Hesaplanan Deƒüi≈üim: <strong style="font-size: 1.2rem; color: ${pctChange > 0 ? 'var(--accent-green)' : 'var(--accent-red)'};">${pctChange}%</strong></p>
                </div>
            `,
            no_data: "Veri yok" 
        }, 
        en: {} 
    };

    function getDefaultSettings() {
        return {
            lang: 'tr', autoRefresh: false, refreshInterval: 300,
            telegramPhone: '',
            columns: { 1: { name: '1G', days: 1, threshold: 2 }, 2: { name: '7G', days: 7, threshold: 5 }, 3: { name: '30G', days: 30, threshold: 10 } },
            colors: { high: '#26a69a', low: '#f59e0b' },
            cryptoPivotFilter: 'all',
            cryptoAnalysisInterval: '4h',
            cryptoAnalysisIndicators: { ema: true, rsi: true, macd: true, bollinger: true, volume: false, sma: false, stochRsi: false, atr: false, ichimoku: false, fibonacci: false }
        };
    }

    function translatePage(lang) { document.querySelectorAll('[data-lang]').forEach(el => { const key = el.getAttribute('data-lang'); if (translations[lang]?.[key] && typeof translations[lang][key] === 'string') el.textContent = translations[lang][key]; }); }
    
    function showPage(pageId) {
        appLoader.style.display = 'none';
        loginPage.style.display = 'none';
        trackerPage.style.display = 'none';
        if (pageId) {
            const page = document.getElementById(pageId);
            if(page) page.style.display = 'flex';
        }
    }

    function showPanel(panelId) { document.getElementById(panelId).classList.add('show'); modalOverlay.classList.add('show'); document.body.classList.add('modal-open'); }
    function closeAllPanels() { document.querySelectorAll('.panel.show').forEach(p => p.classList.remove('show')); modalOverlay.classList.remove('show'); document.body.classList.remove('modal-open'); }
    function showNotification(message, isSuccess = true) { notification.textContent = message; notification.style.backgroundColor = isSuccess ? 'var(--accent-green)' : 'var(--accent-red)'; notification.classList.add('show'); setTimeout(() => notification.classList.remove('show'), 3000); }

    function showLoading(button) { button.dataset.originalHtml = button.innerHTML; button.innerHTML = '<div class="loading"></div>'; button.disabled = true; }
    function hideLoading(button) { if (button.dataset.originalHtml) { button.innerHTML = button.dataset.originalHtml; } button.disabled = false; }

    function loadSettings(userData) {
        const defaultSettings = getDefaultSettings();
        settings = { ...defaultSettings, ...userData.settings };
        settings.columns = { ...defaultSettings.columns, ...(userData.settings?.columns || {}) };
        settings.colors = { ...defaultSettings.colors, ...(userData.settings?.colors || {}) };
        settings.cryptoAnalysisIndicators = { ...defaultSettings.cryptoAnalysisIndicators, ...(userData.settings?.cryptoAnalysisIndicators || {}) };
    }

    document.getElementById('loginBtn').addEventListener('click', () => auth.signInWithEmailAndPassword(document.getElementById("email").value, document.getElementById("password").value).catch(err => document.getElementById("error-message").textContent = err.message));
    document.getElementById('signupBtn').addEventListener('click', () => auth.createUserWithEmailAndPassword(document.getElementById("email").value, document.getElementById("password").value).catch(err => document.getElementById("error-message").textContent = err.message));
    
    auth.onAuthStateChanged(async user => {
        if (user) {
            userDocRef = db.collection('users').doc(user.uid);
            try {
                const doc = await userDocRef.get();
                let userData = doc.data();
                if (!doc.exists) {
                    userData = { 
                        email: user.email, 
                        role: 'new_user', 
                        portfolios: { "Varsayƒ±lan": ["BTCUSDT", "ETHUSDT", "SOLUSDT"] },
                        activePortfolio: "Varsayƒ±lan",
                        coins_ai: ["BTCUSDT", "ETHUSDT", "SOLUSDT"],
                        settings: getDefaultSettings(), 
                        alarms: [] 
                    };
                    await userDocRef.set(userData);
                }
                
                setRoleAndLimits(userData.role);
                userAlarms = userData.alarms || [];

                if (!pageInitialized) {
                    await initializeTrackerPage(userData);
                }
                showPage('tracker-page');

            } catch (err) {
                console.error("Auth/Firestore Error:", err);
                if (err.code === 'permission-denied') { document.getElementById("error-message").textContent = "Firestore yetki hatasƒ±. L√ºtfen veritabanƒ± kurallarƒ±nƒ±zƒ± kontrol edin."; }
                auth.signOut();
            }
        } else {
            showPage('login-page');
            pageInitialized = false;
            userDocRef = null;
            if(autoRefreshTimer) clearInterval(autoRefreshTimer);
        }
    });

    function setRoleAndLimits(role) {
        currentUserRole = role;
        const limits = { admin: {coin: Infinity}, qualified: {coin: 20}, new_user: {coin: 10} };
        coinLimit = limits[currentUserRole]?.coin ?? 10;
        document.getElementById('userEmail').textContent = auth.currentUser.email;
        updateAdminUI();
    }

    function updateAdminUI() {
        const isAdmin = currentUserRole === 'admin';
        document.getElementById('analyzeAllCryptoBtn').style.display = isAdmin ? 'flex' : 'none';
        document.getElementById('alarms-tab').style.display = isAdmin ? 'block' : 'none';
    }
    
    async function initializeTrackerPage(userData) {
        pageInitialized = true;
        
        loadSettings(userData);
        
        if (userData.portfolios && Object.keys(userData.portfolios).length > 0) {
            userPortfolios = userData.portfolios;
            activePortfolio = userData.activePortfolio || Object.keys(userPortfolios)[0];
        } else {
            userPortfolios = { "Varsayƒ±lan": ["BTCUSDT", "ETHUSDT", "SOLUSDT"] };
            activePortfolio = "Varsayƒ±lan";
        }
        cryptoAiPairs = userData.coins_ai || ["BTCUSDT", "ETHUSDT", "SOLUSDT", "BNBUSDT", "XRPUSDT"];

        const formatPrice = (price) => {
            const num = parseFloat(price);
            if (isNaN(num)) return 'N/A';
            if (num < 0.001) return num.toFixed(8);
            if (num < 1) return num.toFixed(6);
            if (num < 10) return num.toFixed(4);
            return num.toFixed(2);
        };
        const formatVolume = (volume) => { const num = parseFloat(volume); if (isNaN(num)) return 'N/A'; if (num >= 1_000_000_000) return `${(num / 1_000_000_000).toFixed(2)}B`; if (num >= 1_000_000) return `${(num / 1_000_000).toFixed(2)}M`; if (num >= 1_000) return `${(num / 1_000).toFixed(2)}K`; return num.toFixed(0); };

        function applySettings() {
            document.getElementById('langSelect').value = settings.lang;
            document.getElementById('autoRefreshToggle').checked = settings.autoRefresh;
            document.getElementById('refreshInterval').value = settings.refreshInterval;
            document.getElementById('refreshInterval').min = { admin: 10, qualified: 120, new_user: 300 }[currentUserRole] || 300;
            document.getElementById('telegramPhoneInput').value = settings.telegramPhone || '';

            for (let i = 1; i <= 3; i++) {
                if(settings.columns[i]) {
                    document.getElementById(`col${i}_name_input`).value = settings.columns[i].name;
                    document.getElementById(`col${i}_days_input`).value = settings.columns[i].days;
                    document.getElementById(`col${i}_threshold_input`).value = settings.columns[i].threshold;
                    document.getElementById(`col${i}_header_crypto`).innerHTML = `${settings.columns[i].name}<span class="sort-indicator"></span>`;
                }
            }
            document.getElementById('high_color_input').value = settings.colors.high;
            document.getElementById('low_color_input').value = settings.colors.low;
            document.getElementById('high_color_preview').style.backgroundColor = settings.colors.high;
            document.getElementById('low_color_preview').style.backgroundColor = settings.colors.low;

            document.querySelectorAll(`#cryptoPivotFilters button.active, #cryptoIntervalFilters button.active`).forEach(b => b.classList.remove('active'));
            document.querySelector(`#cryptoPivotFilters button[data-filter="${settings.cryptoPivotFilter}"]`)?.classList.add('active');
            document.querySelector(`#cryptoIntervalFilters button[data-interval="${settings.cryptoAnalysisInterval}"]`)?.classList.add('active');

            Object.keys(AVAILABLE_INDICATORS).forEach(key => {
                const checkbox = document.querySelector(`#crypto-indicator-filters-grid input[data-indicator="${key}"]`);
                if (checkbox) checkbox.checked = !!settings.cryptoAnalysisIndicators[key];
            });
            translatePage(settings.lang);
            toggleAutoRefresh();
        }

        function saveSettings() {
            const btn = document.getElementById('saveSettingsBtn');
            showLoading(btn);

            let interval = parseInt(document.getElementById('refreshInterval').value);
            const minInterval = { admin: 10, qualified: 120, new_user: 300 }[currentUserRole] || 300;
            if (interval < minInterval) interval = minInterval;
            settings.lang = document.getElementById('langSelect').value;
            settings.autoRefresh = document.getElementById('autoRefreshToggle').checked;
            settings.refreshInterval = interval;
            settings.telegramPhone = document.getElementById('telegramPhoneInput').value;
            settings.columns = { 1: { name: document.getElementById('col1_name_input').value, days: parseInt(document.getElementById('col1_days_input').value), threshold: parseFloat(document.getElementById('col1_threshold_input').value) }, 2: { name: document.getElementById('col2_name_input').value, days: parseInt(document.getElementById('col2_days_input').value), threshold: parseFloat(document.getElementById('col2_threshold_input').value) }, 3: { name: document.getElementById('col3_name_input').value, days: parseInt(document.getElementById('col3_days_input').value), threshold: parseFloat(document.getElementById('col3_threshold_input').value) } };
            settings.colors = { high: document.getElementById('high_color_input').value, low: document.getElementById('low_color_input').value };

            if (userDocRef) {
                userDocRef.update({ settings: settings }).then(() => {
                    applySettings();
                    closeAllPanels();
                    showNotification(translations[settings.lang].settings_saved, true);
                    fetchAllDataAndRender();
                }).catch(error => {
                    console.error("Firebase ayar kaydetme hatasƒ±:", error);
                    showNotification("Ayarlarƒ± kaydederken hata olu≈ütu.", false);
                }).finally(() => {
                    hideLoading(btn);
                });
            }
        }

        function updateAnalysisSettings(type) {
            const btn = document.getElementById('updateCryptoAnalysisBtn');
            showLoading(btn);
            
            settings.cryptoAnalysisInterval = document.querySelector('#cryptoIntervalFilters button.active').dataset.interval;

            settings[`${type}AnalysisIndicators`] = {};
            document.querySelectorAll(`#${type}-indicator-filters-grid input[type="checkbox"]`).forEach(checkbox => {
                settings[`${type}AnalysisIndicators`][checkbox.dataset.indicator] = checkbox.checked;
            });
            if (userDocRef) {
                userDocRef.update({ 
                    'settings.cryptoAnalysisIndicators': settings.cryptoAnalysisIndicators,
                    'settings.cryptoAnalysisInterval': settings.cryptoAnalysisInterval
                }).then(() => {
                    showNotification(translations[settings.lang].analysis_updated, true);
                    fetchAllDataAndRender(); 
                }).catch(error => {
                    console.error("Firebase analiz ayarƒ± kaydetme hatasƒ±:", error);
                    showNotification("Analiz ayarlarƒ± g√ºncellenirken bir hata olu≈ütu.", false);
                }).finally(() => {
                    hideLoading(btn);
                });
            }
        }
        
        function toggleAutoRefresh() { if(autoRefreshTimer) clearInterval(autoRefreshTimer); if(settings.autoRefresh) autoRefreshTimer = setInterval(fetchAllDataAndRender, settings.refreshInterval * 1000); }

        const calculateSMA = (data, period) => { if (data.length < period) return null; return data.slice(-period).reduce((s, v) => s + parseFloat(v), 0) / period; };
        const calculateEMA = (data, period) => { if (data.length < period) return null; const k = 2 / (period + 1); let ema = calculateSMA(data.slice(0, period), period); for (let i = period; i < data.length; i++) { ema = (parseFloat(data[i]) * k) + (ema * (1 - k)); } return ema; };
        const calculateStdDev = (data, period) => { let mean = data.reduce((s, v) => s + parseFloat(v), 0) / period; return Math.sqrt(data.reduce((s, v) => s + Math.pow(parseFloat(v) - mean, 2), 0) / period); };
        const calculateBollingerBands = (data, period = 20, stdDev = 2) => { if (data.length < period) return null; const middle = calculateEMA(data, period); const deviation = calculateStdDev(data.slice(-period), period); return { upper: middle + (deviation * stdDev), middle: middle, lower: middle - (deviation * stdDev) }; };
        const calculateRSI = (data, period = 14) => { if (data.length <= period) return null; let gains = 0, losses = 0; for (let i = 1; i <= period; i++) { const diff = parseFloat(data[i]) - parseFloat(data[i - 1]); if (diff >= 0) { gains += diff; } else { losses -= diff; } } let avgGain = gains / period, avgLoss = losses / period; for (let i = period + 1; i < data.length; i++) { const diff = parseFloat(data[i]) - parseFloat(data[i-1]); if (diff >= 0) { avgGain = (avgGain * (period - 1) + diff) / period; avgLoss = (avgLoss * (period - 1)) / period; } else { avgLoss = (avgLoss * (period - 1) - diff) / period; avgGain = (avgGain * (period - 1)) / period; } } if (avgLoss === 0) return 100; const rs = avgGain / avgLoss; return 100 - (100 / (1 + rs)); };
        const calculateStochasticRSI = (data, period = 14) => { if (data.length < period * 2) return null; const rsiValues = []; for(let i = period; i < data.length; i++) { const rsi = calculateRSI(data.slice(0, i + 1), period); if (rsi !== null) rsiValues.push(rsi); } if (rsiValues.length < period) return null; const currentRSI = rsiValues[rsiValues.length - 1]; const rsiSlice = rsiValues.slice(-period); const lowestRSI = Math.min(...rsiSlice); const highestRSI = Math.max(...rsiSlice); if (highestRSI === lowestRSI) return {k: 100}; return { k: ((currentRSI - lowestRSI) / (highestRSI - lowestRSI)) * 100 }; };
        const calculateATR = (klines, period = 14) => { if (klines.length < period + 1) return null; let trs = []; for (let i = 1; i < klines.length; i++) { const high = parseFloat(klines[i][2]), low = parseFloat(klines[i][3]), prevClose = parseFloat(klines[i-1][4]); trs.push(Math.max(high - low, Math.abs(high - prevClose), Math.abs(low - prevClose))); } if (trs.length < period) return null; return trs.slice(-period).reduce((s, v) => s + v, 0) / period; };
        const calculateMACD = (data, fast = 12, slow = 26, signal = 9) => { if (data.length < slow) return null; const macdLineData = []; for (let i = slow - 1; i < data.length; i++) { const fastEma = calculateEMA(data.slice(0, i + 1), fast); const slowEma = calculateEMA(data.slice(0, i + 1), slow); if (fastEma !== null && slowEma !== null) macdLineData.push(fastEma - slowEma); } if (macdLineData.length < signal) return null; const signalLine = calculateEMA(macdLineData, signal); const macdLine = macdLineData[macdLineData.length - 1]; return { macd: macdLine, signal: signalLine, histogram: macdLine - signalLine }; };
        const calculateIchimokuCloud = (klines) => { if (klines.length < 52) return null; const slice = klines.slice(-52); const high9 = Math.max(...slice.slice(-9).map(k => parseFloat(k[2]))); const low9 = Math.min(...slice.slice(-9).map(k => parseFloat(k[3]))); const tenkanSen = (high9 + low9) / 2; const high26 = Math.max(...slice.slice(-26).map(k => parseFloat(k[2]))); const low26 = Math.min(...slice.slice(-26).map(k => parseFloat(k[3]))); const kijunSen = (high26 + low26) / 2; const senkouSpanA = (tenkanSen + kijunSen) / 2; const high52 = Math.max(...slice.map(k => parseFloat(k[2]))); const low52 = Math.min(...slice.map(k => parseFloat(k[3]))); const senkouSpanB = (high52 + low52) / 2; return { tenkanSen, kijunSen, senkouSpanA, senkouSpanB }; };
        const calculateFibonacciRetracement = (klines, period = 100) => { if (klines.length < period) return null; const slice = klines.slice(-period); const high = Math.max(...slice.map(k => parseFloat(k[2]))); const low = Math.min(...slice.map(k => parseFloat(k[3]))); const diff = high - low; return { level_236: high - diff * 0.236, level_382: high - diff * 0.382, level_500: high - diff * 0.5, level_618: high - diff * 0.618, }; };

        async function fetchCryptoData(pair) {
            try {
                const timeout = 5000;
                const [analysisKlinesResponse, dailyKlinesResponse, tickerResponse] = await Promise.all([
                    axios.get(`https://api.binance.com/api/v3/klines?symbol=${pair}&interval=${settings.cryptoAnalysisInterval}&limit=400`, { timeout }),
                    axios.get(`https://api.binance.com/api/v3/klines?symbol=${pair}&interval=1d&limit=1000`, { timeout }),
                    axios.get(`https://api.binance.com/api/v3/ticker/24hr?symbol=${pair}`, { timeout })
                ]);
                const analysisKlines = analysisKlinesResponse.data, dailyKlines = dailyKlinesResponse.data, tickerData = tickerResponse.data;
                if (!analysisKlines || analysisKlines.length < 52 || !dailyKlines || dailyKlines.length < 2) throw new Error("Yetersiz ge√ßmi≈ü veri.");

                const latestPrice = parseFloat(tickerData.lastPrice);
                const analysisClosePrices = analysisKlines.map(d => d[4]);
                const calculatePct = (col) => {
                    const days = settings.columns[col].days;
                    if (dailyKlines.length < days + 1) return { pct: 'N/A' };
                    const periodData = dailyKlines.slice(-(days + 1), -1);
                    let lowestPrice = Infinity, lowestDate = null;
                    periodData.forEach(d => { const low = parseFloat(d[3]); if (low < lowestPrice) { lowestPrice = low; lowestDate = new Date(d[0]); } });
                    if (lowestPrice === Infinity) return { pct: 'N/A' };
                    return { pct: ((latestPrice - lowestPrice) / lowestPrice * 100), lowestPrice, lowestDate: lowestDate.toLocaleDateString(settings.lang) };
                };
                const yesterday = dailyKlines[dailyKlines.length - 2];
                const high = parseFloat(yesterday[2]), low = parseFloat(yesterday[3]), close = parseFloat(yesterday[4]);
                const pivot = (high + low + close) / 3;

                return {
                    pair, latestPrice, error: false, type: 'crypto', currency: 'USDT',
                    col1: calculatePct(1), col2: calculatePct(2), col3: calculatePct(3),
                    sr: { r2: pivot + (high - low), r1: (2 * pivot) - low, pivot: pivot, s1: (2 * pivot) - high, s2: pivot - (high - low) },
                    indicators: { sma: calculateSMA(analysisClosePrices, 50), ema: calculateEMA(analysisClosePrices, 50), rsi: calculateRSI(analysisClosePrices, 14), macd: calculateMACD(analysisClosePrices), bollinger: calculateBollingerBands(analysisClosePrices), stochRsi: calculateStochasticRSI(analysisClosePrices, 14), volume: parseFloat(tickerData.quoteVolume), atr: calculateATR(analysisKlines, 14), ichimoku: calculateIchimokuCloud(analysisKlines), fibonacci: calculateFibonacciRetracement(analysisKlines) }
                };
            } catch (error) {
                console.error(`${pair} verisi √ßekilirken hata olu≈ütu:`, error);
                return { pair, error: true, type: 'crypto' };
            }
        }

        async function fetchAllDataAndRender() {
            const refreshBtn = document.getElementById('refreshBtn');
            showLoading(refreshBtn);
            
            const currentCoinList = userPortfolios[activePortfolio] || [];
            allCryptoData = [];
            renderLoadingSkeletons('crypto', currentCoinList, document.getElementById('cryptoPriceTable'));
            allCryptoData = await Promise.all(currentCoinList.map(fetchCryptoData));

            allCryptoData.forEach(asset => {
                if(!asset.error) {
                    const { recommendation, color, summary, category } = getRecommendation(asset, settings.cryptoAnalysisIndicators);
                    asset.recommendation = recommendation;
                    asset.recommendationColor = color;
                    asset.recommendationSummary = summary;
                    asset.recommendationCategory = category;
                }
            });

            sortAndRenderTable();
            renderSupportResistance('crypto', allCryptoData);
            hideLoading(refreshBtn);
            updateTime.textContent = new Date().toLocaleString(settings.lang);
        }

        function renderLoadingSkeletons(type, pairs, tableBody) {
            tableBody.innerHTML = '';
            pairs.forEach(pair => {
                const row = document.createElement("tr");
                row.dataset.pair = pair;
                if (type === 'crypto') {
                    row.innerHTML = `<td class="drag-handle-col hidden"><i class="fas fa-grip-lines drag-handle"></i></td><td class="asset-cell" data-pair="${pair}" data-type="${type}">${pair.replace("USDT", "")}</td><td colspan="5" style="text-align:center;"><div class="loading"></div></td>`;
                } else { // crypto-ai
                    row.innerHTML = `<td class="drag-handle-col hidden"><i class="fas fa-grip-lines drag-handle"></i></td><td class="asset-cell" data-pair="${pair}" data-type="${type}">${pair.replace("USDT", "")}</td><td colspan="4" style="text-align:center;"><div class="loading"></div></td>`;
                }
                tableBody.appendChild(row);
            });
        }

        function sortAndRenderTable() {
            const { key, order } = currentSort;
            let sortedData = (order === 'default') ? [...allCryptoData] : [...allCryptoData].sort((a, b) => {
                let valA, valB;
                if (key.startsWith('col')) {
                    valA = a[key]?.pct;
                    valB = b[key]?.pct;
                } else {
                    valA = a[key];
                    valB = b[key];
                }

                if (a.error) return 1; if (b.error) return -1;
                if (valA === undefined || valA === null || valA === 'N/A') return 1;
                if (valB === undefined || valB === null || valB === 'N/A') return -1;

                if (typeof valA === 'string') {
                    return order === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                } else {
                    return order === 'asc' ? valA - valB : valB - valA;
                }
            });

            document.querySelectorAll('#crypto-content th.sortable').forEach(th => {
                th.classList.remove('asc', 'desc');
                if (th.dataset.sortKey === key && order !== 'default') {
                    th.classList.add(order);
                }
            });
            updateAllTableRows('crypto', sortedData);
        }

        function updateAllTableRows(type, data) {
            const tableBody = document.getElementById(`${type}PriceTable`);
            tableBody.innerHTML = '';
            const isSorting = !document.querySelector('#crypto-content .drag-handle-col.hidden');
            
            const formatPct = (pct) => {
                if(typeof pct === 'number') {
                    return `${pct.toFixed(2)}%`;
                }
                return 'N/A';
            };

            const getCellStyle = (colData, threshold) => {
                const pct = colData?.pct;
                let classes = '';
                let style = '';
                if (typeof pct !== 'number') return { classes: '', style: '' };
                if (pct < 0) {
                    classes = 'negative';
                } else if (pct >= threshold) {
                    classes = 'positive-high';
                    style = `style="color: ${settings.colors.high};"`;
                } else {
                    classes = 'positive-low';
                    style = `style="color: ${settings.colors.low};"`;
                }
                return { classes, style };
            };

            data.forEach(result => {
                const row = document.createElement("tr");
                row.dataset.pair = result.pair;
                let rowHTML;

                if (result.error) {
                    rowHTML = `<td class="drag-handle-col ${isSorting ? '' : 'hidden'}"><i class="fas fa-grip-lines drag-handle"></i></td><td class="asset-cell">${result.pair.replace("USDT", "")}</td><td colspan="5" style="text-align:center; color: var(--accent-red);">Veri alƒ±namadƒ±</td>`;
                } else {
                    const cellStyle1 = getCellStyle(result.col1, settings.columns[1].threshold);
                    const cellStyle2 = getCellStyle(result.col2, settings.columns[2].threshold);
                    const cellStyle3 = getCellStyle(result.col3, settings.columns[3].threshold);

                    rowHTML = `
                        <td class="drag-handle-col ${isSorting ? '' : 'hidden'}"><i class="fas fa-grip-lines drag-handle"></i></td>
                        <td class="asset-cell" data-pair="${result.pair}" data-type="${type}">${result.pair.replace("USDT", "")}</td>
                        <td>${formatPrice(result.latestPrice)}</td>
                        <td class="${cellStyle1.classes} clickable-pct" ${cellStyle1.style} data-col="1" data-pair="${result.pair}" data-type="${type}">${formatPct(result.col1.pct)}</td>
                        <td class="${cellStyle2.classes} clickable-pct" ${cellStyle2.style} data-col="2" data-pair="${result.pair}" data-type="${type}">${formatPct(result.col2.pct)}</td>
                        <td class="${cellStyle3.classes} clickable-pct" ${cellStyle3.style} data-col="3" data-pair="${result.pair}" data-type="${type}">${formatPct(result.col3.pct)}</td>
                    `;
                }
                rowHTML += `<td><button class="action-btn remove-btn" data-pair="${result.pair}" data-type="${type}"><i class="fas fa-times"></i></button></td>`;
                row.innerHTML = rowHTML;
                tableBody.appendChild(row);
            });
        }

        function renderSupportResistance(type, data) {
            const container = document.getElementById('crypto-pivot-container');
            container.innerHTML = '';
            document.getElementById('pivot-dictionary-container').innerHTML = `
                <div class="pivot-dictionary">
                    <p><span>P:</span> Pivot Noktasƒ± (Referans)</p>
                    <p><span>R1, R2:</span> Diren√ß Seviyeleri (Y√ºkseli≈ü Hedefleri)</p>
                    <p><span>S1, S2:</span> Destek Seviyeleri (D√º≈ü√º≈ü Duraklarƒ±)</p>
                </div>`;

            const filter = settings[`${type}PivotFilter`];
            data.filter(asset => !asset.error && asset.sr).forEach(asset => {
                if ((filter === 'above' && asset.latestPrice < asset.sr.pivot) || (filter === 'below' && asset.latestPrice > asset.sr.pivot)) return;

                const { s2, s1, pivot, r1, r2 } = asset.sr;
                const min = s2, max = r2;
                if (max <= min) return;
                const range = max - min;
                const getPosition = (value) => Math.max(0, Math.min(100, ((value - min) / range) * 100));

                const card = document.createElement('div');
                card.className = 'pivot-bar-card';
                card.innerHTML = `
                    <h4 class="pivot-bar-header">${asset.pair.replace("USDT", "")} - G√ºnl√ºk Pivot Seviyeleri</h4>
                    <div class="pivot-bar-container">
                        <div class="pivot-bar">
                            <div class="pivot-marker" style="left: ${getPosition(s2)}%;"></div>
                            <div class="pivot-marker" style="left: ${getPosition(s1)}%;"></div>
                            <div class="pivot-marker" style="left: ${getPosition(pivot)}%;"></div>
                            <div class="pivot-marker" style="left: ${getPosition(r1)}%;"></div>
                            <div class="pivot-marker" style="left: ${getPosition(r2)}%;"></div>
                        </div>
                        <div class="current-price-indicator" style="left: ${getPosition(asset.latestPrice)}%;" data-price="${formatPrice(asset.latestPrice)}"></div>
                    </div>
                    <div class="pivot-values">
                        <span>S2: ${formatPrice(s2)}</span>
                        <span>S1: ${formatPrice(s1)}</span>
                        <span>P: ${formatPrice(pivot)}</span>
                        <span>R1: ${formatPrice(r1)}</span>
                        <span>R2: ${formatPrice(r2)}</span>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderIndicatorFilters() {
            const grid = document.getElementById('crypto-indicator-filters-grid');
            if(grid) grid.innerHTML = Object.keys(AVAILABLE_INDICATORS).map(key => `<label class="filter-item"><input type="checkbox" data-indicator="${key}">${AVAILABLE_INDICATORS[key]}</label>`).join('');
        }

        function renderDictionary() {
            const content = document.getElementById('dictionaryContent');
            if(content) content.innerHTML = `<div class="dictionary-item"><h5>RSI (G√∂receli G√º√ß Endeksi)</h5><p>Fiyat hareketlerinin hƒ±zƒ±nƒ± ve deƒüi≈üimini √∂l√ßerek bir varlƒ±ƒüƒ±n a≈üƒ±rƒ± alƒ±m veya a≈üƒ±rƒ± satƒ±m ko≈üullarƒ±nda olup olmadƒ±ƒüƒ±nƒ± deƒüerlendirir. 0 ile 100 arasƒ±nda bir deƒüer alƒ±r.</p><p class="example"><b>√ñrnek:</b> RSI deƒüeri 70'in √ºzerine √ßƒ±ktƒ±ƒüƒ±nda, varlƒ±ƒüƒ±n a≈üƒ±rƒ± deƒüerlendiƒüi ve bir d√ºzeltme (d√º≈ü√º≈ü) ya≈üanabileceƒüi d√º≈ü√ºn√ºl√ºr (Sat sinyali). 30'un altƒ±na indiƒüinde ise a≈üƒ±rƒ± satƒ±ldƒ±ƒüƒ± ve bir tepki y√ºkseli≈üi gelebileceƒüi d√º≈ü√ºn√ºl√ºr (Al sinyali).</p></div><div class="dictionary-item"><h5>MACD (Hareketli Ortalama Yakƒ±nsama/Iraksama)</h5><p>ƒ∞ki farklƒ± √ºssel hareketli ortalama (genellikle 12 ve 26 g√ºnl√ºk) arasƒ±ndaki ili≈ükiyi g√∂steren bir trend takip ve momentum g√∂stergesidir. MACD √ßizgisi, sinyal √ßizgisini yukarƒ± kestiƒüinde al, a≈üaƒüƒ± kestiƒüinde sat sinyali olarak yorumlanƒ±r.</p><p class="example"><b>√ñrnek:</b> Mavi MACD √ßizgisi, turuncu sinyal √ßizgisini alttan yukarƒ± doƒüru keserse, bu y√ºkseli≈ü momentumunun arttƒ±ƒüƒ±nƒ± g√∂sterir ve bir 'Al' fƒ±rsatƒ± olabilir. Histogramƒ±n (√ßubuklarƒ±n) sƒ±fƒ±r √ßizgisinin √ºzerine √ßƒ±kmasƒ± bu sinyali g√º√ßlendirir.</p></div><div class="dictionary-item"><h5>Hareketli Ortalamalar (EMA/SMA)</h5><p>Belirli bir periyottaki fiyatlarƒ±n ortalamasƒ±nƒ± alarak trend y√∂n√ºn√º yumu≈üatƒ±r ve belirginle≈ütirir. EMA (√ússel) son fiyatlara daha fazla aƒüƒ±rlƒ±k verirken, SMA (Basit) t√ºm fiyatlara e≈üit aƒüƒ±rlƒ±k verir. Kƒ±sa vadeli ortalamanƒ±n (√∂rn. 20 EMA) uzun vadeli ortalamayƒ± (√∂rn. 50 EMA) yukarƒ± kesmesi 'Golden Cross' (Al sinyali), a≈üaƒüƒ± kesmesi 'Death Cross' (Sat sinyali) olarak bilinir.</p><p class="example"><b>√ñrnek:</b> Fiyat grafiƒüi 50 g√ºnl√ºk EMA'nƒ±n √ºzerinde seyrediyorsa, orta vadeli trendin y√ºkseli≈üte olduƒüu kabul edilir.</p></div><div class="dictionary-item"><h5>Bollinger Bantlarƒ±</h5><p>Bir basit hareketli ortalamanƒ±n (orta bant) etrafƒ±na standart sapma ile hesaplanan iki bandƒ±n (√ºst ve alt) eklenmesiyle olu≈üur. Fiyatlarƒ±n bu bantlarƒ±n dƒ±≈üƒ±na √ßƒ±kmasƒ± nadirdir ve genellikle a≈üƒ±rƒ± oynaklƒ±ƒüa veya g√º√ßl√º bir trende i≈üaret eder.</p><p class="example"><b>√ñrnek:</b> Fiyatlar alt banda deƒüip tekrar i√ßeri d√∂nerse bu bir alƒ±m fƒ±rsatƒ± olabilir. Fiyatlarƒ±n √ºst banda s√ºrekli baskƒ± yapmasƒ± ve bandƒ±n geni≈ülemesi, g√º√ßl√º bir y√ºkseli≈ü trendinin i≈üareti olabilir.</p></div><div class="dictionary-item"><h5>Ichimoku Cloud (Ichimoku Bulutu)</h5><p>Tek bakƒ±≈üta trend y√∂n√º, momentum, destek ve diren√ß seviyeleri hakkƒ±nda kapsamlƒ± bilgi sunar. Fiyatƒ±n bulutun (Kumo) √ºzerinde olmasƒ± y√ºkseli≈ü, altƒ±nda olmasƒ± d√º≈ü√º≈ü trendini g√∂sterir. Bulutun kendisi ise dinamik bir destek/diren√ß b√∂lgesi olarak √ßalƒ±≈üƒ±r.</p><p class="example"><b>√ñrnek:</b> Fiyat, ye≈üil bulutun √ºzerindeyse bu g√º√ßl√º bir y√ºkseli≈ü trendidir. Fiyatƒ±n bulutun i√ßine girmesi ise piyasanƒ±n kararsƒ±z olduƒüunu g√∂sterir.</p></div><div class="dictionary-item"><h5>Stochastic RSI</h5><p>RSI g√∂stergesine stokastik osilat√∂r form√ºl√ºn√ºn uygulanmasƒ±yla elde edilir ve a≈üƒ±rƒ± alƒ±m/satƒ±m sinyallerini daha sƒ±k ve net bir ≈üekilde √ºretir. 80 √ºzeri a≈üƒ±rƒ± alƒ±m, 20 altƒ± a≈üƒ±rƒ± satƒ±m olarak kabul edilir.</p><p class="example"><b>√ñrnek:</b> StochRSI 20 seviyesinin altƒ±na d√º≈ü√ºp tekrar yukarƒ± d√∂nd√ºƒü√ºnde bu bir alƒ±m sinyali olarak deƒüerlendirilebilir.</p></div><div class="dictionary-item"><h5>ATR (Average True Range)</h5><p>Piyasanƒ±n oynaklƒ±ƒüƒ±nƒ± (volatilite) √∂l√ßer. Fiyatƒ±n ne kadar hareket ettiƒüini g√∂sterir, ancak y√∂n√ºn√º belirtmez. Y√ºksek ATR, y√ºksek oynaklƒ±k; d√º≈ü√ºk ATR, d√º≈ü√ºk oynaklƒ±k anlamƒ±na gelir.</p><p class="example"><b>√ñrnek:</b> Bir yatƒ±rƒ±mcƒ±, stop-loss seviyesini belirlerken mevcut fiyatƒ±n 2 ATR kadar altƒ±na koyabilir. Bu, normal piyasa dalgalanmalarƒ±ndan etkilenmemesine yardƒ±mcƒ± olur.</p></div><div class="dictionary-item"><h5>Fibonacci D√ºzeltmesi</h5><p>Bir trendin ba≈ülangƒ±√ß ve biti≈ü noktalarƒ± arasƒ±na √ßizilen yatay seviyelerdir. Trendin olasƒ± geri √ßekilme (d√ºzeltme) seviyelerini, yani potansiyel destek ve diren√ß alanlarƒ±nƒ± belirlemek i√ßin kullanƒ±lƒ±r. En yaygƒ±n seviyeler %38.2, %50 ve %61.8'dir.</p><p class="example"><b>√ñrnek:</b> Bir y√ºkseli≈ü trendinde fiyat geri √ßekilmeye ba≈ülarsa, yatƒ±rƒ±mcƒ±lar %50 Fibonacci seviyesinin destek olarak √ßalƒ±≈ümasƒ±nƒ± ve fiyatƒ±n buradan tekrar y√ºkseli≈üe ge√ßmesini bekleyebilir.</p></div>`;
        }

       function getRecommendation(asset, activeIndicators) {
            const { indicators, latestPrice } = asset;
            let buyScore = 0, sellScore = 0;
            let summaryPoints = { buy: [], sell: [], neutral: [] };

            const formatVal = (val) => (typeof val === 'number' ? val.toFixed(2) : val);

            // RSI
            if (activeIndicators.rsi && indicators.rsi !== null) {
                if (indicators.rsi <= 30) { buyScore += 2; summaryPoints.buy.push(`RSI(${formatVal(indicators.rsi)}) a≈üƒ±rƒ± satƒ±m b√∂lgesinde`); }
                else if (indicators.rsi < 45) { buyScore += 1; summaryPoints.buy.push(`RSI(${formatVal(indicators.rsi)}) d√º≈ü√ºk seviyede`); }
                if (indicators.rsi >= 70) { sellScore += 2; summaryPoints.sell.push(`RSI(${formatVal(indicators.rsi)}) a≈üƒ±rƒ± alƒ±m b√∂lgesinde`); }
                else if (indicators.rsi > 55) { sellScore += 1; summaryPoints.sell.push(`RSI(${formatVal(indicators.rsi)}) y√ºksek seviyede`); }
            }
            // Stochastic RSI
            if (activeIndicators.stochRsi && indicators.stochRsi) {
                if(indicators.stochRsi.k <= 20) { buyScore += 2; summaryPoints.buy.push(`StochRSI(${formatVal(indicators.stochRsi.k)}) a≈üƒ±rƒ± satƒ±mda`); } 
                if(indicators.stochRsi.k >= 80) { sellScore += 2; summaryPoints.sell.push(`StochRSI(${formatVal(indicators.stochRsi.k)}) a≈üƒ±rƒ± alƒ±mda`); }
            }
            // Bollinger Bands
            if (activeIndicators.bollinger && indicators.bollinger) {
                if (latestPrice < indicators.bollinger.lower) { buyScore += 2; summaryPoints.buy.push("Fiyat alt Bollinger bandƒ±nƒ±n altƒ±nda"); } 
                else if (latestPrice > indicators.bollinger.upper) { sellScore += 2; summaryPoints.sell.push("Fiyat √ºst Bollinger bandƒ±nƒ±n √ºzerinde"); }
                else if (latestPrice < indicators.bollinger.middle) { sellScore += 0.5; }
                else if (latestPrice > indicators.bollinger.middle) { buyScore += 0.5; }
            }
            // MACD
            if (activeIndicators.macd && indicators.macd) {
                if (indicators.macd.histogram > 0) {
                    buyScore += 1.5;
                    summaryPoints.buy.push("MACD histogramƒ± pozitif");
                } else {
                    sellScore += 1.5;
                    summaryPoints.sell.push("MACD histogramƒ± negatif");
                }
            }
            // Moving Averages (EMA/SMA)
            if (activeIndicators.ema && activeIndicators.sma && indicators.ema && indicators.sma) {
                if (indicators.ema > indicators.sma) {
                    buyScore += 1;
                    summaryPoints.buy.push("EMA, SMA'nƒ±n √ºzerinde (y√ºkseli≈ü trendi)");
                } else {
                    sellScore += 1;
                    summaryPoints.sell.push("EMA, SMA'nƒ±n altƒ±nda (d√º≈ü√º≈ü trendi)");
                }
            }
            // Ichimoku Cloud
            if (activeIndicators.ichimoku && indicators.ichimoku) {
                const { tenkanSen, kijunSen, senkouSpanA, senkouSpanB } = indicators.ichimoku;
                const inCloud = latestPrice > Math.min(senkouSpanA, senkouSpanB) && latestPrice < Math.max(senkouSpanA, senkouSpanB);
                
                if (latestPrice > senkouSpanA && latestPrice > senkouSpanB) {
                    buyScore += 2;
                    summaryPoints.buy.push("Fiyat Ichimoku bulutunun √ºzerinde");
                } else if (latestPrice < senkouSpanA && latestPrice < senkouSpanB) {
                    sellScore += 2;
                    summaryPoints.sell.push("Fiyat Ichimoku bulutunun altƒ±nda");
                } else if (inCloud) {
                    summaryPoints.neutral.push("Fiyat Ichimoku bulutunun i√ßinde (kararsƒ±z)");
                }

                if (tenkanSen > kijunSen) { buyScore += 1; summaryPoints.buy.push("Tenkan/Kijun kesi≈üimi pozitif"); }
                else { sellScore += 1; summaryPoints.sell.push("Tenkan/Kijun kesi≈üimi negatif"); }
            }
            // Fibonacci
            if (activeIndicators.fibonacci && indicators.fibonacci) {
                if (latestPrice < indicators.fibonacci.level_618) { sellScore += 0.5; summaryPoints.sell.push("Fiyat kritik 0.618 Fibonacci desteƒüinin altƒ±nda"); }
                else { buyScore += 0.5; summaryPoints.buy.push("Fiyat kritik 0.618 Fibonacci desteƒüinin √ºzerinde"); }
            }

            let recommendation, color, category;
            const finalScore = buyScore - sellScore;
            const conflictLevel = Math.min(buyScore, sellScore);

            if (conflictLevel >= 3) {
                recommendation = "Tut";
                color = "var(--hold)";
                category = "hold";
            } else {
                if (finalScore >= 4) { recommendation = "G√º√ßl√º Al"; color = "var(--strong-buy)"; category = "buy"; }
                else if (finalScore >= 1.5) { recommendation = "Al"; color = "var(--buy)"; category = "buy"; }
                else if (finalScore <= -4) { recommendation = "G√º√ßl√º Sat"; color = "var(--strong-sell)"; category = "sell"; }
                else if (finalScore <= -1.5) { recommendation = "Sat"; color = "var(--sell)"; category = "sell"; }
                else { recommendation = "Tut"; color = "var(--hold)"; category = "hold"; }
            }

            let summary = "";
            if (summaryPoints.buy.length > 0) {
                summary += `<b>‚¨Ü Al Sinyalleri (${summaryPoints.buy.length}):</b> ${summaryPoints.buy.join(', ')}. `;
            }
            if (summaryPoints.sell.length > 0) {
                summary += `<br><b>‚¨á Sat Sinyalleri (${summaryPoints.sell.length}):</b> ${summaryPoints.sell.join(', ')}. `;
            }
            if (summaryPoints.neutral.length > 0) {
                 summary += `<br><b>‚ûñ N√∂tr Sinyaller (${summaryPoints.neutral.length}):</b> ${summaryPoints.neutral.join(', ')}.`;
            }
            if (summary.length === 0) {
                summary = "Aktif indikat√∂rlere g√∂re belirgin bir sinyal bulunamadƒ±.";
            }

            return { recommendation, color, summary, category };
        }

        function renderIndicatorCards(type, data) {
            const container = document.getElementById('crypto-indicator-cards-container');
            container.innerHTML = '';
            const activeIndicators = settings[`${type}AnalysisIndicators`];
            const sourceData = data || allCryptoData;

            sourceData.forEach(asset => {
                if (currentRecommendationFilter !== 'all' && asset.recommendationCategory !== currentRecommendationFilter) {
                    return;
                }

                const card = document.createElement('div');
                card.className = 'indicator-card';
                if (asset.error) {
                    card.innerHTML = `<h4>${asset.pair.replace("USDT", "")}</h4><p style="color:var(--accent-red)">Veri y√ºklenemedi.</p>`;
                    container.appendChild(card);
                    return;
                }
                const { recommendation, recommendationColor, recommendationSummary, latestPrice, indicators } = asset;

                const getValueHTML = (label, value, formatter, positiveCondition, negativeCondition) => {
                    if (value === null || value === undefined) return '';
                    let className = 'value';
                    if (positiveCondition?.(value)) className += ' value-positive';
                    else if (negativeCondition?.(value)) className += ' value-negative';
                    return `<div class="indicator-item"><span class="label">${label}</span><span class="${className}">${formatter(value)}</span></div>`;
                };

                let detailsHTML = '<div class="indicator-details-grid">';
                detailsHTML += getValueHTML('Fiyat', latestPrice, val => `$${formatPrice(val)}`);
                Object.keys(AVAILABLE_INDICATORS).forEach(key => {
                    if(activeIndicators[key]) {
                        const indicatorValue = indicators[key];
                        if (indicatorValue !== undefined && indicatorValue !== null) {
                             switch(key) {
                                case 'rsi': detailsHTML += getValueHTML('RSI', indicatorValue, v => v.toFixed(2), v => v < 30, v => v > 70); break;
                                case 'macd': detailsHTML += getValueHTML('MACD Hist.', indicatorValue?.histogram, v => v.toFixed(6), v => v > 0, v => v < 0); break;
                                case 'stochRsi': detailsHTML += getValueHTML('Stoch RSI (k)', indicatorValue?.k, v => v.toFixed(2), v => v < 20, v => v > 80); break;
                                case 'volume': detailsHTML += getValueHTML('Hacim (24s)', indicatorValue, formatVolume); break;
                                case 'ema': detailsHTML += getValueHTML('EMA (50)', indicatorValue, v => v.toFixed(2)); break;
                                case 'sma': detailsHTML += getValueHTML('SMA (50)', indicatorValue, v => v.toFixed(2)); break;
                                case 'atr': detailsHTML += getValueHTML('ATR', indicatorValue, v => v.toFixed(4)); break;
                                case 'bollinger': 
                                    detailsHTML += getValueHTML('Bollinger √úst', indicatorValue?.upper, v => v.toFixed(2));
                                    detailsHTML += getValueHTML('Bollinger Orta', indicatorValue?.middle, v => v.toFixed(2));
                                    detailsHTML += getValueHTML('Bollinger Alt', indicatorValue?.lower, v => v.toFixed(2));
                                    break;
                                case 'ichimoku': 
                                    detailsHTML += getValueHTML('Ichimoku Tenkan', indicatorValue?.tenkanSen, v => v.toFixed(2)); 
                                    detailsHTML += getValueHTML('Ichimoku Kijun', indicatorValue?.kijunSen, v => v.toFixed(2)); 
                                    detailsHTML += getValueHTML('Ichimoku Senkou A', indicatorValue?.senkouSpanA, v => v.toFixed(2)); 
                                    detailsHTML += getValueHTML('Ichimoku Senkou B', indicatorValue?.senkouSpanB, v => v.toFixed(2)); 
                                    break;
                                case 'fibonacci': 
                                    detailsHTML += getValueHTML('Fib 0.236', indicatorValue?.level_236, v => v.toFixed(2)); 
                                    detailsHTML += getValueHTML('Fib 0.382', indicatorValue?.level_382, v => v.toFixed(2)); 
                                    detailsHTML += getValueHTML('Fib 0.5', indicatorValue?.level_500, v => v.toFixed(2)); 
                                    detailsHTML += getValueHTML('Fib 0.618', indicatorValue?.level_618, v => v.toFixed(2)); 
                                    break;
                            }
                        }
                    }
                });
                detailsHTML += '</div>';

                let aiButtonHTML = '';
                if (currentUserRole === 'admin') {
                    aiButtonHTML = `<button class="ai-btn" data-pair="${asset.pair}" data-type="${type}" title="Bu varlƒ±ƒüƒ± yorumla"><i class="fas fa-magic-sparkles"></i></button>`;
                }

                card.innerHTML = `
                    <div class="indicator-card-header">
                        <h4>${asset.pair.replace("USDT", "")}</h4>
                        <span class="recommendation-badge" style="background-color:${recommendationColor};">${recommendation}</span>
                    </div>
                    ${detailsHTML}
                    <div class="card-footer">
                        <div class="summary">${recommendationSummary}</div>
                        ${aiButtonHTML}
                    </div>`;
                container.appendChild(card);
            });
        }

        async function getGeminiAnalysis(type, pair = null) {
            const button = pair ? document.querySelector(`.ai-btn[data-pair="${pair}"]`) : document.getElementById(`analyzeAllCryptoBtn`);
            if (!button) return;

            showLoading(button);
            const analysisContent = document.getElementById('analysisContent');
            analysisContent.innerHTML = '<div class="loading" style="margin: 20px auto; display:block;"></div>';
            showPanel('analysisPanel');

            const dataToAnalyze = (pair ? allCryptoData.filter(c => c.pair === pair) : allCryptoData);
            const activeIndicators = settings[`${type}AnalysisIndicators`];
            let dataSummary = "";

            dataToAnalyze.forEach(asset => {
                if(!asset.error) {
                    dataSummary += `Varlƒ±k: ${asset.pair.replace('USDT', '')}, Fiyat: ${formatPrice(asset.latestPrice)}. Aktif indikat√∂rler: `;
                    Object.keys(activeIndicators).forEach(key => {
                        if(activeIndicators[key] && asset.indicators[key] !== null && asset.indicators[key] !== undefined) {
                             let val = asset.indicators[key];
                             if(typeof val === 'object') val = JSON.stringify(val, (k,v) => typeof v === 'number' ? parseFloat(v.toFixed(4)) : v);
                             dataSummary += `${key}: ${val}, `;
                        }
                    });
                    dataSummary += "\n";
                }
            });
            
            try {
                const geminiProxy = functions.httpsCallable('geminiProxy');
                const result = await geminiProxy({ prompt: dataSummary });

                if (result.data && result.data.analysis) {
                    const cleanedHtml = result.data.analysis.replace(/^```html\n?|```$/g, '');
                    analysisContent.innerHTML = cleanedHtml;
                } else {
                    throw new Error("Yapay zekadan ge√ßerli bir yanƒ±t alƒ±namadƒ±.");
                }
            } catch (error) {
                console.error("Gemini AI Hatasƒ±:", error);
                analysisContent.innerHTML = `<p style="color:var(--accent-red)">Yorumlama sƒ±rasƒ±nda bir hata olu≈ütu: ${error.message}. L√ºtfen Firebase projenizde 'geminiProxy' adlƒ± Cloud Function'ƒ±n doƒüru ≈üekilde deploy edildiƒüinden ve faturalandƒ±rmanƒ±n aktif olduƒüundan emin olun.</p>`;
            } finally {
                hideLoading(button);
            }
        }

        const addNewAsset = async (type) => {
            const input = document.getElementById('newCoinInput');
            const assetList = userPortfolios[activePortfolio];
            const limit = coinLimit;
            
            const newAssetSymbols = input.value.split(',').map(s => s.trim().toUpperCase()).filter(Boolean);
            if (newAssetSymbols.length === 0) return;
            if (limit !== Infinity && (assetList.length + newAssetSymbols.length) > limit) {
                showNotification(translations[settings.lang].role_info(currentUserRole, limit, 'coin'), false);
                return;
            }

            for (const symbol of newAssetSymbols) {
                const newPair = (type === 'crypto' && !symbol.endsWith('USDT')) ? `${symbol}USDT` : symbol;
                if (assetList.includes(newPair)) {
                    showNotification(translations[settings.lang].already_in_list(symbol), false);
                    continue;
                }
                try {
                    await axios.get(`https://api.binance.com/api/v3/ticker/price?symbol=${newPair}`);
                    assetList.push(newPair);
                } catch (error) {
                    showNotification(translations[settings.lang].invalid_asset(symbol), false);
                }
            }
            savePortfoliosToFirestore();
            fetchAllDataAndRender();
            input.value = '';
        };

        function showChart(pair, type) {
            document.getElementById('chartPanelTitle').textContent = pair.replace("USDT", "");
            document.getElementById('chartContainer').innerHTML = '';
            new TradingView.widget({ "autosize": true, "symbol": `BINANCE:${pair}`, "interval": "D", "theme": "dark", "style": "1", "locale": settings.lang, "container_id": "chartContainer" });
            showPanel('chartPanel');
        }

        // --- YENƒ∞ EKLENEN FONKSƒ∞YONLAR ---
        function savePortfoliosToFirestore() {
            if (userDocRef) {
                userDocRef.update({ portfolios: userPortfolios }).catch(error => console.error("Firebase portf√∂y kaydetme hatasƒ±:", error));
            }
        }
        function renderPortfolioSelect() {
            const select = document.getElementById('portfolioSelect');
            select.innerHTML = '';
            for (const name in userPortfolios) {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                if (name === activePortfolio) {
                    option.selected = true;
                }
                select.appendChild(option);
            }
        }
        async function setActivePortfolio(name) {
            activePortfolio = name;
            if(userDocRef) { await userDocRef.update({ activePortfolio: name }); }
            renderPortfolioSelect();
            await fetchAllDataAndRender();
        }
        async function fetchAiDataAndRender() {
            renderLoadingSkeletons('crypto-ai', cryptoAiPairs, document.getElementById('cryptoAiPriceTable'));
            const aiData = await Promise.all(cryptoAiPairs.map(fetchCryptoData));

            aiData.forEach(asset => {
                if(!asset.error) {
                    const { recommendation, color, summary, category } = getRecommendation(asset, settings.cryptoAnalysisIndicators);
                    asset.recommendation = recommendation;
                    asset.recommendationColor = color;
                    asset.recommendationSummary = summary;
                    asset.recommendationCategory = category;
                }
            });
            
            updateAiTableRows(aiData);
            renderIndicatorCards('crypto', aiData);
        }
        function updateAiTableRows(data) {
            const tableBody = document.getElementById('cryptoAiPriceTable');
            tableBody.innerHTML = '';
            const isSorting = !document.querySelector('#crypto-ai-content .drag-handle-col.hidden');

            data.forEach(result => {
                const row = document.createElement("tr");
                row.dataset.pair = result.pair;
                let rowHTML;

                if (result.error) {
                    rowHTML = `<td class="drag-handle-col ${isSorting ? '' : 'hidden'}"><i class="fas fa-grip-lines drag-handle"></i></td><td class="asset-cell">${result.pair.replace("USDT", "")}</td><td colspan="4" style="text-align:center; color: var(--accent-red);">Veri alƒ±namadƒ±</td>`;
                } else {
                    rowHTML = `
                        <td class="drag-handle-col ${isSorting ? '' : 'hidden'}"><i class="fas fa-grip-lines drag-handle"></i></td>
                        <td class="asset-cell" data-pair="${result.pair}" data-type="crypto">${result.pair.replace("USDT", "")}</td>
                        <td>${formatPrice(result.latestPrice)}</td>
                        <td><span style="font-weight:bold; color:${result.recommendationColor};">${result.recommendation}</span></td>
                        <td>${result.recommendationSummary.substring(0, 100)}...</td>
                    `;
                }
                rowHTML += `<td><button class="action-btn remove-btn-ai" data-pair="${result.pair}"><i class="fas fa-times"></i></button></td>`;
                row.innerHTML = rowHTML;
                tableBody.appendChild(row);
            });
        }
        const addNewAssetAi = async () => {
            const input = document.getElementById('newCoinInput-ai');
            const assetList = cryptoAiPairs;
            const limit = coinLimit;

            const newAssetSymbols = input.value.split(',').map(s => s.trim().toUpperCase()).filter(Boolean);
            if (newAssetSymbols.length === 0) return;
            
            if (limit !== Infinity && (assetList.length + newAssetSymbols.length) > limit) {
                showNotification(translations[settings.lang].role_info(currentUserRole, limit, 'coin'), false);
                return;
            }

            for (const symbol of newAssetSymbols) {
                const newPair = !symbol.endsWith('USDT') ? `${symbol}USDT` : symbol;
                if (assetList.includes(newPair)) {
                    showNotification(translations[settings.lang].already_in_list(symbol), false);
                    continue;
                }
                try {
                    await axios.get(`https://api.binance.com/api/v3/ticker/price?symbol=${newPair}`);
                    assetList.push(newPair);
                } catch (error) {
                    showNotification(translations[settings.lang].invalid_asset(symbol), false);
                }
            }
            if (userDocRef) { userDocRef.update({ coins_ai: cryptoAiPairs }); }
            fetchAiDataAndRender();
            input.value = '';
        };

        // --- ALARM FUNCTIONS ---
        function renderAlarms() {
            const container = document.getElementById('alarmsListContainer');
            container.innerHTML = '';
            if (userAlarms.length === 0) {
                container.innerHTML = `<p style="text-align:center; color: var(--text-secondary);">Hen√ºz olu≈üturulmu≈ü alarm yok.</p>`;
                return;
            }

            userAlarms.forEach(alarm => {
                const card = document.createElement('div');
                card.className = 'alarm-card';
                card.dataset.alarmId = alarm.id;
                
                const coinsToDisplay = alarm.coins || [];
                card.innerHTML = `
                    <div class="alarm-card-header">
                        <div class="alarm-card-title">${alarm.name}</div>
                        <div class="alarm-card-actions">
                            <button class="action-btn check-alarm-status-btn" title="Durumu Kontrol Et"><i class="fas fa-chart-bar"></i></button>
                            <label class="switch" title="${alarm.isActive ? 'Aktif' : 'Pasif'}">
                                <input type="checkbox" class="alarm-status-toggle" ${alarm.isActive ? 'checked' : ''}>
                                <span class="slider"></span>
                            </label>
                            <button class="action-btn edit-alarm-btn" title="D√ºzenle"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete-alarm-btn" title="Sil"><i class="fas fa-trash"></i></button>
                            <button class="action-btn backtest-alarm-btn" title="Backtest Sonu√ßlarƒ±"><i class="fas fa-history"></i></button>
                        </div>
                    </div>
                    <div class="alarm-card-details">
                        <div class="coin-selection-display">
                            ${(coinsToDisplay.length > 0 ? coinsToDisplay.slice(0, 5) : ['T√ºm Liste']).map(c => `<span class="coin-tag-sm">${c.replace("USDT","")}</span>`).join('')}
                            ${(coinsToDisplay.length > 5) ? `<span class="coin-tag-sm">+${coinsToDisplay.length - 5}</span>` : ''}
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderAlarmCoinTags() {
            const container = document.getElementById('alarmCoinSelectionGrid');
            container.innerHTML = '';
            tempAlarmCoins.forEach(coin => {
                const tag = document.createElement('div');
                tag.className = 'coin-tag';
                tag.innerHTML = `<span>${coin.replace("USDT", "")}</span><span class="remove-coin-tag" data-coin="${coin}">&times;</span>`;
                container.appendChild(tag);
            });
        }
        function openAlarmPanel(alarm = null) {
            document.getElementById('alarmIdInput').value = alarm ? alarm.id : '';
            document.getElementById('alarmNameInput').value = alarm ? alarm.name : '';
            document.getElementById('alarmPanelTitle').textContent = alarm ? 'Alarmƒ± D√ºzenle' : 'Yeni Alarm Olu≈ütur';
            
            tempAlarmCoins = alarm && alarm.coins && alarm.coins.length > 0 ? [...alarm.coins] : [...userPortfolios[activePortfolio]];
            renderAlarmCoinTags();

            const isNewAlarm = !alarm;
            const conditions = alarm?.conditions || {};

            document.getElementById('alarmTimeframe').value = alarm?.timeframe || '15m';
            document.getElementById('alarmVolumeCondition').checked = conditions.volume?.enabled ?? isNewAlarm;
            document.getElementById('alarmVolumePeriod').value = conditions.volume?.period ?? 20;
            document.getElementById('alarmVolumeMultiplier').value = conditions.volume?.multiplier ?? 2;
            document.getElementById('alarmVolumeAmount').value = conditions.volume?.amount ?? 0;
            document.getElementById('alarmMacdCondition').checked = conditions.macd?.enabled ?? isNewAlarm;
            document.getElementById('alarmMacdSignalType').value = conditions.macd?.signalType ?? 'buy';
            document.getElementById('alarmTrendFilterEnabled').checked = alarm?.trendFilterEnabled ?? false;
            document.getElementById('alarmADXThreshold').value = alarm?.adxThreshold || 25;
            document.getElementById('alarmFibCondition').checked = conditions.fibonacci?.enabled ?? false;
            showPanel('alarmSettingsPanel');
        }

        async function saveAlarm() {
            const alarmId = document.getElementById('alarmIdInput').value;
            const alarmName = document.getElementById('alarmNameInput').value;
            if (!alarmName) {
                showNotification("Alarm adƒ± bo≈ü bƒ±rakƒ±lamaz.", false);
                return;
            }

            const volumeEnabled = document.getElementById('alarmVolumeCondition').checked;
            const macdEnabled = document.getElementById('alarmMacdCondition').checked;

            if (!volumeEnabled && !macdEnabled) {
                showNotification("En az bir alarm ko≈üulu (Hacim veya MACD) se√ßmelisiniz.", false);
                return;
            }
            
            const newAlarm = {
                id: alarmId || `alarm_${new Date().getTime()}`,
                name: alarmName,
                coins: tempAlarmCoins,
                isActive: alarmId ? (userAlarms.find(a => a.id === alarmId)?.isActive ?? true) : true,
                timeframe: document.getElementById('alarmTimeframe').value,
                trendFilterEnabled: document.getElementById('alarmTrendFilterEnabled').checked,
                adxThreshold: parseInt(document.getElementById('alarmADXThreshold').value),
                conditions: {
                    volume: {
                        enabled: volumeEnabled,
                        period: parseInt(document.getElementById('alarmVolumePeriod').value),
                        multiplier: parseFloat(document.getElementById('alarmVolumeMultiplier').value),
                        amount: parseFloat(document.getElementById('alarmVolumeAmount').value) || 0
                    },
                    macd: {
                        enabled: macdEnabled,
                        signalType: document.getElementById('alarmMacdSignalType').value
                    },
                    fibonacci: {
                        enabled: document.getElementById('alarmFibCondition').checked
                    }
                }
            };

            if (alarmId) {
                userAlarms = userAlarms.map(a => a.id === alarmId ? newAlarm : a);
            } else {
                userAlarms.push(newAlarm);
            }

            try {
                await userDocRef.update({ alarms: userAlarms });
                showNotification("Alarm ba≈üarƒ±yla kaydedildi.", true);
                renderAlarms();
                closeAllPanels();
            } catch (error) {
                console.error("Alarm kaydedilirken hata:", error);
                showNotification("Alarm kaydedilemedi.", false);
            }
        }

        async function runBacktest(alarmId) {
            const alarm = userAlarms.find(a => a.id === alarmId);
            if (!alarm) return;

            document.getElementById('backtestAlarmName').textContent = `"${alarm.name}" Stratejisi`;
            const container = document.getElementById('backtest-results-container');
            container.innerHTML = `<div style="text-align: center; padding: 20px;"><div class="loading"></div></div>`;
            showPanel('backtestPanel');
            
            try {
                const runBacktestOnBackend = functions.httpsCallable('runBacktest');
                const result = await runBacktestOnBackend({ alarm: alarm });
                
                let resultsHTML = '';
                const totalCandles = 1000; 

                for (const coin in result.data) {
                    const data = result.data[coin];
                    const successRate15m = (data.totalSignals > 0) ? ((data.positiveSignals_15m / data.totalSignals) * 100).toFixed(1) : "0";
                    const successRate1h = (data.totalSignals > 0) ? ((data.positiveSignals_1h / data.totalSignals) * 100).toFixed(1) : "0";
                    
                    let statsHTML = '';
                    if (alarm.conditions.volume?.enabled) {
                        statsHTML += `<p>Hacim Ko≈üulu: <span class="value">${data.conditionStats.volumeMet} kez</span> (${((data.conditionStats.volumeMet / totalCandles) * 100).toFixed(1)}%)</p>`;
                    }
                    if (alarm.conditions.macd?.enabled) {
                        statsHTML += `<p>MACD Ko≈üulu: <span class="value">${data.conditionStats.macdMet} kez</span> (${((data.conditionStats.macdMet / totalCandles) * 100).toFixed(1)}%)</p>`;
                    }
                    if (alarm.trendFilterEnabled) {
                         statsHTML += `<p>Trend Filtresi: <span class="value">${data.conditionStats.trendMet} kez</span> (${((data.conditionStats.trendMet / totalCandles) * 100).toFixed(1)}%)</p>`;
                    }
                    if (alarm.conditions.fibonacci?.enabled) {
                         statsHTML += `<p>Fibonacci Filtresi: <span class="value">${data.conditionStats.fibonacciMet} kez</span> (${((data.conditionStats.fibonacciMet / totalCandles) * 100).toFixed(1)}%)</p>`;
                    }
                    
                    let recommendationsHTML = '';
                    if (data.recommendations && data.recommendations.length > 0) {
                        recommendationsHTML = `<div class="backtest-card" style="grid-column: 1 / -1; background-color: rgba(41, 98, 255, 0.1);">
                                <h5 style="color: #64b5f6;">AI Tavsiyeleri</h5>
                                <div style="margin-top: 10px;">${data.recommendations.map(r => `<p style="margin:4px 0;">${r}</p>`).join('')}</div>
                            </div>`;
                    }
                    
                    resultsHTML += `
                    <div class="backtest-card">
                        <h4 style="color:var(--text-primary); margin-bottom: 15px;">${coin.replace("USDT","")} Sonu√ßlarƒ± (Toplam Sinyal: ${data.totalSignals})</h4>
                        <div class="backtest-results-grid">
                            ${recommendationsHTML}
                            <div class="backtest-card" style="grid-column: 1 / -1;">
                                <div class="backtest-results-grid" style="grid-template-columns: 1fr 1fr; gap: 20px;">
                                    <div>
                                        <h5 style="color: var(--accent-blue);">15 Dakika Sonrasƒ±</h5>
                                        <p>Ba≈üarƒ± Oranƒ±: <span class="value">${successRate15m}%</span></p>
                                        <p>Ort. Getiri: <span class="value" style="color: ${data.averageReturn_15m > 0 ? 'var(--value-positive)' : 'var(--value-negative)'};">${data.averageReturn_15m}%</span></p>
                                        <p>ƒ∞yi/K√∂t√º: <span class="value" style="color: var(--value-positive);">+${data.bestReturn_15m}%</span> / <span class="value" style="color: var(--value-negative);">${data.worstReturn_15m}%</span></p>
                                    </div>
                                    <div>
                                        <h5 style="color: var(--accent-yellow);">1 Saat Sonrasƒ±</h5>
                                        <p>Ba≈üarƒ± Oranƒ±: <span class="value">${successRate1h}%</span></p>
                                        <p>Ort. Getiri: <span class="value" style="color: ${data.averageReturn_1h > 0 ? 'var(--value-positive)' : 'var(--value-negative)'};">${data.averageReturn_1h}%</span></p>
                                        <p>ƒ∞yi/K√∂t√º: <span class="value" style="color: var(--value-positive);">+${data.bestReturn_1h}%</span> / <span class="value" style="color: var(--value-negative);">${data.worstReturn_1h}%</span></p>
                                    </div>
                                </div>
                            </div>
                            <div class="backtest-card" style="grid-column: 1 / -1;">
                                <h5 style="color: #c56cf0;">Ko≈üul ƒ∞statistikleri (~${totalCandles} Mumda)</h5>
                                <div style="margin-top: 10px;">${statsHTML}</div>
                                <small style="color: var(--text-secondary); display: block; margin-top: 10px;">Bu b√∂l√ºm, hangi ko≈üulun ne kadar sƒ±k saƒülandƒ±ƒüƒ±nƒ± g√∂sterir. Eƒüer sinyal sayƒ±sƒ± "0" ise, buradaki d√º≈ü√ºk y√ºzdeler hangi kuralƒ±n √ßok katƒ± olduƒüunu anlamanƒ±za yardƒ±mcƒ± olabilir.</small>
                            </div>
                        </div>
                    </div>
                    `;
                }

                container.innerHTML = resultsHTML || `<p style="text-align:center; color: var(--text-secondary);">Se√ßilen strateji i√ßin son ~10 g√ºnde hi√ß sinyal bulunamadƒ±. L√ºtfen ko≈üullarƒ± daha az katƒ± yapmayƒ± deneyin.</p>`;

            } catch (error) {
                console.error("Backtest hatasƒ±:", error);
                container.innerHTML = `<p style="color:var(--accent-red)">Backtest √ßalƒ±≈ütƒ±rƒ±lƒ±rken bir hata olu≈ütu: ${error.message}</p>`;
            }
        }
        
       async function showAlarmStatus(alarmId) {
            const alarm = userAlarms.find(a => a.id === alarmId);
            if (!alarm) return;
            
            const panelContent = document.getElementById('alarmStatusContent');
            document.getElementById('alarmStatusTitle').textContent = `"${alarm.name}" Anlƒ±k Durumu`;
            panelContent.innerHTML = '<div style="text-align:center; padding: 40px;"><div class="loading" style="width:30px; height:30px;"></div></div>';
            showPanel('alarmStatusPanel');

            try {
                const checkAlarmStatus = functions.httpsCallable('checkAlarmStatus');
                const result = await checkAlarmStatus({ alarm });
                const { statuses } = result.data;

                let contentHTML = '<div class="indicator-cards-container" style="padding-top:0;">';

                statuses.forEach(item => {
                    if (item.error) {
                        contentHTML += `<div class="indicator-card"><h4>${item.coin.replace("USDT", "")}</h4><p style="color:var(--accent-red)">Durum alƒ±namadƒ±: ${item.error}</p></div>`;
                        return;
                    }
                    
                    const renderStatus = (label, condition, isEnabled) => {
                        if (!isEnabled) return '';

                        const isMet = condition.met;
                        const icon = isMet ? '<i class="fas fa-check-circle" style="color: var(--value-positive);"></i>' : '<i class="fas fa-times-circle" style="color: var(--value-negative);"></i>';
                        const text = isMet ? 'SAƒûLANDI' : 'BEKLENƒ∞YOR';
                        
                        return `
                            <div class="indicator-item" style="flex-direction: column; align-items: flex-start; gap: 4px;">
                                <div style="display: flex; justify-content: space-between; width: 100%;">
                                    <span class="label">${label}</span>
                                    <span class="value" style="font-size: 0.9rem;">${icon} ${text}</span>
                                </div>
                                <small style="color: var(--text-secondary);">${condition.details}</small>
                            </div>
                        `;
                    };

                    contentHTML += `
                        <div class="indicator-card">
                            <div class="indicator-card-header" style="margin-bottom: 10px; padding-bottom: 10px;">
                                <h4>${item.coin.replace("USDT", "")}</h4>
                                <span style="font-size: 1.1rem; font-weight: 600;">$${formatPrice(item.currentPrice)}</span>
                            </div>
                            <div class="indicator-details-grid" style="gap: 12px;">
                                ${renderStatus('Hacim Artƒ±≈üƒ±', item.status.volume, alarm.conditions.volume?.enabled)}
                                ${renderStatus('Hacim Tutarƒ±', item.status.volumeAmount, alarm.conditions.volume?.enabled && alarm.conditions.volume?.amount > 0)}
                                ${renderStatus('MACD Kesi≈üimi', item.status.macd, alarm.conditions.macd?.enabled)}
                                ${renderStatus('G√º√ßl√º Trend', item.status.trend, alarm.trendFilterEnabled)}
                                ${renderStatus('Fibonacci Destek', item.status.fibonacci, alarm.conditions.fibonacci?.enabled)}
                            </div>
                        </div>
                    `;
                });

                contentHTML += '</div>';
                panelContent.innerHTML = contentHTML;

            } catch (error) {
                console.error("Alarm durumu alƒ±nƒ±rken hata:", error);
                panelContent.innerHTML = `<p style="color:var(--accent-red); text-align:center;">Durum bilgisi alƒ±namadƒ±: ${error.message}</p>`;
            }
        }

        // --- EVENT LISTENERS ---
        document.getElementById('logoutBtn').addEventListener('click', (e) => { e.preventDefault(); auth.signOut(); });
        document.getElementById('refreshBtn').addEventListener('click', fetchAllDataAndRender);
        document.getElementById('addCoinBtn').addEventListener('click', () => addNewAsset('crypto'));
        document.getElementById('newCoinInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') addNewAsset('crypto'); });
        document.getElementById('addCoinBtn-ai').addEventListener('click', addNewAssetAi);
        document.getElementById('newCoinInput-ai').addEventListener('keypress', (e) => { if (e.key === 'Enter') addNewAssetAi(); });
        document.getElementById('toggleSortBtn-ai').addEventListener('click', () => {
            document.querySelectorAll('#crypto-ai-content .drag-handle-col').forEach(el => el.classList.toggle('hidden'));
        });
        document.getElementById('settingsBtn').addEventListener('click', () => showPanel('settingsPanel'));
        document.querySelectorAll('.close-btn').forEach(btn => btn.addEventListener('click', closeAllPanels));
        document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
        modalOverlay.addEventListener('click', closeAllPanels);
        document.getElementById('toggleSortBtn').addEventListener('click', () => {
            document.querySelectorAll('#crypto-content .drag-handle-col').forEach(el => el.classList.toggle('hidden'));
        });
        document.querySelector('#crypto-content thead').addEventListener('click', (e) => {
            const header = e.target.closest('th.sortable');
            if (!header) return;

            const key = header.dataset.sortKey;
            
            if (currentSort.key !== key) {
                currentSort.key = key;
                currentSort.order = 'asc';
            } else {
                if (currentSort.order === 'asc') {
                    currentSort.order = 'desc';
                } else if (currentSort.order === 'desc') {
                    currentSort.key = null;
                    currentSort.order = 'default';
                }
            }
            sortAndRenderTable();
        });

        trackerPage.addEventListener('click', async (e) => {

            // Portf√∂y y√∂netimi
            if(e.target.closest('#newPortfolioBtn')) {
                const newName = prompt("Yeni listenin adƒ±nƒ± girin:", "Yeni Listem");
                if (newName && !userPortfolios[newName]) {
                    userPortfolios[newName] = [];
                    await setActivePortfolio(newName);
                    savePortfoliosToFirestore();
                } else if(newName) {
                    alert("Bu isimde bir liste zaten var!");
                }
                return;
            }
            if(e.target.closest('#deletePortfolioBtn')) {
                if(Object.keys(userPortfolios).length <= 1) {
                    alert("Son listeyi silemezsiniz!");
                    return;
                }
                if(confirm(`"${activePortfolio}" listesini silmek istediƒüinizden emin misiniz? Bu i≈ülem geri alƒ±namaz.`)) {
                    delete userPortfolios[activePortfolio];
                    const newActive = Object.keys(userPortfolios)[0];
                    await setActivePortfolio(newActive);
                    savePortfoliosToFirestore();
                }
                return;
            }
            if(e.target.closest('#renamePortfolioBtn')) {
                const newName = prompt("Yeni adƒ± girin:", activePortfolio);
                 if (newName && newName !== activePortfolio && !userPortfolios[newName]) {
                    userPortfolios[newName] = userPortfolios[activePortfolio];
                    delete userPortfolios[activePortfolio];
                    await setActivePortfolio(newName);
                    savePortfoliosToFirestore();
                } else if(newName) {
                     alert("Ge√ßersiz veya zaten kullanƒ±mda olan bir isim girdiniz.");
                }
                return;
            }

            // Sinyal Analizini √áalƒ±≈ütƒ±rma
            if (e.target.closest('#runSignalAnalysisBtn')) {
                const btn = e.target.closest('#runSignalAnalysisBtn');
                showLoading(btn);

                const coinInput = document.getElementById('signalAnalysisCoins').value;
                const coins = coinInput.split(',').map(s => s.trim().toUpperCase()).filter(Boolean).map(s => s.endsWith('USDT') ? s : s + 'USDT');
                
                if(coins.length === 0) {
                    showNotification("L√ºtfen en az bir coin girin.", false);
                    hideLoading(btn);
                    return;
                }

                const params = {
                    coins: coins,
                    timeframe: document.getElementById('signalAnalysisTimeframe').value,
                    changePercent: parseFloat(document.getElementById('signalAnalysisChange').value),
                    direction: document.getElementById('signalAnalysisDirection').value,
                    days: parseInt(document.getElementById('signalAnalysisPeriod').value)
                };

                const resultContainer = document.getElementById('signalAnalysisResultContainer');
                resultContainer.innerHTML = '<div class="loading" style="margin: 20px auto; display:block;"></div>';

                try {
                    const findSignalDNA = functions.httpsCallable('findSignalDNA');
                    const result = await findSignalDNA(params);
                    const data = result.data;
                    
                    let html = '';
                    for(const coin in data) {
                        const res = data[coin];
                        html += `<div class="backtest-card" style="margin-bottom:15px;"><h4>${coin.replace("USDT","")} Analiz Sonu√ßlarƒ±</h4>`;
                        if(res.error) {
                            html += `<p style="color:var(--accent-red)">Hata: ${res.error}</p>`;
                        } else if(res.totalEvents === 0) {
                            html += `<p>Belirtilen ko≈üullarda (${params.direction === 'up' ? '+' : '-'}${params.changePercent}%) hi√ß olay bulunamadƒ±.</p>`;
                        } else {
                            const mostCommonFib = Object.entries(res.fibDistribution).sort((a,b) => b[1] - a[1])[0];
                            const recommendationParts = [];
                            
                            if(res.avgVolume > 500000) recommendationParts.push(`y√ºksek hacimle (ortalama <strong>${formatVolume(res.avgVolume)}</strong>)`);
                            if(res.avgAdx > 25) recommendationParts.push(`g√º√ßl√º bir trend (ortalama ADX <strong>${res.avgAdx.toFixed(1)}</strong>) varken`);
                            if(mostCommonFib) recommendationParts.push(`fiyat √ßoƒüunlukla <strong>${mostCommonFib[0]}</strong> b√∂lgesindeyken`);

                            html += `
                                <p>Belirtilen ko≈üul, son ${params.days} g√ºnde <strong>${res.totalEvents}</strong> kez ger√ßekle≈üti.</p>
                                <p style="border-top: 1px solid var(--border-color); padding-top:10px; margin-top:10px;">
                                    <strong>üí° Tavsiye:</strong> Bu hareketler genellikle ${recommendationParts.join(', ')} ger√ßekle≈üiyor.
                                    Bu bilgilere g√∂re bir alarm kurmak, ba≈üarƒ± oranƒ±nƒ± artƒ±rabilir. √ñrneƒüin, Hacim ko≈üulunu <strong>${formatVolume(res.avgVolume / 2)}</strong> √ºzerine, Trend Filtresini (ADX) <strong>25</strong> √ºzerine ayarlayabilirsiniz.
                                </p>
                            `;
                        }
                        html += `</div>`;
                    }
                    resultContainer.innerHTML = html;

                } catch (error) {
                    console.error("Sinyal analizi hatasƒ±:", error);
                    resultContainer.innerHTML = `<p style="color:var(--accent-red)">Analiz sƒ±rasƒ±nda bir hata olu≈ütu: ${error.message}</p>`;
                } finally {
                    hideLoading(btn);
                }
                return;
            }

            const strategyBtn = e.target.closest('.strategy-btn');
            if(strategyBtn) {
                document.querySelector('#strategyPresetFilters button.active')?.classList.remove('active');
                strategyBtn.classList.add('active');
                
                const preset = strategyBtn.dataset.preset;
                const customIndicatorSection = document.getElementById('customIndicatorSection');
                const indicatorCheckboxes = document.querySelectorAll(`#crypto-indicator-filters-grid input`);

                if (preset === 'custom') {
                    customIndicatorSection.style.display = 'block';
                } else {
                    customIndicatorSection.style.display = 'none';
                    const activeIndicators = STRATEGY_PRESETS[preset];
                    
                    indicatorCheckboxes.forEach(checkbox => {
                        const indicatorKey = checkbox.dataset.indicator;
                        checkbox.checked = activeIndicators.hasOwnProperty(indicatorKey) && activeIndicators[indicatorKey];
                    });
                }
                return;
            }
            const collapsibleHeader = e.target.closest('.collapsible-header');
            if (collapsibleHeader) {
                const parentCollapsible = collapsibleHeader.closest('.collapsible');
                if (parentCollapsible) {
                    const content = parentCollapsible.querySelector('.collapsible-content');
                    if (content) {
                        collapsibleHeader.classList.toggle('open');
                        content.classList.toggle('open');
                    }
                }
                return;
            }

            const tabLink = e.target.closest('.tab-link');
            if(tabLink && !tabLink.classList.contains('active')) {
                document.querySelector('.tab-link.active')?.classList.remove('active');
                document.querySelector('.tab-content.active')?.classList.remove('active');
                tabLink.classList.add('active');
                document.getElementById(`${tabLink.dataset.tab}-content`)?.classList.add('active');
                return;
            }

            const assetActionTarget = e.target.closest('.asset-cell, .clickable-pct, .remove-btn, .remove-btn-ai');
            if(assetActionTarget) {
                const { pair, type, col } = assetActionTarget.dataset;
                if (!pair) return;
                const assetData = allCryptoData.find(c => c.pair === pair);

                if (assetActionTarget.classList.contains('asset-cell')) { 
                    showChart(pair, type); 
                }
                else if (assetActionTarget.classList.contains('clickable-pct')) {
                    if (assetData && !assetData.error) {
                        const colData = assetData[`col${col}`];
                        if (colData && typeof colData.pct === 'number') {
                            const periodName = settings.columns[col].name;
                            const pctChange = colData.pct.toFixed(2);
                            
                            document.getElementById('detailPanelTitle').textContent = `${assetData.pair.replace('USDT','')} - ${periodName} Deƒüi≈üim Detayƒ±`;
                            document.getElementById('detailPanelContent').innerHTML = translations[settings.lang].lowest_price_detail(
                                periodName,
                                formatPrice(colData.lowestPrice), 
                                colData.lowestDate,
                                formatPrice(assetData.latestPrice),
                                pctChange
                            );
                            showPanel('detailPanel');
                        }
                    }
                } else if (assetActionTarget.classList.contains('remove-btn')) {
                    userPortfolios[activePortfolio] = userPortfolios[activePortfolio].filter(p => p !== pair);
                    savePortfoliosToFirestore();
                    fetchAllDataAndRender();
                } else if (assetActionTarget.classList.contains('remove-btn-ai')) {
                    const pairToRemove = assetActionTarget.dataset.pair;
                    cryptoAiPairs = cryptoAiPairs.filter(p => p !== pairToRemove);
                    if (userDocRef) { userDocRef.update({ coins_ai: cryptoAiPairs }); }
                    fetchAiDataAndRender();
                }
            }

            const pivotFilterBtn = e.target.closest('#cryptoPivotFilters button');
            if(pivotFilterBtn) {
                 settings.cryptoPivotFilter = pivotFilterBtn.dataset.filter;
                 if (userDocRef) userDocRef.update({ 'settings.cryptoPivotFilter': settings.cryptoPivotFilter });
                 document.querySelector('#cryptoPivotFilters button.active').classList.remove('active');
                 pivotFilterBtn.classList.add('active');
                 renderSupportResistance('crypto', allCryptoData);
                 return;
            }
            const intervalFilterBtn = e.target.closest('#cryptoIntervalFilters button');
            if(intervalFilterBtn && !intervalFilterBtn.classList.contains('active')) {
                document.querySelector('#cryptoIntervalFilters button.active').classList.remove('active');
                intervalFilterBtn.classList.add('active');
            }
             const recommendationFilterBtn = e.target.closest('#cryptoRecommendationFilters button');
            if(recommendationFilterBtn) {
                 currentRecommendationFilter = recommendationFilterBtn.dataset.filter;
                 document.querySelector('#cryptoRecommendationFilters button.active').classList.remove('active');
                 recommendationFilterBtn.classList.add('active');
                 renderIndicatorCards('crypto');
                 return;
            }

            if (e.target.closest('#createNewAlarmBtn')) {
                if (!settings.telegramPhone) {
                    showNotification("L√ºtfen √∂nce Ayarlar men√ºs√ºnden Telegram Chat ID'nizi kaydedin.", false);
                    return;
                }
                openAlarmPanel(null);
            }
            
            const alarmCard = e.target.closest('.alarm-card');
            if(alarmCard) {
                const alarmId = alarmCard.dataset.alarmId;
                if(e.target.closest('.edit-alarm-btn')) {
                    const alarm = userAlarms.find(a => a.id === alarmId);
                    openAlarmPanel(alarm);
                }
                if(e.target.closest('.delete-alarm-btn')) {
                    if(confirm("Bu alarmƒ± silmek istediƒüinizden emin misiniz?")) {
                        userAlarms = userAlarms.filter(a => a.id !== alarmId);
                        await userDocRef.update({ alarms: userAlarms });
                        renderAlarms();
                        showNotification("Alarm silindi.", true);
                    }
                }
                if (e.target.matches('.alarm-status-toggle')) {
                    const alarm = userAlarms.find(a => a.id === alarmId);
                    alarm.isActive = e.target.checked;
                    await userDocRef.update({ alarms: userAlarms });
                    showNotification(`Alarm ${alarm.isActive ? 'aktif' : 'pasif'} edildi.`, true);
                }
                 if(e.target.closest('.backtest-alarm-btn')) {
                    runBacktest(alarmId);
                }
                 if (e.target.closest('.check-alarm-status-btn')) {
                    showAlarmStatus(alarmId);
                }
            }
        });

        document.getElementById('updateCryptoAnalysisBtn').addEventListener('click', () => updateAnalysisSettings('crypto'));
        document.getElementById('analyzeAllCryptoBtn').addEventListener('click', () => getGeminiAnalysis('crypto'));
        document.getElementById('crypto-indicator-cards-container').addEventListener('click', (e) => {
            const target = e.target.closest('.ai-btn');
            if (target) getGeminiAnalysis(target.dataset.type, target.dataset.pair);
        });
        
        document.getElementById('saveAlarmBtn').addEventListener('click', saveAlarm);
        document.getElementById('addCoinToAlarmBtn').addEventListener('click', () => {
            const input = document.getElementById('addCoinToAlarmInput');
            const newCoins = input.value.split(',').map(s => s.trim().toUpperCase()).filter(Boolean);
            newCoins.forEach(coinSymbol => {
                const newPair = coinSymbol.endsWith('USDT') ? coinSymbol : coinSymbol + 'USDT';
                if (newPair && !tempAlarmCoins.includes(newPair)) {
                    tempAlarmCoins.push(newPair);
                }
            });
            renderAlarmCoinTags();
            input.value = '';
        });
        document.getElementById('alarmCoinSelectionGrid').addEventListener('click', (e) => {
            if(e.target.classList.contains('remove-coin-tag')) {
                const coinToRemove = e.target.dataset.coin;
                tempAlarmCoins = tempAlarmCoins.filter(c => c !== coinToRemove);
                renderAlarmCoinTags();
            }
        });
        document.getElementById('testAlarmBtn').addEventListener('click', async (e) => {
            const btn = e.currentTarget;
            const chatId = document.getElementById('telegramPhoneInput').value;
            if(!chatId) {
                showNotification("L√ºtfen √∂nce Ayarlar'dan Telegram Chat ID'nizi kaydedin.", false);
                return;
            }
            showLoading(btn);
            try {
                const sendTestNotification = functions.httpsCallable('sendTestNotification');
                await sendTestNotification({ chatId: chatId });
                showNotification("Test bildirimi ba≈üarƒ±yla g√∂nderildi!", true);
            } catch (error) {
                console.error("Test bildirimi hatasƒ±:", error);
                showNotification(`Bildirim g√∂nderilemedi: ${error.message}`, false);
            } finally {
                hideLoading(btn);
            }
        });

        document.getElementById('portfolioSelect').addEventListener('change', (e) => setActivePortfolio(e.target.value));

        sortableInstance = new Sortable(document.getElementById('cryptoPriceTable'), {
            handle: '.drag-handle',
            animation: 150,
            onEnd: (evt) => {
                const [movedItem] = userPortfolios[activePortfolio].splice(evt.oldIndex, 1);
                userPortfolios[activePortfolio].splice(evt.newIndex, 0, movedItem);
                savePortfoliosToFirestore();
            }
        });

        sortableInstanceAi = new Sortable(document.getElementById('cryptoAiPriceTable'), {
            handle: '.drag-handle',
            animation: 150,
            onEnd: (evt) => {
                const [movedItem] = cryptoAiPairs.splice(evt.oldIndex, 1);
                cryptoAiPairs.splice(evt.newIndex, 0, movedItem);
                if (userDocRef) { userDocRef.update({ coins_ai: cryptoAiPairs }); }
            }
        });
        
        // --- INITIAL RENDER ---
        renderIndicatorFilters();
        renderDictionary();
        renderAlarms();
        applySettings();
        renderPortfolioSelect();
        await fetchAllDataAndRender();
        await fetchAiDataAndRender();
        updateAdminUI();
    }
</script>
   

</body>
</html>
