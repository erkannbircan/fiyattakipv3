<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fiyat Takipçisi (AI Analizli)</title>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-functions-compat.js"></script>

    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

    <style>
        :root {
            --bg-primary: #131722; --bg-secondary: #1e222d; --bg-tertiary: #2a2e39;
            --border-color: #424651; --text-primary: #d1d4dc; --text-secondary: #8c92a2;
            --accent-blue: #2962ff; --accent-green: #26a69a; --accent-red: #ef5350; --accent-yellow: #f59e0b;
            --strong-buy: #00bfa5; --buy: #26a69a; --hold: #8c92a2; --sell: #ef5350; --strong-sell: #d50000;
            --value-positive: #26de81; --value-negative: #ff4757;
        }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif; margin: 0; background-color: var(--bg-primary); color: var(--text-primary);
            overflow-x: hidden; -webkit-tap-highlight-color: transparent;
        }
        body.modal-open { overflow: hidden; }
        .page { min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 10px; box-sizing: border-box; }
        .login-container { background: var(--bg-secondary); padding: 40px; border-radius: 12px; border: 1px solid var(--border-color); width: 100%; max-width: 400px; text-align: center; margin-top: 10vh; }
        .login-container h1 { color: var(--text-primary); font-size: 2rem; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .login-container h1 .fas { color: var(--accent-yellow); }
        .login-container p { margin-bottom: 30px; color: var(--text-secondary); }
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 0.9rem; color: var(--text-secondary); }
        .login-container input { width: 100%; padding: 12px 15px; border: 1px solid var(--border-color); background-color: var(--bg-tertiary); color: var(--text-primary); border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        .button-group { display: flex; gap: 10px; margin-top: 25px; }
        .login-container button { flex-grow: 1; background-color: var(--accent-blue); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; }
        #error-message { color: var(--accent-red); margin-top: 15px; font-weight: 500; min-height: 20px; }
        .tracker-container { width: 100%; max-width: 1200px; margin: 0 auto; background-color: var(--bg-secondary); border-radius: 12px; padding: 20px; border: 1px solid var(--border-color); }
        .app-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .app-header .header-left h1 { color: var(--text-primary); font-size: 1.8rem; margin: 0; display: flex; align-items: center; gap: 12px; }
        .app-header .header-left h1 .fas { color: var(--accent-yellow); }
        .app-header .header-right { display: flex; align-items: center; gap: 10px; }
        .app-header .main-actions button { background-color: var(--bg-tertiary); color: var(--text-secondary); padding: 8px 16px; font-size: 0.9rem; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; }
        .user-menu { position: relative; }
        #userMenuBtn { background-color: var(--bg-tertiary); color: var(--text-primary); padding: 8px 12px; display: flex; align-items: center; gap: 8px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; }
        .dropdown-content { display: none; position: absolute; right: 0; background-color: var(--bg-secondary); min-width: 200px; box-shadow: 0 8px 16px rgba(0,0,0,0.4); z-index: 100; border-radius: 8px; border: 1px solid var(--border-color); overflow: hidden; }
        .dropdown-content a { color: var(--text-primary); padding: 12px 16px; text-decoration: none; display: flex; align-items: center; gap: 10px; font-size: 0.95rem; }
        .dropdown-content a:hover { background-color: var(--bg-tertiary); }
        .user-menu:hover .dropdown-content { display: block; }
        .add-asset-bar { display: flex; gap: 10px; margin-bottom: 25px; }
        .add-asset-bar input { flex-grow: 1; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; background-color: var(--bg-tertiary); color: var(--text-primary); }
        .add-asset-bar button { padding: 12px 20px; background-color: var(--accent-blue); border-radius: 8px; border: none; color: white; cursor: pointer; }
        .table-controls { display: flex; justify-content: flex-end; margin-bottom: 10px; }
        .table-controls button { background-color: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 8px; cursor: pointer; }
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        th, td { padding: 14px 10px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        th { color: var(--text-secondary); font-weight: 500; position: sticky; top: 0; background-color: var(--bg-secondary); z-index: 1; }
        th.sortable { cursor: pointer; }
        th.sortable:hover { color: var(--text-primary); }
        th .sort-indicator { margin-left: 8px; opacity: 0.5; transition: opacity 0.2s; display: inline-block; width: 1em; text-align: center;}
        th.asc .sort-indicator, th.desc .sort-indicator { opacity: 1; }
        th.asc .sort-indicator::before { content: '▲'; }
        th.desc .sort-indicator::before { content: '▼'; }
        td { color: var(--text-primary); }
        .asset-cell { font-weight: 600; color: #64b5f6; cursor: pointer; }
        .asset-cell:hover { text-decoration: underline; }
        .asset-cell .symbol { display:none; }
        .drag-handle-col { width: 20px; padding: 0 10px; }
        .drag-handle-col.hidden, #cryptoPriceTable .drag-handle-col.hidden { display: none; }
        .drag-handle { cursor: grab; padding: 0 10px; color: #9ca3af; }
        tr:hover td { background-color: var(--bg-tertiary); }
        .positive { color: var(--accent-green); }
        .positive-high { font-weight: 600; }
        .positive-low { font-weight: 600; }
        .negative { color: var(--accent-red); font-weight: 600; }
        .clickable-pct { cursor: pointer; text-decoration: underline; text-decoration-style: dotted; text-decoration-color: var(--text-secondary); }
        .update-time { text-align: center; margin: 20px 0 10px 0; color: var(--text-secondary); font-size: 0.85rem; }
        .action-btn { background-color: transparent; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1rem; }
        .action-btn:hover { color: var(--accent-red); }
        .loading { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease; }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .panel { position: fixed; top: 50%; left: 50%; background-color: var(--bg-secondary); padding: 0; border-radius: 12px; border: 1px solid var(--border-color); z-index: 1001; width: clamp(300px, 90vw, 650px); max-height: 90vh; overflow: hidden; opacity: 0; visibility: hidden; transform: translate(-50%, -50%) scale(0.95); transition: opacity 0.3s ease, transform 0.3s ease; display: flex; flex-direction: column; }
        .panel.show { opacity: 1; visibility: visible; transform: translate(-50%, -50%) scale(1); }
        .panel-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .panel-header h3 { margin: 0; color: var(--text-primary); font-size: 1.6rem; }
        .panel-controls { display: flex; gap: 10px; }
        .panel-btn { background: none; color: var(--text-secondary); cursor: pointer; border: none; font-size: 1.2rem; padding: 5px; }
        .panel-content { padding: 20px 30px; overflow-y: auto; flex-grow: 1; }
        .collapsible { margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; }
        .collapsible-header { padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; background-color: var(--bg-tertiary); }
        .collapsible-header .fas { transition: transform 0.3s ease; }
        .collapsible-header.open .fas { transform: rotate(180deg); }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out, padding 0.4s ease; padding: 0 15px; background-color: var(--bg-secondary); }
        .collapsible-content.open { max-height: 4000px; padding: 15px; border-top: 1px solid var(--border-color); }
        .notification { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); background-color: var(--bg-tertiary); color: var(--text-primary); padding: 14px 25px; border-radius: 8px; z-index: 1003; border: 1px solid var(--border-color); opacity: 0; visibility: hidden; transition: all 0.4s ease; }
        .notification.show { opacity: 1; transform: translateX(-50%) translateY(-20px); visibility: visible; }
        .tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 25px; overflow-x: auto; }
        .tab-link { padding: 10px 15px; cursor: pointer; color: var(--text-secondary); border-bottom: 2px solid transparent; white-space: nowrap; font-size: 0.9rem; }
        .tab-link.active { color: var(--text-primary); font-weight: 600; background-color: var(--bg-tertiary); border-color: var(--accent-blue); border-top-left-radius: 6px; border-top-right-radius: 6px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        #chartPanel { width: 90vw; max-width: 1200px; height: 80vh; padding: 0; }
        #chartContainer { width: 100%; flex-grow: 1; }
        .analysis-section { background-color: var(--bg-tertiary); padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--border-color); }
        .analysis-section h4 { color: #64b5f6; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-top: 0; font-size: 1.5rem; }
        .analysis-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px 20px; margin-bottom: 15px; }
        .analysis-item { display: flex; justify-content: space-between; background-color: rgba(255,255,255,0.03); padding: 8px 12px; border-radius: 6px; }
        .analysis-item .label { color: var(--text-secondary); }
        .analysis-item .value { font-weight: 600; }
        .analysis-summary { line-height: 1.6; margin-bottom: 10px; }
        .analysis-recommendation { font-weight: bold; font-size: 1.1rem; }
        .recommendation-al, .recommendation-guclu-al { font-weight: bold; color: var(--strong-buy); }
        .recommendation-sat, .recommendation-guclu-sat { font-weight: bold; color: var(--strong-sell); }
        .recommendation-tut { font-weight: bold; color: var(--accent-yellow); }
        .filters-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .filter-item { display: flex; align-items: center; background-color: var(--bg-tertiary); padding: 10px; border-radius: 6px; }
        .filter-item input { margin-right: 10px; accent-color: var(--accent-blue); }
        .analysis-actions { display: flex; justify-content: flex-start; align-items: center; margin-top: 20px; flex-wrap: wrap; gap: 15px; }
        .analysis-actions button { background-color: var(--accent-blue); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1rem; display: flex; align-items: center; gap: 8px;}
        .global-analysis-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 15px;}
        .global-analysis-header h3 { margin: 0; color: var(--text-primary); font-size: 1.5rem; font-weight: 600; flex-basis: 100%; text-align: center; margin-bottom: 15px; }
        .global-analysis-controls { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .interval-filters { display: flex; gap: 10px; justify-content: center; flex-grow: 1; }
        .interval-filters button { background-color: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 20px; cursor: pointer; }
        .interval-filters button.active { background-color: var(--accent-blue); color: white; border-color: var(--accent-blue); }
        .ai-btn { background: linear-gradient(45deg, #4285F4, #9B72CB); color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 8px;}
        .indicator-cards-container { display: grid; grid-template-columns: 1fr; gap: 20px; margin-top: 20px; }
        .indicator-card { background: linear-gradient(145deg, var(--bg-tertiary), var(--bg-secondary)); border-radius: 12px; border: 1px solid var(--border-color); padding: 20px; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .indicator-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .indicator-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .indicator-card-header h4 { margin: 0; font-size: 1.5rem; color: #64b5f6; }
        .recommendation-badge { padding: 5px 12px; border-radius: 15px; font-weight: bold; color: white; font-size: 0.9rem; }
        .indicator-details-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .indicator-item { display: flex; justify-content: space-between; align-items: center; background-color: rgba(255,255,255,0.03); padding: 8px 12px; border-radius: 6px; }
        .indicator-item .label { font-size: 0.9rem; color: var(--text-secondary); }
        .indicator-item .value { font-size: 1rem; font-weight: 600; }
        .indicator-item .value.value-positive { color: var(--value-positive); }
        .indicator-item .value.value-negative { color: var(--value-negative); }
        .card-footer { margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .card-footer .summary { flex-grow: 1; }
        .card-footer .summary p { margin: 0; font-size: 0.9rem; line-height: 1.5; color: var(--text-primary); }
        .dictionary-item { margin-bottom: 20px; }
        .dictionary-item h5 { color: #64b5f6; margin: 0 0 8px 0; font-size: 1.1rem; }
        .dictionary-item p { margin: 0 0 10px 0; line-height: 1.6; color: var(--text-secondary); }
        .dictionary-item .example { background-color: var(--bg-tertiary); padding: 10px; border-radius: 6px; font-style: italic; color: var(--text-primary); }
        .settings-section { margin-bottom: 25px; }
        .settings-section h4 { margin: 0 0 15px 0; color: var(--text-primary); font-size: 1.1rem; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .setting-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .setting-item label { font-weight: 500; color: var(--text-secondary); }
        .setting-item input, .setting-item select { background-color: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 8px; padding: 8px 12px; }
        .color-input-wrapper { display: flex; align-items: center; gap: 10px; }
        .color-preview { width: 24px; height: 24px; border-radius: 4px; border: 1px solid var(--border-color); }
        #saveSettingsBtn { width: 100%; padding: 14px; font-size: 1.1rem; background-color: var(--accent-blue); border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; }
        .pivot-filters { display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap; }
        .pivot-filters button { background-color: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 20px; cursor: pointer; }
        .pivot-filters button.active { background-color: var(--accent-blue); color: white; border-color: var(--accent-blue); }
        .pivot-container { display: flex; flex-direction: column; gap: 15px; }
        .pivot-bar-card { background-color: var(--bg-tertiary); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); }
        .pivot-bar-header { margin: 0 0 20px 0; color: #64b5f6; font-size: 1.2rem; font-weight: 600; }
        .pivot-bar-container { position: relative; height: 50px; display: flex; align-items: center; }
        .pivot-bar { height: 10px; width: 100%; border-radius: 5px; background: linear-gradient(to right, var(--accent-red), var(--accent-yellow), var(--accent-green)); position: relative; }
        .pivot-marker { position: absolute; top: -5px; height: 20px; width: 2px; background-color: rgba(255, 255, 255, 0.6); transform: translateX(-50%); }
        .pivot-values { display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.8rem; color: var(--text-secondary); flex-wrap: wrap; }
        .current-price-indicator { position: absolute; top: 50%; transform: translate(-50%, -50%); width: 16px; height: 16px; background-color: var(--accent-blue); border: 2px solid white; border-radius: 50%; z-index: 3; transition: left 0.5s ease-out; }
        .current-price-indicator::before { content: attr(data-price); position: absolute; top: -25px; left: 50%; transform: translateX(-50%); background-color: var(--bg-primary); color: white; padding: 2px 6px; border-radius: 5px; font-size: 0.8rem; font-weight: bold; z-index: 2; white-space: nowrap; border: 1px solid var(--border-color); }
        .pivot-dictionary { margin-top: 20px; background-color: var(--bg-tertiary); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 0.9rem;}
        .pivot-dictionary p { margin: 5px 0; }
        .pivot-dictionary span { font-weight: bold; color: var(--text-primary); }
        @media (max-width: 768px) {
            th, td { padding: 12px 6px; font-size: 0.85rem; }
            .app-header .header-left h1 { font-size: 1.4rem; }
            .add-asset-bar { flex-direction: column; }
            .add-asset-bar button { width: 100%; }
            .pivot-values { font-size: 0.7rem; }
        }
    </style>
</head>
<body>

    <script>
    // #############################################################################
    // # DİKKAT! BURAYA KENDİ FIREBASE PROJE BİLGİLERİNİZİ GİRMENİZ GEREKİYOR! #
    // #############################################################################
    const firebaseConfig = {
  apiKey: "AIzaSyA3flTu3Jz9E1D1U_DympYE7B4I4FDxj88",
  authDomain: "fiyattakipv3.firebaseapp.com",
  projectId: "fiyattakipv3",
  storageBucket: "fiyattakipv3.firebasestorage.app",
  messagingSenderId: "440839843277",
  appId: "1:440839843277:web:2c9c15e4a103e8b2f2e884"
};
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const functions = firebase.functions();

    // --- GLOBAL STATE ---
    let currentUserRole = null, coinLimit = 10, settings = {}, autoRefreshTimer = null, pageInitialized = false;
    let allCryptoData = [];
    let currentSort = { key: null, order: 'default' }; // 'default', 'asc', 'desc'
    let cryptoPairs = [];
    let userDocRef = null;
    let sortableInstance = null;
    const loginPage = document.getElementById('login-page'), trackerPage = document.getElementById('tracker-page'), notification = document.getElementById("notification"), modalOverlay = document.getElementById('modalOverlay');

    const AVAILABLE_INDICATORS = {
        ema: "EMA", sma: "SMA", rsi: "RSI", macd: "MACD",
        bollinger: "Bollinger Bands", stochRsi: "Stochastic RSI",
        volume: "Hacim (24s)", atr: "ATR", ichimoku: "Ichimoku Cloud", fibonacci: "Fibonacci"
    };
    
    // ... (Diğer fonksiyonlar aynı kaldığı için kısa kesildi)

    // Sadece güncellenen fonksiyonlar aşağıdadır
    
    function sortAndRenderTable() {
        const { key, order } = currentSort;
        let sortedData = [...allCryptoData];

        if (order !== 'default') {
            sortedData.sort((a, b) => {
                let valA, valB;
                if (key.startsWith('col')) {
                    valA = a[key]?.pct;
                    valB = b[key]?.pct;
                } else {
                    valA = a[key];
                    valB = b[key];
                }

                if (a.error) return 1; if (b.error) return -1;
                if (valA === undefined || valA === null) return 1;
                if (valB === undefined || valB === null) return -1;

                if (typeof valA === 'string') {
                    return order === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                } else {
                    return order === 'asc' ? valA - valB : valB - valA;
                }
            });
        }
        // 'default' durumunda allCryptoData (orijinal sıralama) kullanılır

        document.querySelectorAll('#crypto-content th.sortable').forEach(th => {
            th.classList.remove('asc', 'desc');
            if (th.dataset.sortKey === key && order !== 'default') {
                th.classList.add(order);
            }
        });

        updateAllTableRows('crypto', sortedData);
    }

    function renderSupportResistance(type, data) {
        const container = document.getElementById('crypto-pivot-container');
        container.innerHTML = '';
        document.getElementById('pivot-dictionary-container').innerHTML = `
            <div class="pivot-dictionary">
                <p><span>P:</span> Pivot Noktası (Referans)</p>
                <p><span>R1, R2:</span> Direnç Seviyeleri (Yükseliş Hedefleri)</p>
                <p><span>S1, S2:</span> Destek Seviyeleri (Düşüş Durakları)</p>
            </div>`;

        const filter = settings[`${type}PivotFilter`];
        data.filter(asset => !asset.error && asset.sr).forEach(asset => {
            if ((filter === 'above' && asset.latestPrice < asset.sr.pivot) || (filter === 'below' && asset.latestPrice > asset.sr.pivot)) return;

            const { s2, s1, pivot, r1, r2 } = asset.sr;
            const min = s2, max = r2;
            if (max <= min) return;
            const range = max - min;
            const getPosition = (value) => Math.max(0, Math.min(100, ((value - min) / range) * 100));

            const card = document.createElement('div');
            card.className = 'pivot-bar-card';
            card.innerHTML = `
                <h4 class="pivot-bar-header">${asset.pair.replace("USDT", "")} - Günlük Pivot Seviyeleri</h4>
                <div class="pivot-bar-container">
                    <div class="pivot-bar">
                        <div class="pivot-marker" style="left: ${getPosition(s2)}%;"></div>
                        <div class="pivot-marker" style="left: ${getPosition(s1)}%;"></div>
                        <div class="pivot-marker" style="left: ${getPosition(pivot)}%;"></div>
                        <div class="pivot-marker" style="left: ${getPosition(r1)}%;"></div>
                        <div class="pivot-marker" style="left: ${getPosition(r2)}%;"></div>
                    </div>
                    <div class="current-price-indicator" style="left: ${getPosition(asset.latestPrice)}%;" data-price="${formatPrice(asset.latestPrice)}"></div>
                </div>
                <div class="pivot-values">
                    <span>S2: ${formatPrice(s2)}</span>
                    <span>S1: ${formatPrice(s1)}</span>
                    <span>P: ${formatPrice(pivot)}</span>
                    <span>R1: ${formatPrice(r1)}</span>
                    <span>R2: ${formatPrice(r2)}</span>
                </div>
            `;
            container.appendChild(card);
        });
    }

    async function getGeminiAnalysis(type, pair = null) {
        // ... (Bu fonksiyon bir önceki cevaptaki gibi kalacak, sadece prompt güncellendi)
        const prompt = `...`; // Prompt Cloud function'a taşındı.

        try {
            const geminiProxy = functions.httpsCallable('geminiProxy');
            const result = await geminiProxy({ prompt: dataSummary }); // Sadece veri gönderiliyor

            if (result.data && result.data.analysis) {
                // Gelen HTML'den ```html ve ``` kısımlarını temizle
                const cleanedHtml = result.data.analysis.replace(/^```html\n?|```$/g, '');
                analysisContent.innerHTML = cleanedHtml;
            } else {
                throw new Error("Yapay zekadan geçerli bir yanıt alınamadı.");
            }
        } catch (error) {
            // ... hata yönetimi
        }
    }
    
    // Olay dinleyicileri
    document.querySelector('#crypto-content thead').addEventListener('click', (e) => {
        const header = e.target.closest('th.sortable');
        if (!header) return;

        const key = header.dataset.sortKey;
        
        if (currentSort.key !== key) {
            currentSort.key = key;
            currentSort.order = 'asc';
        } else {
            if (currentSort.order === 'asc') {
                currentSort.order = 'desc';
            } else if (currentSort.order === 'desc') {
                currentSort.key = null;
                currentSort.order = 'default';
            }
        }
        sortAndRenderTable();
    });
    
    trackerPage.addEventListener('click', (e) => {
        const assetActionTarget = e.target.closest('.clickable-pct');
        if (assetActionTarget) {
            const { pair, col } = assetActionTarget.dataset;
            if (!pair) return;
            const assetData = allCryptoData.find(c => c.pair === pair);

            if (assetData && !assetData.error) {
                const colData = assetData[`col${col}`];
                if (colData && colData.lowestPrice) {
                    document.getElementById('lowestPriceTitle').textContent = translations[settings.lang].lowest_price_title(assetData.pair.replace('USDT',''), settings.columns[col].name);
                    document.getElementById('lowestPriceDetails').innerHTML = translations[settings.lang].lowest_price_detail(formatPrice(colData.lowestPrice), colData.lowestDate);
                    showPanel('lowestPricePanel');
                }
            }
        }
        // ... diğer click eventleri
    });


</script>

</body>
</html>
